<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>主題清單</title>
    <!-- Ionic CDN -->
    <script
      type="module"
      src="https://cdn.jsdelivr.net/npm/@ionic/core/dist/ionic/ionic.esm.js"
    ></script>
    <script
      nomodule
      src="https://cdn.jsdelivr.net/npm/@ionic/core/dist/ionic/ionic.js"
    ></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@ionic/core/css/ionic.bundle.css"
    />
    <style>
      /* 運動風格的全局設置 */
      :root {
        --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        --card-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        --hover-shadow: 0 12px 48px rgba(0, 0, 0, 0.15);
        --border-radius: 16px;
        --text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      /* 背景設置 */
      ion-app {
        background: linear-gradient(135deg, #e3f2fd 0%, #f8bbd9 50%, #e1f5fe 100%);
        min-height: 100vh;
      }

      /* 標題欄運動風格 */
      ion-header {
        background: var(--primary-gradient);
        box-shadow: var(--card-shadow);
      }

      ion-toolbar {
        --background: transparent;
        --color: white;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      ion-title {
        font-weight: bold;
        font-size: 1.4em;
        text-shadow: var(--text-shadow);
        letter-spacing: 0.5px;
        text-align: center;
        width: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      /* 搜索欄運動風格 */
      ion-searchbar {
        --background: rgba(255, 255, 255, 0.95);
        --border-radius: 25px;
        --box-shadow: var(--card-shadow);
        margin: 8px 16px;
        backdrop-filter: blur(10px);
        overflow: hidden;
      }

      /* 分類選擇器 */
      ion-item {
        --background: rgba(255, 255, 255, 0.9);
        --border-radius: 20px;
        margin: 0 16px 8px 16px;
        border-radius: 20px;
        box-shadow: var(--card-shadow);
        overflow: hidden;
      }

      /* 內容區域 */
      ion-content {
        --background: transparent;
        --padding-start: 16px;
        --padding-end: 16px;
        --padding-top: 16px;
      }

      /* 列表項目運動卡片風格 */
      .list-item {
        --background: linear-gradient(145deg, #ffffff 0%, #f8f9ff 100%);
        --border-radius: var(--border-radius);
        --box-shadow: var(--card-shadow);
        margin-bottom: 20px;
        border-radius: var(--border-radius);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        overflow: hidden;
        position: relative;
      }

      .list-item::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--primary-gradient);
        border-radius: var(--border-radius) var(--border-radius) 0 0;
      }

      .list-item:hover {
        transform: translateY(-4px);
        box-shadow: var(--hover-shadow);
      }

      /* 內容容器 */
      .item-content {
        width: 100%;
        padding: 20px;
        background: transparent;
      }

      /* 姿勢名稱 - 運動標題風格 */
      .item-pose {
        font-weight: 800;
        font-size: 1.3em;
        margin: 0 0 12px 0;
        background: var(--primary-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        letter-spacing: 0.5px;
      }

      /* 級別 - 運動徽章風格 */
      .item-level {
        display: inline-block;
        background: var(--secondary-gradient);
        color: white;
        padding: 6px 16px;
        border-radius: 20px;
        font-size: 0.85em;
        font-weight: 600;
        margin-bottom: 12px;
        text-shadow: var(--text-shadow);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      /* 類型 */
      .item-type {
        color: #666;
        font-size: 0.9em;
        font-weight: 600;
        margin-bottom: 8px;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      /* 好處說明 */
      .item-benefits {
        background: rgba(76, 175, 80, 0.1);
        padding: 12px;
        border-radius: 12px;
        border-left: 4px solid #4CAF50;
        margin: 12px 0;
        font-size: 0.95em;
        line-height: 1.5;
      }

      /* 要點說明 */
      .item-keys {
        background: rgba(33, 150, 243, 0.1);
        padding: 12px;
        border-radius: 12px;
        border-left: 4px solid #2196F3;
        margin: 12px 0;
        font-size: 0.95em;
        line-height: 1.5;
      }

      /* 注意事項 */
      .item-cautions {
        background: rgba(255, 152, 0, 0.1);
        padding: 12px;
        border-radius: 12px;
        border-left: 4px solid #FF9800;
        margin: 12px 0;
        font-size: 0.95em;
        line-height: 1.5;
      }

      /* 媒體容器運動風格 */
      .media-container {
        display: flex;
        flex-direction: column;
        gap: 16px;
        margin: 16px 0;
      }

      @media (min-width: 769px) {
        .media-container {
          flex-direction: row;
          justify-content: center;
          align-items: flex-start;
        }
      }

      /* 圖片容器運動風格 */
      .item-image-container {
        text-align: center;
        min-width: 300px;
        display: flex;
        align-items: flex-start;
        justify-content: center;
      }

      .item-image {
        width: 100%;
        max-width: 550px;
        min-width: 300px;
        height: 310px;
        object-fit: cover;
        border-radius: var(--border-radius);
        box-shadow: var(--card-shadow);
        transition: all 0.3s ease;
        border: 3px solid transparent;
        background: var(--success-gradient);
        background-clip: padding-box;
      }

      .item-image:hover {
        transform: scale(1.02);
        box-shadow: var(--hover-shadow);
      }

      /* 影片容器運動風格 */
      .item-video-container {
        text-align: center;
        min-width: 300px;
        display: flex;
        align-items: flex-start;
        justify-content: center;
      }

      .item-video {
        width: 550px;
        min-width: 300px;
        height: 310px;
        border-radius: var(--border-radius);
        box-shadow: var(--card-shadow);
        transition: all 0.3s ease;
        border: 3px solid transparent;
        background: var(--primary-gradient);
        background-clip: padding-box;
      }

      .item-video:hover {
        transform: scale(1.02);
        box-shadow: var(--hover-shadow);
      }

      /* 標籤容器運動風格 */
      .tag-container {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 16px;
        padding-top: 16px;
        border-top: 1px solid rgba(0, 0, 0, 0.1);
      }

      /* 運動風格標籤 */
      .item-tag-1, .item-tag-2, .item-tag-3 {
        --background: var(--primary-gradient);
        --color: white;
        font-weight: 600;
        font-size: 0.8em;
        padding: 8px 16px;
        border-radius: 20px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        cursor: pointer;
        text-shadow: var(--text-shadow);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        position: relative;
        overflow: hidden;
      }

      .item-tag-1::before, .item-tag-2::before, .item-tag-3::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
        transition: left 0.5s;
      }

      .item-tag-1:hover, .item-tag-2:hover, .item-tag-3:hover {
        transform: translateY(-2px) scale(1.05);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
      }

      .item-tag-1:hover::before, .item-tag-2:hover::before, .item-tag-3:hover::before {
        left: 100%;
      }

      .item-tag-2 {
        --background: var(--secondary-gradient);
      }

      .item-tag-3 {
        --background: var(--success-gradient);
      }

      /* 響應式設計 - 桌面大螢幕 */
      @media (min-width: 1201px) {
        .media-container {
          justify-content: center;
          gap: 20px;
          align-items: flex-start;
        }
        
        .item-image-container {
          flex: 0 0 550px;
        }
        
        .item-video-container {
          flex: 0 0 550px;
        }
        
        .item-image {
          width: 550px;
          height: 310px;
        }
        
        .item-video {
          width: 550px;
          height: 310px;
        }
      }

      /* 響應式設計 - 中等螢幕 (平板) */
      @media (max-width: 1200px) and (min-width: 769px) {
        .media-container {
          justify-content: center;
          gap: 16px;
          align-items: flex-start;
        }
        
        .item-image-container {
          flex: 0 0 400px;
        }
        
        .item-video-container {
          flex: 0 0 400px;
        }
        
        .item-image {
          width: 400px;
          height: 225px;
          min-width: auto;
        }
        
        .item-video {
          width: 400px;
          height: 225px;
          min-width: auto;
        }
      }

      /* 響應式設計 - 大型手機 (Galaxy Note, iPhone 12 Pro Max: 412-428px) */
      @media (max-width: 768px) and (min-width: 415px) {
        .media-container {
          flex-direction: column;
          gap: 12px;
          align-items: center;
        }
        
        .item-content {
          padding: 16px;
        }
        
        .item-pose {
          font-size: 1.2em;
        }
        
        .item-image-container, .item-video-container {
          min-width: auto;
          width: 100%;
          max-width: 380px;
        }
        
        .item-image {
          width: 100%;
          max-width: 380px;
          height: 214px;
          min-width: auto;
        }
        
        .item-video {
          width: 100%;
          max-width: 380px;
          height: 214px;
          min-width: auto;
        }
      }

      /* 響應式設計 - 中型手機 (iPhone 6/7/8, Galaxy S5: 360-375px) */
      @media (max-width: 414px) and (min-width: 361px) {
        .media-container {
          flex-direction: column;
          gap: 10px;
          align-items: center;
        }
        
        .item-content {
          padding: 14px;
        }
        
        .item-pose {
          font-size: 1.1em;
        }
        
        .item-image-container, .item-video-container {
          min-width: auto;
          width: 100%;
          max-width: 340px;
        }
        
        .item-image {
          width: 100%;
          max-width: 340px;
          height: 191px;
          min-width: auto;
        }
        
        .item-video {
          width: 100%;
          max-width: 340px;
          height: 191px;
          min-width: auto;
        }
      }

      /* 響應式設計 - 小型手機 (iPhone 5: 320px) */
      @media (max-width: 360px) {
        .media-container {
          flex-direction: column;
          gap: 8px;
          align-items: center;
        }
        
        .item-content {
          padding: 12px;
        }
        
        .item-pose {
          font-size: 1em;
        }
        
        .item-image-container, .item-video-container {
          min-width: auto;
          width: 100%;
          max-width: 300px;
        }
        
        .item-image {
          width: 100%;
          max-width: 300px;
          height: 169px;
          min-width: auto;
        }
        
        .item-video {
          width: 100%;
          max-width: 300px;
          height: 169px;
          min-width: auto;
        }
      }

      /* 動畫效果 */
      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .list-item {
        animation: fadeInUp 0.6s ease forwards;
      }

      /* 滾動條美化 */
      ion-content::-webkit-scrollbar {
        width: 8px;
      }

      ion-content::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.1);
        border-radius: 4px;
      }

      ion-content::-webkit-scrollbar-thumb {
        background: var(--primary-gradient);
        border-radius: 4px;
      }

      ion-content::-webkit-scrollbar-thumb:hover {
        background: var(--secondary-gradient);
      }

      /* Assignment 2.2 認證按鈕樣式 */
      #auth-btn {
        --color: white;
        --background: rgba(255, 255, 255, 0.2);
        --border-radius: 20px;
        margin: 0 8px;
      }

      /* Assignment 2.2 收藏按鈕樣式 */
      .bookmark-btn {
        position: absolute;
        top: 12px;
        right: 12px;
        --background: rgba(255, 255, 255, 0.9);
        --color: #666;
        --border-radius: 50%;
        width: 40px;
        height: 40px;
        backdrop-filter: blur(10px);
        transition: all 0.3s ease;
        z-index: 10;
      }

      .bookmark-btn.bookmarked {
        --background: var(--secondary-gradient);
        --color: white;
      }

      .bookmark-btn:hover {
        transform: scale(1.1);
      }

      /* Assignment 2.2 分頁控制樣式 */
      #pagination-controls ion-button {
        --background: var(--primary-gradient);
        --color: white;
        --border-radius: 20px;
        min-width: 100px;
      }

      #pagination-info {
        background: rgba(255, 255, 255, 0.9);
        border-radius: 15px;
        margin: 8px 16px;
        box-shadow: var(--card-shadow);
      }

      /* 認證模態框輸入框樣式 */
      #auth-modal ion-item {
        --background: rgba(255, 255, 255, 0.95);
        --border-radius: 12px;
        margin-bottom: 16px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      #auth-modal ion-input {
        --placeholder-color: #999;
        --color: #333;
        --padding-start: 16px;
        --padding-end: 16px;
        font-size: 16px;
      }

      #auth-modal ion-input:focus-within {
        --placeholder-color: #666;
      }
    </style>
  </head>
  <body>
    <ion-app>
      <ion-header>
        <ion-toolbar>
          <ion-title>瑜伽動作清單</ion-title>
          <!-- Assignment 2.2 認證按鈕 -->
          <ion-button id="auth-btn" fill="clear" slot="end">
            <ion-icon name="person-outline"></ion-icon>
            登入
          </ion-button>
        </ion-toolbar>
        <ion-searchbar placeholder="搜尋..."></ion-searchbar>
        <ion-item>
          <ion-select label="分類" interface="popover">
            <ion-select-option value="">全部</ion-select-option>
            <!-- 根據主題加入分類選項 -->
          </ion-select>
        </ion-item>
        <!-- Assignment 2.2 分頁控制 -->
        <ion-item>
          <ion-label>每頁顯示:</ion-label>
          <ion-select id="limit-select" value="10" slot="end">
            <ion-select-option value="5">5</ion-select-option>
            <ion-select-option value="10">10</ion-select-option>
            <ion-select-option value="20">20</ion-select-option>
          </ion-select>
        </ion-item>
      </ion-header>

      <ion-content>
        <!-- Assignment 2.2 分頁顯示 -->
        <div id="pagination-info" style="text-align: center; padding: 8px; color: #666; font-size: 0.9em;">
          頁面 1 / 1，共 0 項
        </div>
      
        <ion-list>
          <!-- 清單項目範本 -->
          <ion-item class="list-item">
            <div class="item-content">
              <!-- Assignment 2.2 收藏按鈕 -->
              <ion-button class="bookmark-btn" fill="clear" size="small">
                <ion-icon name="heart-outline"></ion-icon>
              </ion-button>
              <div class="item-pose">Pose</div>
              <div class="item-level">Level</div>
              <div class="item-benefits">Benefits</div>
              <div class="item-keys">Keys</div>
              <div class="item-cautions">Cautions</div>
              <div class="media-container">
                <div class="item-image-container">
                  <img class="item-image" src="" alt="Yoga Pose" style="width: 100%; max-width: 300px; height: auto; border-radius: 8px; margin-top: 10px;">
                </div>
                <div class="item-video-container">
                  <iframe class="item-video" src="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                </div>
              </div>
              <div class="tag-container">
                <ion-chip size="small" class="item-tag-1">標籤1</ion-chip>
                <ion-chip size="small" class="item-tag-2">標籤2</ion-chip>
                <ion-chip size="small" class="item-tag-3">標籤3</ion-chip>
                <!-- 標籤 -->
              </div>
            </div>
          </ion-item>
        </ion-list>
        
        <!-- Assignment 2.2 分頁控制 -->
        <div id="pagination-controls" style="display: flex; justify-content: center; gap: 8px; padding: 16px;">
          <ion-button id="prev-btn" fill="outline" disabled>
            <ion-icon name="chevron-back-outline" slot="start"></ion-icon>
            上一頁
          </ion-button>
          <ion-button id="next-btn" fill="outline">
            下一頁
            <ion-icon name="chevron-forward-outline" slot="end"></ion-icon>
          </ion-button>
        </div>
      </ion-content>
    </ion-app>

    <!-- Assignment 2.2 認證模態框 -->
    <ion-modal id="auth-modal">
      <ion-header>
        <ion-toolbar>
          <ion-title id="auth-modal-title">登入</ion-title>
          <ion-button slot="end" fill="clear" onclick="closeAuthModal()">
            <ion-icon name="close"></ion-icon>
          </ion-button>
        </ion-toolbar>
      </ion-header>
      <ion-content style="padding: 20px;">
        <form id="auth-form">
          <ion-item>
            <ion-input 
              id="username" 
              type="text" 
              placeholder="用戶名稱" 
              required
              clear-input="true"
            ></ion-input>
          </ion-item>
          <ion-item>
            <ion-input 
              id="password" 
              type="password" 
              placeholder="密碼" 
              required
              clear-input="true"
            ></ion-input>
          </ion-item>
          <ion-button type="submit" expand="block" style="margin-top: 20px;">
            <span id="auth-submit-text">登入</span>
          </ion-button>
          <ion-button 
            type="button" 
            fill="clear" 
            expand="block" 
            onclick="switchAuthMode()"
            style="margin-top: 10px;"
          >
            <span id="auth-switch-text">還沒有帳號？註冊</span>
          </ion-button>
        </form>
      </ion-content>
    </ion-modal>

    <script type="module">
      // Assignment 2.1 + Assignment 2.2 整合功能
      import { items } from './post.js';

      // Assignment 2.2 變數
      let currentUser = null;
      let currentPage = 1;
      let itemsPerPage = 10;
      let allItems = [];
      let filteredItems = [];
      let bookmarks = [];
      let isLoginMode = true;

      // DOM 元素
      const searchbar = document.querySelector('ion-searchbar');
      const list = document.querySelector('ion-list');
      const template = document.querySelector('.list-item');
      const categorySelect = document.querySelector('ion-select');
      const limitSelect = document.getElementById('limit-select');
      const paginationInfo = document.getElementById('pagination-info');
      const prevBtn = document.getElementById('prev-btn');
      const nextBtn = document.getElementById('next-btn');
      const authBtn = document.getElementById('auth-btn');
      const authModal = document.getElementById('auth-modal');

      // 初始化應用
      async function initializeApp() {
        // 檢查登入狀態
        await checkAuthStatus();
        
        // 設置事件監聽器
        setupEventListeners();
        
        // 初始化數據
        await initializeData();
      }

      // Assignment 2.2 認證功能
      async function checkAuthStatus() {
        const token = localStorage.getItem('auth_token');
        const username = localStorage.getItem('username');
        
        if (token && username) {
          currentUser = { username, token };
          authBtn.innerHTML = `<ion-icon name="person"></ion-icon> ${username}`;
          await loadBookmarks();
        }
      }

      async function loadBookmarks() {
        try {
          // 嘗試從 API 加載收藏，失敗則使用本地存儲
          const localBookmarks = localStorage.getItem('local_bookmarks');
          bookmarks = localBookmarks ? JSON.parse(localBookmarks) : [];
        } catch (error) {
          console.log('使用本地收藏數據');
          bookmarks = [];
        }
      }

      // 設置事件監聽器
      function setupEventListeners() {
        // Assignment 2.1 搜索和分類功能
        searchbar.addEventListener('ionInput', handleSearch);
        categorySelect.addEventListener('ionChange', handleCategoryChange);
        
        // Assignment 2.2 分頁功能
        limitSelect.addEventListener('ionChange', handleLimitChange);
        prevBtn.addEventListener('click', goToPrevPage);
        nextBtn.addEventListener('click', goToNextPage);
        
        // Assignment 2.2 認證功能
        authBtn.addEventListener('click', openAuthModal);
        document.getElementById('auth-form').addEventListener('submit', handleAuth);
      }

      // Assignment 2.1 搜索功能
      function handleSearch(event) {
        currentPage = 1;
        filterAndDisplayItems();
      }

      // Assignment 2.1 分類功能
      function handleCategoryChange(event) {
        currentPage = 1;
        filterAndDisplayItems();
      }

      // Assignment 2.2 分頁功能
      function handleLimitChange(event) {
        itemsPerPage = parseInt(event.detail.value);
        currentPage = 1;
        filterAndDisplayItems();
      }

      function goToPrevPage() {
        if (currentPage > 1) {
          currentPage--;
          filterAndDisplayItems();
        }
      }

      function goToNextPage() {
        const totalPages = Math.ceil(filteredItems.length / itemsPerPage);
        if (currentPage < totalPages) {
          currentPage++;
          filterAndDisplayItems();
        }
      }

      // 初始化數據
      async function initializeData() {
        try {
          // 首先嘗試使用本地數據
          allItems = items.map((item, index) => ({
            id: index + 1,
            title: item.pose.replace('Pose : ', ''),
            description: item.benefits,
            level: item.level.replace('Level : ', ''),
            benefits: item.benefits.replace('Benefits : ', ''),
            keys: item.keys.replace('Keys : ', ''),
            cautions: item.cautions.replace('Cautions : ', ''),
            category: item.category,
            tags: item.tags || [],
            imageUrl: item.imageUrl,
            videoUrl: item.videoUrl,
            // 保持原始格式用於顯示
            pose: item.pose,
            originalLevel: item.level,
            originalBenefits: item.benefits,
            originalKeys: item.keys,
            originalCautions: item.cautions
          }));
          
          console.log('使用本地數據，共', allItems.length, '項');
        } catch (error) {
          console.error('數據加載失敗:', error);
          allItems = [];
        }

        // 初始化分類選項
        initializeCategoryOptions();
        
        // 顯示項目
        filterAndDisplayItems();
      }

      // Assignment 2.1 分類選項初始化
      function initializeCategoryOptions() {
        const categories = [...new Set(allItems.map(item => item.category))];
        
        const allOption = categorySelect.querySelector('ion-select-option[value=""]');
        categorySelect.innerHTML = '';
        categorySelect.appendChild(allOption);
        
        categories.forEach(category => {
          const option = document.createElement('ion-select-option');
          option.value = category;
          option.textContent = category;
          categorySelect.appendChild(option);
        });
      }

      // Assignment 2.1 + Assignment 2.2 過濾和顯示功能
      function filterAndDisplayItems() {
        const searchTerm = searchbar.value ? searchbar.value.toLowerCase() : '';
        const selectedCategory = categorySelect.value;

        // Assignment 2.1 過濾邏輯
        filteredItems = allItems.filter(item => {
          const searchMatch = !searchTerm || 
            item.pose.toLowerCase().includes(searchTerm) ||
            item.level.toLowerCase().includes(searchTerm) ||
            item.benefits.toLowerCase().includes(searchTerm) ||
            item.keys.toLowerCase().includes(searchTerm) ||
            item.category.toLowerCase().includes(searchTerm) ||
            (item.tags && item.tags.some(tag => tag.toLowerCase().includes(searchTerm)));
          
          const categoryMatch = !selectedCategory || item.category === selectedCategory;
          
          return searchMatch && categoryMatch;
        });

        displayCurrentPage();
      }

      // Assignment 2.2 分頁顯示
      function displayCurrentPage() {
        const totalPages = Math.ceil(filteredItems.length / itemsPerPage);
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const currentItems = filteredItems.slice(startIndex, endIndex);

        // 更新分頁信息
        paginationInfo.textContent = `頁面 ${currentPage} / ${totalPages || 1}，共 ${filteredItems.length} 項`;
        
        // 更新分頁按鈕狀態
        prevBtn.disabled = currentPage <= 1;
        nextBtn.disabled = currentPage >= totalPages;

        // 清空列表
        const templateClone = template.cloneNode(true);
        list.innerHTML = '';

        // Assignment 2.1 顯示邏輯 + Assignment 2.2 收藏功能
        currentItems.forEach(item => {
          const node = templateClone.cloneNode(true);
          
          // Assignment 2.1 原始顯示邏輯
          node.querySelector('.item-pose').textContent = item.pose;
          node.querySelector('.item-level').textContent = item.originalLevel;
          node.querySelector('.item-benefits').textContent = item.originalBenefits;
          node.querySelector('.item-keys').textContent = item.originalKeys;
          node.querySelector('.item-cautions').textContent = item.originalCautions;
          
          // 圖片設置
          const imageElement = node.querySelector('.item-image');
          if (item.imageUrl) {
            imageElement.src = item.imageUrl;
            imageElement.alt = item.pose;
            imageElement.style.display = 'block';
          } else {
            imageElement.style.display = 'none';
          }
          
          // 影片設置
          const videoElement = node.querySelector('.item-video');
          const videoContainer = node.querySelector('.item-video-container');
          if (item.videoUrl && item.videoUrl.includes('youtube.com/watch?v=')) {
            const videoId = item.videoUrl.split('v=')[1].split('&')[0];
            const embedUrl = `https://www.youtube.com/embed/${videoId}`;
            videoElement.src = embedUrl;
            videoContainer.style.display = 'block';
          } else if (item.videoUrl && item.videoUrl !== 'videos/.mp4') {
            videoElement.src = item.videoUrl;
            videoContainer.style.display = 'block';
          } else {
            videoContainer.style.display = 'none';
          }
          
          // Assignment 2.1 標籤功能
          setupTags(node, item);
          
          // Assignment 2.2 收藏功能
          setupBookmark(node, item);
          
          list.appendChild(node);
        });
      }

      // Assignment 2.1 標籤設置
      function setupTags(node, item) {
        if (item.tags && item.tags.length > 0) {
          ['item-tag-1', 'item-tag-2', 'item-tag-3'].forEach((className, index) => {
            const tagElement = node.querySelector(`.${className}`);
            if (item.tags[index]) {
              tagElement.textContent = item.tags[index];
              tagElement.style.display = 'inline-block';
              tagElement.style.cursor = 'pointer';
              tagElement.addEventListener('click', () => {
                searchbar.value = item.tags[index];
                handleSearch({ detail: { value: item.tags[index] } });
              });
            } else {
              tagElement.style.display = 'none';
            }
          });
        } else {
          node.querySelectorAll('.item-tag-1, .item-tag-2, .item-tag-3')
            .forEach(tag => tag.style.display = 'none');
        }
      }

      // Assignment 2.2 收藏設置
      function setupBookmark(node, item) {
        const bookmarkBtn = node.querySelector('.bookmark-btn');
        const isBookmarked = bookmarks.includes(item.id);
        
        // 設置收藏狀態
        if (isBookmarked) {
          bookmarkBtn.classList.add('bookmarked');
          bookmarkBtn.querySelector('ion-icon').name = 'heart';
        } else {
          bookmarkBtn.classList.remove('bookmarked');
          bookmarkBtn.querySelector('ion-icon').name = 'heart-outline';
        }
        
        // 收藏點擊事件
        bookmarkBtn.addEventListener('click', async () => {
          if (!currentUser) {
            alert('請先登入才能使用收藏功能');
            return;
          }
          
          try {
            if (isBookmarked) {
              await removeBookmark(item.id);
            } else {
              await addBookmark(item.id);
            }
            filterAndDisplayItems(); // 重新渲染
          } catch (error) {
            console.error('收藏操作失敗:', error);
          }
        });
      }

      // Assignment 2.2 收藏功能
      async function addBookmark(itemId) {
        if (!bookmarks.includes(itemId)) {
          bookmarks.push(itemId);
          localStorage.setItem('local_bookmarks', JSON.stringify(bookmarks));
        }
      }

      async function removeBookmark(itemId) {
        const index = bookmarks.indexOf(itemId);
        if (index > -1) {
          bookmarks.splice(index, 1);
          localStorage.setItem('local_bookmarks', JSON.stringify(bookmarks));
        }
      }

      // Assignment 2.2 認證功能
      function openAuthModal() {
        if (currentUser) {
          // 已登入，顯示登出選項
          if (confirm(`${currentUser.username}，確定要登出嗎？`)) {
            logout();
          }
        } else {
          // 未登入，顯示登入模態框
          authModal.present();
        }
      }

      function closeAuthModal() {
        authModal.dismiss();
      }

      window.closeAuthModal = closeAuthModal;

      function switchAuthMode() {
        isLoginMode = !isLoginMode;
        const title = document.getElementById('auth-modal-title');
        const submitText = document.getElementById('auth-submit-text');
        const switchText = document.getElementById('auth-switch-text');
        
        if (isLoginMode) {
          title.textContent = '登入';
          submitText.textContent = '登入';
          switchText.textContent = '還沒有帳號？註冊';
        } else {
          title.textContent = '註冊';
          submitText.textContent = '註冊';
          switchText.textContent = '已有帳號？登入';
        }
      }

      window.switchAuthMode = switchAuthMode;

      async function handleAuth(event) {
        event.preventDefault();
        
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        
        try {
          // 本地模擬認證
          const mockToken = 'mock_token_' + Date.now();
          
          currentUser = { username, token: mockToken };
          localStorage.setItem('auth_token', mockToken);
          localStorage.setItem('username', username);
          
          authBtn.innerHTML = `<ion-icon name="person"></ion-icon> ${username}`;
          
          await loadBookmarks();
          closeAuthModal();
          
          alert(isLoginMode ? '登入成功！' : '註冊成功！');
          
          // 重新顯示項目以更新收藏狀態
          filterAndDisplayItems();
          
        } catch (error) {
          alert('認證失敗：' + error.message);
        }
      }

      function logout() {
        currentUser = null;
        bookmarks = [];
        localStorage.removeItem('auth_token');
        localStorage.removeItem('username');
        localStorage.removeItem('local_bookmarks');
        
        authBtn.innerHTML = '<ion-icon name="person-outline"></ion-icon> 登入';
        
        // 重新顯示項目以移除收藏狀態
        filterAndDisplayItems();
        
        alert('已登出');
      }

      // 初始化應用
      initializeApp();
    </script>
  </body>
</html>