<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ç‘œä¼½å‹•ä½œæ‡‰ç”¨ - Assignment 2.2</title>
    <script
      type="module"
      src="https://cdn.jsdelivr.net/npm/@ionic/core/dist/ionic/ionic.esm.js"
    ></script>
    <script
      nomodule
      src="https://cdn.jsdelivr.net/npm/@ionic/core/dist/ionic/ionic.js"
    ></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@ionic/core/css/ionic.bundle.css"
    />
    
    <style>
      /* èˆ‡åŸç‰ˆç›¸åŒçš„æ¨£å¼ */
      .item-image {
        width: 100%;
        max-width: 300px;
        height: auto;
        border-radius: 8px;
        margin-bottom: 10px;
      }
      
      .video-thumbnail {
        position: relative;
        display: inline-block;
        cursor: pointer;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        transition: transform 0.2s ease;
      }
      
      .video-thumbnail:hover {
        transform: scale(1.02);
      }
      
      .poses-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        padding: 16px;
      }
      
      .pose-card {
        flex: 1 1 300px;
        min-width: 280px;
      }
      
      .filter-container {
        padding: 16px;
        background: #f8f9fa;
        border-bottom: 1px solid #e0e0e0;
      }
      
      .filter-row {
        display: flex;
        gap: 16px;
        align-items: center;
        flex-wrap: wrap;
      }
      
      .filter-item {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }
      
      .filter-item label {
        font-size: 14px;
        font-weight: 500;
        color: #666;
      }
      
      @media (max-width: 768px) {
        .filter-row {
          flex-direction: column;
          align-items: stretch;
        }
        
        .filter-item {
          width: 100%;
        }
      }
      
      /* èªè­‰è¡¨å–®æ¨£å¼ */
      .form-group {
        margin-bottom: 20px;
      }
      
      /* è‡ªå®šç¾©è¼¸å…¥æ¡†æ¨£å¼ - ä¿®å¾©é‡ç–Šå•é¡Œ */
      .custom-input-item {
        --padding-start: 16px;
        --inner-padding-end: 16px;
        --min-height: 60px;
        --background: transparent;
        --border-radius: 8px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        margin-bottom: 8px;
      }
      
      .custom-input-item:focus-within {
        border-color: var(--ion-color-primary);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }
      
      .custom-input-item ion-label {
        font-size: 12px;
        font-weight: 500;
        color: #6b7280;
        margin-bottom: 4px;
        position: static !important;
        transform: none !important;
      }
      
      .custom-input-item ion-input {
        --padding-top: 8px;
        --padding-bottom: 8px;
        --padding-start: 0px;
        font-size: 16px;
        line-height: 1.5;
      }
      
      .custom-input-item ion-input input {
        padding-left: 0 !important;
      }
      
      /* ä½”ä½ç¬¦æ¨£å¼ */
      .custom-input-item ion-input::part(native) {
        color: #374151;
      }
      
      .custom-input-item ion-input::part(native)::placeholder {
        color: #9ca3af;
        opacity: 1;
      }
      
      /* ç•¶è¼¸å…¥æ¡†ç²å¾—ç„¦é»æ™‚éš±è—ä½”ä½ç¬¦ */
      .custom-input-item:focus-within ion-input::part(native)::placeholder {
        opacity: 0.3;
      }
      
      .error-message {
        color: #dc3545;
        font-size: 12px;
        margin-top: 5px;
        margin-left: 16px;
        display: none;
      }
      
      .error-message.show {
        display: block;
      }
      
      .password-requirements {
        margin-top: 5px;
        margin-left: 16px;
        color: #6c757d;
      }
      
      .form-actions {
        margin: 24px 0;
      }
      
      .form-switch {
        text-align: center;
        margin-top: 16px;
      }
      
      .auth-error {
        margin: 16px 0;
        padding: 12px;
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        border-radius: 8px;
        color: #721c24;
      }
      
      .auth-error.show {
        display: block !important;
      }
      
      .loading-spinner {
        width: 16px;
        height: 16px;
        margin-right: 8px;
      }
      
      .password-strength {
        margin-top: 5px;
        margin-left: 16px;
      }
      
      .password-strength-bar {
        height: 4px;
        background: #e9ecef;
        border-radius: 2px;
        margin-top: 4px;
        overflow: hidden;
      }
      
      .password-strength-fill {
        height: 100%;
        transition: width 0.3s ease, background-color 0.3s ease;
      }
      
      .strength-weak { background-color: #dc3545; }
      .strength-medium { background-color: #ffc107; }
      .strength-strong { background-color: #28a745; }
      
      /* è¼¸å…¥æ¡†èšç„¦æ•ˆæœ */
      .form-group ion-item {
        --border-radius: 8px;
        --background: #f8f9fa;
        margin-bottom: 8px;
        transition: all 0.3s ease;
      }
      
      .form-group ion-item.item-has-focus {
        --background: #ffffff;
        --border-color: #007bff;
        box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
      }
      
      .form-group ion-input {
        --placeholder-color: #6c757d;
        --color: #212529;
      }
      
      /* æµ®å‹•æ¨™ç±¤å‹•ç•« */
      .form-group ion-label {
        transition: all 0.3s ease;
      }
    </style>
  </head>
  <body>
    <ion-app>
      <!-- Header -->
      <ion-header>
        <ion-toolbar>
          <ion-title>ç‘œä¼½å‹•ä½œæ‡‰ç”¨</ion-title>
          <ion-buttons slot="end">
            <ion-button id="auth-btn">ç™»å…¥</ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>

      <!-- Content -->
      <ion-content>
        <!-- æœç´¢å’Œç¯©é¸å€åŸŸ -->
        <div class="filter-container">
          <div class="filter-row">
            <div class="filter-item" style="flex: 2;">
              <label>æœç´¢ç‘œä¼½å‹•ä½œ</label>
              <ion-searchbar id="search-bar" placeholder="æœç´¢å‹•ä½œåç¨±ã€æè¿°æˆ–å¥½è™•..."></ion-searchbar>
            </div>
            
            <div class="filter-item">
              <label>åˆ†é¡ç¯©é¸</label>
              <ion-select id="category-select" placeholder="æ‰€æœ‰åˆ†é¡">
                <ion-select-option value="">æ‰€æœ‰åˆ†é¡</ion-select-option>
                <ion-select-option value="ç«™ç«‹å¼">ç«™ç«‹å¼</ion-select-option>
                <ion-select-option value="åå§¿å¼">åå§¿å¼</ion-select-option>
                <ion-select-option value="å¹³è¡¡å¼">å¹³è¡¡å¼</ion-select-option>
                <ion-select-option value="å¾Œå½å¼">å¾Œå½å¼</ion-select-option>
                <ion-select-option value="å‰å½å¼">å‰å½å¼</ion-select-option>
                <ion-select-option value="å€’ç«‹å¼">å€’ç«‹å¼</ion-select-option>
                <ion-select-option value="ä¼‘æ¯å¼">ä¼‘æ¯å¼</ion-select-option>
                <ion-select-option value="é–‹é«–å¼">é–‹é«–å¼</ion-select-option>
                <ion-select-option value="æ‰‹è‡‚å¹³è¡¡å¼">æ‰‹è‡‚å¹³è¡¡å¼</ion-select-option>
              </ion-select>
            </div>
            
            <!-- Step 22: æ’åºåŠŸèƒ½ -->
            <div class="filter-item">
              <label>æ’åºæ–¹å¼</label>
              <ion-select id="sort-select" placeholder="é è¨­æ’åº">
                <ion-select-option value="">é è¨­æ’åº</ion-select-option>
                <ion-select-option value="name">æŒ‰åç¨±æ’åº</ion-select-option>
                <ion-select-option value="difficulty">æŒ‰é›£åº¦æ’åº</ion-select-option>
                <ion-select-option value="duration_minutes">æŒ‰æ™‚é•·æ’åº</ion-select-option>
                <ion-select-option value="category">æŒ‰åˆ†é¡æ’åº</ion-select-option>
              </ion-select>
            </div>
            
            <div class="filter-item">
              <label>æ’åºé †åº</label>
              <ion-select id="order-select" value="asc">
                <ion-select-option value="asc">å‡åº (A-Z, 1-9)</ion-select-option>
                <ion-select-option value="desc">é™åº (Z-A, 9-1)</ion-select-option>
              </ion-select>
            </div>
            
            <!-- Step 23: åªé¡¯ç¤ºå·²æ”¶è—é …ç›®éæ¿¾ -->
            <div class="filter-item">
              <label>æ”¶è—éæ¿¾</label>
              <ion-button id="bookmark-filter-btn" fill="outline" color="primary">
                <ion-icon name="heart-outline"></ion-icon>
                é¡¯ç¤ºå…¨éƒ¨
              </ion-button>
            </div>
            
          </div>
        </div>

        <!-- è¼‰å…¥ç‹€æ…‹ -->
        <div id="loading-container" style="text-align: center; padding: 40px;">
          <ion-spinner name="crescent"></ion-spinner>
          <p id="loading-message">è¼‰å…¥ç‘œä¼½å‹•ä½œä¸­...</p>
        </div>
        
        <!-- éŒ¯èª¤ç‹€æ…‹ -->
        <div id="error-container" style="display: none; text-align: center; padding: 40px;">
          <p id="error-message">è¼‰å…¥å¤±æ•—</p>
          <ion-button id="retry-btn" onclick="loadData()">é‡è©¦</ion-button>
        </div>
        
        <!-- æ•¸æ“šé¡¯ç¤ºå€åŸŸ -->
        <div id="poses-list" style="display: none;">
          <!-- Page 1 ç‘œä¼½å‹•ä½œ -->
          <div id="page-1-section">
            <h3 style="text-align: center; margin: 20px 0; color: #3880ff;">ç¬¬ä¸€é ç‘œä¼½å‹•ä½œ (5é …)</h3>
            <div id="page-1-grid" class="poses-grid"></div>
          </div>
          
          <!-- Page 2 ç‘œä¼½å‹•ä½œ (åˆå§‹éš±è—) -->
          <div id="page-2-section" style="display: none;">
            <h3 style="text-align: center; margin: 20px 0; color: #28a745;">ç¬¬äºŒé ç‘œä¼½å‹•ä½œ (5é …)</h3>
            <div id="page-2-grid" class="poses-grid"></div>
          </div>
        </div>
        
        <!-- Step 7: Load More Button -->
        <div id="pagination-container" style="display: none; text-align: center; padding: 20px;">
          <p id="pagination-info">é¡¯ç¤º 5 é …ç‘œä¼½å‹•ä½œ</p>
          
          <!-- Load More Button -->
          <ion-button 
            id="load-more-btn" 
            expand="block" 
            fill="outline" 
            color="primary"
            onclick="loadMorePoses()"
            style="margin-top: 16px; max-width: 300px; margin-left: auto; margin-right: auto;">
            <ion-icon name="add-circle-outline" slot="start"></ion-icon>
            è¼‰å…¥æ›´å¤šç‘œä¼½å‹•ä½œ
          </ion-button>
          
          <!-- Loading indicator for Load More -->
          <div id="load-more-loading" style="display: none; padding: 20px; text-align: center;">
            <ion-spinner name="crescent" style="margin-right: 10px; --color: #3880ff;"></ion-spinner>
            <span style="color: #3880ff; font-size: 14px;">æ­£åœ¨è¼‰å…¥æ›´å¤šå‹•ä½œ...</span>
          </div>
          
          <!-- Load More Error -->
          <div id="load-more-error" style="display: none; color: #e53e3e; margin-top: 10px; text-align: center;">
            <ion-icon name="alert-circle-outline" style="margin-right: 5px;"></ion-icon>
            <span id="load-more-error-text">è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡è©¦</span>
            <br>
            <ion-button 
              fill="clear" 
              color="danger" 
              size="small" 
              onclick="retryLoadMore()" 
              style="margin-top: 8px;">
              <ion-icon name="refresh-outline" slot="start"></ion-icon>
              é‡è©¦
            </ion-button>
          </div>
          
          <!-- All loaded indicator -->
          <div id="no-more-data" style="display: none; color: #28a745; margin-top: 15px; text-align: center; padding: 10px;">
            <ion-icon name="checkmark-circle-outline" style="margin-right: 5px;"></ion-icon>
            <span>å·²è¼‰å…¥æ‰€æœ‰ç‘œä¼½å‹•ä½œ (å…± 10 é …)</span>
          </div>
        </div>
      </ion-content>

      <!-- ç™»å…¥/è¨»å†Šæ¨¡æ…‹æ¡† -->
      <ion-modal id="auth-modal">
        <ion-header>
          <ion-toolbar>
            <ion-title id="auth-title">ç™»å…¥</ion-title>
            <ion-buttons slot="end">
              <ion-button onclick="closeAuthModal()">
                <ion-icon name="close"></ion-icon>
              </ion-button>
            </ion-buttons>
          </ion-toolbar>
        </ion-header>
        
        <ion-content class="ion-padding">
          <!-- èªè­‰è¡¨å–®å®¹å™¨ -->
          <div id="auth-form-container">
            <!-- ç™»éŒ„è¡¨å–® -->
            <form id="login-form" style="display: block;">
              <div class="form-group">
                <ion-item lines="none" class="custom-input-item">
                  <ion-label position="stacked">ç”¨æˆ¶åæˆ–éƒµä»¶</ion-label>
                  <ion-input 
                    id="login-username" 
                    type="text" 
                    placeholder="è«‹è¼¸å…¥ç”¨æˆ¶åæˆ–éƒµä»¶"
                    required 
                    clearInput="true"
                    autocomplete="username">
                  </ion-input>
                </ion-item>
                <div id="login-username-error" class="error-message"></div>
              </div>
              
              <div class="form-group">
                <ion-item lines="none" class="custom-input-item">
                  <ion-label position="stacked">å¯†ç¢¼</ion-label>
                  <ion-input 
                    id="login-password" 
                    type="password" 
                    placeholder="è«‹è¼¸å…¥å¯†ç¢¼"
                    required 
                    clearInput="true"
                    autocomplete="current-password">
                  </ion-input>
                </ion-item>
                <div id="login-password-error" class="error-message"></div>
              </div>
              
              <div class="form-actions">
                <ion-button 
                  id="login-submit-btn" 
                  expand="block" 
                  type="submit"
                  color="primary">
                  <ion-icon name="log-in" slot="start"></ion-icon>
                  <span id="login-btn-text">ç™»éŒ„</span>
                </ion-button>
              </div>
              
              <div class="form-switch">
                <ion-button 
                  id="switch-to-register" 
                  fill="clear" 
                  expand="block">
                  é‚„æ²’æœ‰å¸³è™Ÿï¼Ÿé»æ“Šè¨»å†Š
                </ion-button>
              </div>
            </form>
            
            <!-- è¨»å†Šè¡¨å–® -->
            <form id="register-form" style="display: none;">
              <div class="form-group">
                <ion-item lines="none" class="custom-input-item">
                  <ion-label position="stacked">ç”¨æˆ¶å</ion-label>
                  <ion-input 
                    id="register-username" 
                    type="text" 
                    placeholder="è«‹è¼¸å…¥ç”¨æˆ¶åï¼ˆ3-20å€‹å­—ç¬¦ï¼‰"
                    required 
                    clearInput="true"
                    autocomplete="username">
                  </ion-input>
                </ion-item>
                <div id="register-username-error" class="error-message"></div>
              </div>
              
              <div class="form-group">
                <ion-item lines="none" class="custom-input-item">
                  <ion-label position="stacked">é›»å­éƒµä»¶</ion-label>
                  <ion-input 
                    id="register-email" 
                    type="email" 
                    placeholder="è«‹è¼¸å…¥é›»å­éƒµä»¶åœ°å€"
                    required 
                    clearInput="true"
                    autocomplete="email">
                  </ion-input>
                </ion-item>
                <div id="register-email-error" class="error-message"></div>
              </div>
              
              <div class="form-group">
                <ion-item lines="none" class="custom-input-item">
                  <ion-label position="stacked">å¯†ç¢¼</ion-label>
                  <ion-input 
                    id="register-password" 
                    type="password" 
                    placeholder="è«‹è¼¸å…¥å¯†ç¢¼ï¼ˆè‡³å°‘8å€‹å­—ç¬¦ï¼‰"
                    required 
                    clearInput="true"
                    autocomplete="new-password">
                  </ion-input>
                </ion-item>
                <div id="register-password-error" class="error-message"></div>
                
                <!-- Step 25: å¯†ç¢¼å¼·åº¦æŒ‡ç¤ºå™¨ -->
                <div id="password-strength-container" style="margin-top: 10px; display: none;">
                  <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                    <span style="font-size: 14px; font-weight: 500;">å¯†ç¢¼å¼·åº¦:</span>
                    <div id="password-strength-bar" style="flex: 1; height: 6px; background: #e0e0e0; border-radius: 3px; overflow: hidden;">
                      <div id="password-strength-fill" style="height: 100%; width: 0%; transition: width 0.3s, background-color 0.3s;"></div>
                    </div>
                    <span id="password-strength-text" style="font-size: 12px; font-weight: 500;">å¼±</span>
                  </div>
                  <div id="password-requirements-checklist" style="font-size: 12px; color: #666;">
                    <div id="req-length">âœ— è‡³å°‘8å€‹å­—ç¬¦</div>
                    <div id="req-lowercase">âœ— åŒ…å«å°å¯«å­—æ¯</div>
                    <div id="req-uppercase">âœ— åŒ…å«å¤§å¯«å­—æ¯</div>
                    <div id="req-numbers">âœ— åŒ…å«æ•¸å­—</div>
                    <div id="req-special">â—‹ åŒ…å«ç‰¹æ®Šå­—ç¬¦ (å¯é¸)</div>
                  </div>
                </div>
                
                <div class="password-requirements">
                  <small>è«‹è¼¸å…¥ç¬¦åˆå®‰å…¨è¦æ±‚çš„å¯†ç¢¼</small>
                </div>
              </div>
              
              <div class="form-group">
                <ion-item lines="none" class="custom-input-item">
                  <ion-label position="stacked">ç¢ºèªå¯†ç¢¼</ion-label>
                  <ion-input 
                    id="register-confirm-password" 
                    type="password" 
                    placeholder="è«‹å†æ¬¡è¼¸å…¥å¯†ç¢¼"
                    required 
                    clearInput="true"
                    autocomplete="new-password">
                  </ion-input>
                </ion-item>
                <div id="register-confirm-password-error" class="error-message"></div>
              </div>
              
              <div class="form-actions">
                <ion-button 
                  id="register-submit-btn" 
                  expand="block" 
                  type="submit"
                  color="success">
                  <ion-icon name="person-add" slot="start"></ion-icon>
                  <span id="register-btn-text">è¨»å†Š</span>
                </ion-button>
              </div>
              
              <div class="form-switch">
                <ion-button 
                  id="switch-to-login" 
                  fill="clear" 
                  expand="block">
                  å·²æœ‰å¸³è™Ÿï¼Ÿé»æ“Šç™»éŒ„
                </ion-button>
              </div>
            </form>
            
            <!-- API éŒ¯èª¤ä¿¡æ¯é¡¯ç¤º -->
            <div id="auth-error" class="auth-error" style="display: none;"></div>
          </div>
        </ion-content>
      </ion-modal>

      <!-- ç™»å‡ºç¢ºèªæ¨¡æ…‹æ¡† -->
      <ion-modal id="logout-confirm-modal">
        <ion-header>
          <ion-toolbar>
            <ion-title>ç¢ºèªç™»å‡º</ion-title>
          </ion-toolbar>
        </ion-header>
        
        <ion-content>
          <div style="padding: 20px; text-align: center;">
            <p>æ‚¨ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ</p>
            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
              <ion-button fill="outline" onclick="closeLogoutModal()">å–æ¶ˆ</ion-button>
              <ion-button onclick="confirmLogout()">ç¢ºèªç™»å‡º</ion-button>
            </div>
          </div>
        </ion-content>
      </ion-modal>
    </ion-app>

    <script>
      // é…ç½®å¸¸æ•¸ - Step 27: ç¨‹å¼ç¢¼å„ªåŒ–
      const CONFIG = {
        API_BASE_URL: 'https://dae-mobile-assignment.hkit.cc/api',
        MAX_RETRIES: 15,
        SESSION_TIMEOUT: 24 * 60 * 60 * 1000, // 24å°æ™‚
        SEARCH_DELAY: 500, // æœç´¢å»¶é²æ¯«ç§’
        INFINITE_SCROLL_THRESHOLD: 300, // è·é›¢åº•éƒ¨è§¸ç™¼è¼‰å…¥çš„åƒç´  (æ›´å®¹æ˜“è§¸ç™¼)
        ITEMS_PER_PAGE_OPTIONS: [5, 10, 20, 50],
        ERROR_DISPLAY_TIMEOUT: 5000, // éŒ¯èª¤ä¿¡æ¯é¡¯ç¤ºæ™‚é–“
        // æ™‚é–“å»¶é²é…ç½®
        RETRY_DELAY: 500,
        BASE_RETRY_DELAY: 1000,
        LOGOUT_DELAY: 1000,
        BUTTON_FEEDBACK_DELAY: 1500,
        TOAST_DISPLAY_DELAY: 3500,
        AUTO_LOGOUT_INTERVAL: 5 * 60 * 1000,
        // LocalStorage éµå€¼
        AUTH_TOKEN_KEY: 'authToken',
        USER_DATA_KEY: 'userData', 
        BOOKMARKS_KEY: 'yoga_app_bookmarks',
        AUTH_STORAGE_KEY: 'yoga_app_auth',
        USER_STORAGE_KEY: 'yoga_app_user'
      };
      
      // å…¨å±€è®Šé‡
      let allItems = [];
      let filteredItems = [];
      let currentUser = null;
      let currentPage = 1;
      let itemsPerPage = 5; // æ­¥é©Ÿ7: æ¯é é¡¯ç¤º5å€‹ï¼Œç¢ºä¿æœ‰æ›´å¤šæ•¸æ“šè¼‰å…¥
      let isLoginMode = true;
      let bookmarks = [];
      let hasMoreData = true;
      
      // æœç´¢ã€ç¯©é¸å’Œæ’åºç‹€æ…‹
      let currentSearchParams = {
        search: '',
        category: 'all',
        sort: '',
        order: 'asc',
        showBookmarkedOnly: false
      };
      
      // Step 7: Load More Button ç‹€æ…‹
      let isLoadingMore = false;
      let showingAllData = false; // æ˜¯å¦å·²ç¶“é¡¯ç¤ºæ‰€æœ‰æ•¸æ“š
      
      // èªè­‰å’Œæœƒè©±ç®¡ç†
      
      // éŒ¯èª¤è™•ç†çµ±è¨ˆ
      let errorStats = {
        totalErrors: 0,
        networkErrors: 0,
        serverErrors: 0,
        timeoutErrors: 0,
        lastErrorTime: null,
        consecutiveErrors: 0,
        maxConsecutiveErrors: 5
      };
      
      // API å‡½æ•¸ - å¸¶é‡è©¦æ©Ÿåˆ¶ (æ”¯æŒæœç´¢ã€åˆ†é¡ã€æ’åºåƒæ•¸)
      async function fetchFromAPIWithRetry(page = 1, limit = 5, searchParams = {}) {
        console.log('ğŸŒ é–‹å§‹ API èª¿ç”¨:', { page, limit, searchParams });
        const maxRetries = CONFIG.MAX_RETRIES;
        
        for (let attempt = 1; attempt <= maxRetries; attempt++) {
          try {
            // æ§‹å»ºURLåƒæ•¸
            const urlParams = new URLSearchParams();
            urlParams.append('page', page);
            urlParams.append('limit', limit);
            
            // æ·»åŠ æœç´¢åƒæ•¸
            if (searchParams.search && searchParams.search.trim()) {
              urlParams.append('search', searchParams.search.trim());
            }
            
            // æ·»åŠ åˆ†é¡åƒæ•¸
            if (searchParams.category && searchParams.category !== '' && searchParams.category !== 'all') {
              urlParams.append('category', searchParams.category);
            }
            
            // æ·»åŠ æ’åºåƒæ•¸
            if (searchParams.sort) {
              urlParams.append('sort', searchParams.sort);
              if (searchParams.order) {
                urlParams.append('order', searchParams.order);
              }
            }
            
            const url = `${CONFIG.API_BASE_URL}/yoga-poses/?${urlParams.toString()}`;
            console.log(`API å˜—è©¦ ${attempt}/${maxRetries}:`, url);
            console.log(`ğŸ” URLåƒæ•¸æª¢æŸ¥ - page: ${page}, limit: ${limit}`);
            console.log(`ğŸ” å®Œæ•´URLåƒæ•¸:`, urlParams.toString());
            
            // æ›´æ–°è¼‰å…¥æ¶ˆæ¯
            const loadingMessage = document.getElementById('loading-message');
            if (loadingMessage) {
              loadingMessage.textContent = `è¼‰å…¥ç‘œä¼½å‹•ä½œä¸­... (å˜—è©¦ ${attempt}/${maxRetries})`;
            }
            
            const response = await fetch(url);
            
            if (!response.ok) {
              throw new Error(`HTTP éŒ¯èª¤: ${response.status}`);
            }
            
            const data = await response.json();
            console.log('API éŸ¿æ‡‰:', data);
            
            // æª¢æŸ¥æ˜¯å¦æ˜¯æ¸¬è©¦éŒ¯èª¤
            if (data.error) {
              console.log('æ”¶åˆ°æ¸¬è©¦éŒ¯èª¤ï¼Œé‡è©¦ä¸­...', data.error);
              if (attempt < maxRetries) {
                await new Promise(resolve => setTimeout(resolve, CONFIG.RETRY_DELAY));
                continue;
              } else {
                throw new Error(`API æ¸¬è©¦éŒ¯èª¤: ${data.error}`);
              }
            }
            
            // æˆåŠŸç²å–æ•¸æ“š
            if (data.items && Array.isArray(data.items)) {
              const totalItems = data.pagination?.total || data.items.length;
              const currentTotal = (page - 1) * limit + data.items.length;
              // ä¿®æ­£: æ›´æ™ºèƒ½çš„æª¢æ¸¬æ˜¯å¦é‚„æœ‰æ›´å¤šæ•¸æ“š
              const hasMoreItems = data.pagination ? 
                (data.pagination.total > currentTotal) : 
                (data.items.length === limit); // å¦‚æœè¿”å›çš„é …ç›®æ•¸ç­‰æ–¼è«‹æ±‚çš„é™åˆ¶ï¼Œé€šå¸¸è¡¨ç¤ºé‚„æœ‰æ›´å¤šæ•¸æ“š
              
              console.log('ğŸ” APIéŸ¿æ‡‰åˆ†æ:', {
                page,
                requestedLimit: limit,
                itemsInResponse: data.items.length,
                totalItems,
                currentTotal,
                hasMoreItems,
                paginationData: data.pagination
              });
              
              // ğŸš¨ å¼·åˆ¶æª¢æŸ¥ï¼šå¦‚æœAPIè¿”å›è¶…éé™åˆ¶çš„é …ç›®ï¼Œå‰‡æˆªå–
              let actualItems = data.items;
              console.log(`ğŸ” CRITICAL DEBUG - åŸå§‹APIè¿”å›: ${data.items.length} é …ç›®`);
              console.log(`ğŸ” CRITICAL DEBUG - è«‹æ±‚çš„é™åˆ¶: ${limit} é …ç›®`);
              console.log(`ğŸ” CRITICAL DEBUG - å‰3å€‹é …ç›®ID:`, data.items.slice(0,3).map(item => item.id));
              
              if (data.items.length > limit) {
                console.warn(`âš ï¸ ğŸš¨ FORCE TRUNCATE: APIè¿”å›äº†${data.items.length}å€‹é …ç›®ï¼Œä½†è«‹æ±‚é™åˆ¶æ˜¯${limit}ï¼Œå¼·åˆ¶æˆªå–å‰${limit}å€‹`);
                actualItems = data.items.slice(0, limit);
                console.log(`âœ… æˆªå–å¾Œé …ç›®æ•¸é‡: ${actualItems.length}`);
              } else {
                console.log(`âœ… APIè¿”å›æ•¸é‡æ­£ç¢º: ${data.items.length} <= ${limit}`);
              }
              
              return {
                items: actualItems,
                total: totalItems,
                hasMore: hasMoreItems
              };
            } else {
              throw new Error('ç„¡æ•ˆçš„æ•¸æ“šæ ¼å¼');
            }
            
          } catch (error) {
            console.log(`å˜—è©¦ ${attempt} å¤±æ•—:`, error.message);
            
            if (attempt < maxRetries) {
              await new Promise(resolve => setTimeout(resolve, CONFIG.BASE_RETRY_DELAY));
            } else {
              throw error;
            }
          }
        }
      }
      
      // Step 23: æ”¶è—éæ¿¾åŠŸèƒ½
      async function toggleBookmarkFilter() {
        console.log('ğŸ”˜ æ”¶è—éæ¿¾æŒ‰éˆ•è¢«é»æ“Šï¼');
        
        // æª¢æŸ¥ç”¨æˆ¶æ˜¯å¦å·²ç™»å…¥
        if (!currentUser || !currentUser.id) {
          console.log('âš ï¸ ç”¨æˆ¶æœªç™»å…¥ï¼Œé¡¯ç¤ºè­¦å‘Š');
          showAlert('è«‹å…ˆç™»å…¥æœƒå“¡æ‰èƒ½ä½¿ç”¨æ”¶è—éæ¿¾åŠŸèƒ½ï¼', 'warning');
          return;
        }
        
        console.log('âœ… ç”¨æˆ¶å·²ç™»å…¥:', currentUser);
        
        // ç¢ºä¿ç”¨æˆ¶æ•¸æ“šå·²è¼‰å…¥
        if (!bookmarks) {
          console.log('æ­£åœ¨è¼‰å…¥ç”¨æˆ¶æ”¶è—æ•¸æ“š...');
          await initializeUserData();
        }
        
        console.log('ğŸ“š æ”¶è—æ•¸æ“š:', bookmarks);
        
        // æª¢æŸ¥æ˜¯å¦æœ‰æ”¶è—æ•¸æ“š
        if (!bookmarks || bookmarks.length === 0) {
          console.log('âš ï¸ æ²’æœ‰æ”¶è—æ•¸æ“šï¼Œé¡¯ç¤ºæç¤º');
          showAlert('æ‚¨é‚„æ²’æœ‰ä»»ä½•æ”¶è—çš„ç‘œä¼½é«”å¼ï¼', 'info');
          return;
        }
        
        currentSearchParams.showBookmarkedOnly = !currentSearchParams.showBookmarkedOnly;
        
        console.log('ğŸ”„ åˆ‡æ›æ›¸ç±¤éæ¿¾:', currentSearchParams.showBookmarkedOnly);
        console.log('ğŸ“š ç›®å‰æ›¸ç±¤æ•¸é‡:', bookmarks.length);
        console.log('ğŸ“‹ ç›®å‰é …ç›®æ•¸é‡:', allItems.length);
        console.log('ğŸ‘¤ ç•¶å‰ç”¨æˆ¶:', currentUser);
        
        const filterBtn = document.getElementById('bookmark-filter-btn');
        const icon = filterBtn.querySelector('ion-icon');
        
        if (currentSearchParams.showBookmarkedOnly) {
          filterBtn.setAttribute('fill', 'solid');
          filterBtn.setAttribute('color', 'danger');
          icon.setAttribute('name', 'heart');
          filterBtn.innerHTML = '<ion-icon name="heart"></ion-icon> åªé¡¯ç¤ºæ”¶è—';
        } else {
          filterBtn.setAttribute('fill', 'outline');
          filterBtn.setAttribute('color', 'primary');
          icon.setAttribute('name', 'heart-outline');
          filterBtn.innerHTML = '<ion-icon name="heart-outline"></ion-icon> é¡¯ç¤ºå…¨éƒ¨';
        }
        
        // é‡æ–°é¡¯ç¤ºç•¶å‰é …ç›®ï¼Œæ‡‰ç”¨æ”¶è—éæ¿¾
        console.log('ğŸ”„ é–‹å§‹æ‡‰ç”¨æ”¶è—éæ¿¾...');
        applyBookmarkFilter();
      }
      
      function applyBookmarkFilter() {
        console.log('ğŸ” é–‹å§‹æ”¶è—éæ¿¾...');
        console.log('   showBookmarkedOnly:', currentSearchParams.showBookmarkedOnly);
        console.log('   bookmarksæ•¸é‡:', bookmarks.length);
        console.log('   allItemsæ•¸é‡:', allItems.length);
        console.log('   ç•¶å‰ç”¨æˆ¶:', currentUser);
        
        if (currentSearchParams.showBookmarkedOnly) {
          console.log('   å®Œæ•´æ”¶è—åˆ—è¡¨:', bookmarks);
          console.log('   æ”¶è—IDåˆ—è¡¨:', bookmarks.map(b => b.id));
          console.log('   é …ç›®IDåˆ—è¡¨(å‰5å€‹):', allItems.slice(0,5).map(item => ({id: item.id, title: item.title})));
          
          // è©³ç´°åŒ¹é…æª¢æŸ¥ - é¡¯ç¤ºæ”¶è—çš„é …ç›®
          const matchedItems = [];
          allItems.forEach(item => {
            const isBookmarked = bookmarks.some(bookmark => {
              const match = parseInt(bookmark.id) === parseInt(item.id);
              if (match) {
                matchedItems.push({itemId: item.id, bookmarkId: bookmark.id, title: item.title});
              }
              return match;
            });
          });
          console.log('   åŒ¹é…çš„æ”¶è—é …ç›®:', matchedItems);
          
          if (matchedItems.length === 0) {
            console.warn('âš ï¸ æ²’æœ‰æ‰¾åˆ°åŒ¹é…çš„æ”¶è—é …ç›®ï¼');
            console.warn('âš ï¸ èª¿è©¦ä¿¡æ¯: æª¢æŸ¥ bookmarks å’Œ allItems çš„ ID é¡å‹æ˜¯å¦ä¸€è‡´');
          }
        }
        
        const itemsToDisplay = currentSearchParams.showBookmarkedOnly 
          ? allItems.filter(item => bookmarks.some(bookmark => parseInt(bookmark.id) === parseInt(item.id)))
          : allItems;
          
        console.log(`ğŸ“Š æ”¶è—éæ¿¾çµæœ: ${itemsToDisplay.length}/${allItems.length} é …ç›®`);
        
        if (currentSearchParams.showBookmarkedOnly && itemsToDisplay.length === 0) {
          console.warn('âš ï¸ éæ¿¾å¾Œæ²’æœ‰ä»»ä½•é …ç›®é¡¯ç¤ºï¼');
          console.warn('   é€™å¯èƒ½æ˜¯å› ç‚º:');
          console.warn('   1. æ²’æœ‰çœŸæ­£æ”¶è—ä»»ä½•é …ç›®');
          console.warn('   2. æ”¶è—æ•¸æ“šçš„IDèˆ‡allItemsçš„IDä¸åŒ¹é…');
          console.warn('   3. æ”¶è—æ•¸æ“šçµæ§‹éŒ¯èª¤');
        }
        
        // æ›´æ–°å…¨å±€è®Šé‡ filteredItems ä»¥ç¢ºä¿å¾ŒçºŒæ“ä½œæ­£ç¢º
        filteredItems = [...itemsToDisplay];
        
        // ğŸ”¥ ä¿®å¾©ï¼šæ”¶è—éæ¿¾æ™‚é‡ç½®åˆ†é ç‹€æ…‹
        currentPage = 1;
        
        // é‡æ–°é¡¯ç¤ºé …ç›® - æ¸…ç†æ‰€æœ‰é é¢å€åŸŸ
        const page1Grid = document.getElementById('page-1-grid');
        const page2Grid = document.getElementById('page-2-grid');
        const page2Section = document.getElementById('page-2-section');
        
        if (page1Grid) page1Grid.innerHTML = '';
        if (page2Grid) page2Grid.innerHTML = '';
        if (page2Section) page2Section.style.display = 'none';
        
        // å°‡æ”¶è—éæ¿¾çš„çµæœé¡¯ç¤ºåœ¨ç¬¬ä¸€é 
        if (itemsToDisplay.length > 0) {
          displayItems(itemsToDisplay, false, false); // ä¸æ›´æ–°æ›¸ç±¤UIï¼Œé¿å…éè¿´
        }
        
        // ğŸ”¥ æ‰‹å‹•æ›´æ–°æ›¸ç±¤UIï¼Œä½†ä¸è§¸ç™¼éè¿´
        if (currentUser && bookmarks) {
          const bookmarkBtns = document.querySelectorAll('.bookmark-btn');
          bookmarkBtns.forEach(btn => {
            const itemId = parseInt(btn.getAttribute('data-item-id'));
            const isBookmarked = bookmarks.some(b => parseInt(b.id) === itemId);
            
            if (isBookmarked) {
              btn.setAttribute('fill', 'solid');
              btn.setAttribute('color', 'danger');
              btn.innerHTML = '<ion-icon name="heart" slot="start"></ion-icon>å·²æ”¶è—';
            } else {
              btn.setAttribute('fill', 'clear');
              btn.setAttribute('color', 'medium');
              btn.innerHTML = '<ion-icon name="heart-outline" slot="start"></ion-icon>æ”¶è—';
            }
          });
        }
        
        // æ›´æ–°åˆ†é ä¿¡æ¯
        if (currentSearchParams.showBookmarkedOnly) {
          const pagination = document.getElementById('pagination-container');
          const noMoreData = document.getElementById('no-more-data');
          const info = document.getElementById('pagination-info');
          
          noMoreData.style.display = 'none';
          info.innerHTML = `
            <strong>æ”¶è—é …ç›®: ${itemsToDisplay.length} é …</strong>
            <br>
            <small style="color: #666;">é—œé–‰æ”¶è—éæ¿¾å¯ç€è¦½æ›´å¤šé …ç›®</small>
          `;
        } else {
          // ğŸ”¥ ä¿®å¾©ï¼šå–æ¶ˆæ”¶è—éæ¿¾æ™‚æ¢å¾©åˆ†é ç‹€æ…‹
          console.log('ğŸ”„ å–æ¶ˆæ”¶è—éæ¿¾ï¼Œæ¢å¾©åŸæœ‰åˆ†é é¡¯ç¤º');
          
          // æ¢å¾©åˆ†é ç‹€æ…‹ï¼šå¦‚æœæœ‰10é …å‰‡è¨­ç‚ºç¬¬2é ï¼Œå¦å‰‡ç¬¬1é 
          if (allItems.length >= 10) {
            currentPage = 2;
          } else {
            currentPage = 1;
          }
          
          // é‡æ–°é¡¯ç¤ºæ‰€æœ‰æ•¸æ“š
          redisplayAllItems();
          updatePaginationInfo();
        }
      }
      
      // Step 7: Load More Button functionality
      async function loadMorePoses() {
        if (isLoadingMore || showingAllData) {
          console.log('âš ï¸ å·²åœ¨è¼‰å…¥ä¸­æˆ–å·²é¡¯ç¤ºæ‰€æœ‰æ•¸æ“š');
          return;
        }
        
        console.log('ï¿½ ç”¨æˆ¶é»æ“Š Load More æŒ‰éˆ•');
        isLoadingMore = true;
        
        const loadMoreBtn = document.getElementById('load-more-btn');
        const loadMoreLoading = document.getElementById('load-more-loading');
        const loadMoreError = document.getElementById('load-more-error');
        
        try {
          // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
          loadMoreBtn.style.display = 'none';
          loadMoreLoading.style.display = 'block';
          loadMoreError.style.display = 'none';
          
          const nextPage = currentPage + 1;
          console.log(`ğŸ”„ è¼‰å…¥ç¬¬ ${nextPage} é æ•¸æ“šï¼Œç•¶å‰é¡¯ç¤º: ${allItems.length} é …`);
          
          const result = await fetchFromAPIWithRetry(nextPage, 5, currentSearchParams);
          
          if (!result.items || result.items.length === 0) {
            console.log('ğŸ“„ æ²’æœ‰æ›´å¤šæ•¸æ“šå¯è¼‰å…¥');
            showingAllData = true;
            updatePaginationInfo();
            return;
          }
          
          // æ›´æ–°é æ•¸
          currentPage = nextPage;
          
          console.log('ğŸ” APIè¿”å›çš„ç¬¬2é æ•¸æ“š:', {
            page: nextPage,
            itemCount: result.items.length,
            itemIds: result.items.map(item => item.id),
            itemTitles: result.items.map(item => item.title || item.sanskrit_name)
          });
          
          // æª¢æŸ¥é‡è¤‡é …ç›®ä¸¦éæ¿¾
          const existingIds = new Set(allItems.map(item => parseInt(item.id)));
          let newItems = result.items.filter(item => {
            const itemId = parseInt(item.id);
            if (existingIds.has(itemId)) {
              console.warn(`âš ï¸ è·³éé‡è¤‡é …ç›®: ID ${itemId} - ${item.title || item.sanskrit_name}`);
              return false;
            }
            return true;
          });
          
          console.log('âœ… éæ¿¾å¾Œçš„æ–°é …ç›®:', {
            originalCount: result.items.length,
            filteredCount: newItems.length,
            newItemIds: newItems.map(item => item.id)
          });
          
          if (newItems.length === 0) {
            console.log('ğŸ“„ éæ¿¾å¾Œæ²’æœ‰æ–°é …ç›®å¯æ·»åŠ ');
            showingAllData = true;
            updatePaginationInfo();
            return;
          }
          
          // åˆä½µæ–°æ•¸æ“š - åªæ·»åŠ ä¸é‡è¤‡çš„é …ç›®
          const oldLength = allItems.length;
          allItems = [...allItems, ...newItems];
          hasMoreData = result.hasMore && newItems.length > 0;
          showingAllData = !hasMoreData;
          
          console.log(`âœ… Load More æˆåŠŸ: ç¬¬${currentPage}é  | æ–°å¢ ${newItems.length} é … | ç¸½è¨ˆ ${allItems.length} é …`);
          console.log('ğŸ“Š è¼‰å…¥å®Œæˆå‰ - æ‰€æœ‰é …ç›®IDs:', allItems.map(item => item.id));
          
          // ğŸ”¥ é‡è¦ï¼šå°æ‰€æœ‰æ•¸æ“šé€²è¡Œæ•´é«”æ’åºï¼ˆå¦‚æœæœ‰é¸æ“‡æ’åºæ–¹å¼ï¼‰
          if (currentSearchParams.sort) {
            allItems = applySorting(allItems, currentSearchParams.sort, currentSearchParams.order);
            console.log('ğŸ“Š å·²å°æ‰€æœ‰ 10 é …æ•¸æ“šæ‡‰ç”¨æ•´é«”æ’åº:', currentSearchParams.sort, currentSearchParams.order);
            console.log('ğŸ“Š æ’åºå¾Œçš„å®Œæ•´åˆ—è¡¨:', allItems.map(item => ({
              title: item.title || item.sanskrit_name,
              difficulty: item.difficulty
            })));
          }
          
          filteredItems = [...allItems];
          
          // é‡æ–°é¡¯ç¤ºæ‰€æœ‰æ’åºå¾Œçš„æ•¸æ“š
          redisplayAllItems();
          
          // æ›´æ–°åˆ†é ä¿¡æ¯
          updatePaginationInfo();
          
        } catch (error) {
          console.error('âŒ Load More è¼‰å…¥å¤±æ•—:', error);
          
          // é¡¯ç¤ºéŒ¯èª¤ä¿¡æ¯
          loadMoreError.style.display = 'block';
          const errorText = document.getElementById('load-more-error-text');
          errorText.textContent = `è¼‰å…¥å¤±æ•—: ${error.message}`;
          
          // æ¢å¾© Load More æŒ‰éˆ•
          loadMoreBtn.style.display = 'block';
          
        } finally {
          isLoadingMore = false;
          loadMoreLoading.style.display = 'none';
        }
      }
      
      // é¡¯ç¤ºæ•¸æ“š - Step 7: åˆ†é é¡¯ç¤ºæ¨¡å¼
      function displayItems(items, appendMode = false, shouldUpdateBookmarkUI = true) {
        console.log(`ğŸ–¼ï¸ DISPLAY ITEMS DEBUG: è¦é¡¯ç¤º ${items.length} å€‹é …ç›®, æ¨¡å¼: ${appendMode ? 'è¿½åŠ ' : 'æ›¿æ›'}`);
        console.log(`ğŸ–¼ï¸ DISPLAY ç•¶å‰é : ${currentPage}, itemsåƒæ•¸:`, items.map(item => ({id: item.id, title: item.title})));
        
        const list = document.getElementById('poses-list');
        const loading = document.getElementById('loading-container');
        const pagination = document.getElementById('pagination-container');
        
        if (!list) {
          console.error('æ‰¾ä¸åˆ° poses-list å…ƒç´ ');
          return;
        }
        
        // æ ¹æ“šç•¶å‰é æ•¸æ±ºå®šè¦å¡«å……å“ªå€‹å€åŸŸ
        let targetGrid;
        let targetSection;
        
        if (currentPage === 1) {
          // ç¬¬ä¸€é ï¼šå¡«å…… page-1-grid
          targetGrid = document.getElementById('page-1-grid');
          targetSection = document.getElementById('page-1-section');
          console.log('ğŸ–¼ï¸ é¡¯ç¤ºç¬¬1é æ•¸æ“šåˆ° page-1-grid');
          
          // æ¸…ç©ºç¬¬ä¸€é çš„ç¶²æ ¼
          targetGrid.innerHTML = '';
          
        } else if (currentPage === 2) {
          // ç¬¬äºŒé ï¼šå¡«å…… page-2-grid
          targetGrid = document.getElementById('page-2-grid');
          targetSection = document.getElementById('page-2-section');
          console.log('ğŸ–¼ï¸ é¡¯ç¤ºç¬¬2é æ•¸æ“šåˆ° page-2-grid');
          
          // é¡¯ç¤ºç¬¬äºŒé å€åŸŸï¼ˆç¢ºä¿å…ƒç´ å­˜åœ¨ï¼‰
          if (targetSection) {
            targetSection.style.display = 'block';
          }
          
          // æ¸…ç©ºç¬¬äºŒé çš„ç¶²æ ¼
          if (targetGrid) {
            targetGrid.innerHTML = '';
          }
        }
        
        if (!targetGrid) {
          console.error('æ‰¾ä¸åˆ°ç›®æ¨™ç¶²æ ¼å…ƒç´ ');
          return;
        }
        
        // æª¢æŸ¥ç¾æœ‰å¡ç‰‡æ•¸é‡
        const existingCards = targetGrid.querySelectorAll('.pose-card').length;
        console.log(`ğŸ“Š é¡¯ç¤ºå‰ç‹€æ…‹: ç›®æ¨™ç¶²æ ¼ç¾æœ‰å¡ç‰‡ ${existingCards} å¼µï¼Œå³å°‡æ·»åŠ  ${items.length} å¼µ`);
        
        items.forEach(item => {
          const card = document.createElement('ion-card');
          card.className = 'pose-card';
          
          card.innerHTML = `
            <ion-card-header>
              <ion-card-title>${item.title || item.sanskrit_name || 'ç„¡æ¨™é¡Œ'}</ion-card-title>
              <ion-card-subtitle>
                ${item.category || 'æœªåˆ†é¡'} â€¢ ${item.difficulty || 'æœªè¨­å®š'} â€¢ ${item.duration_minutes ? item.duration_minutes + ' åˆ†é˜' : 'æœªè¨­å®šæ™‚é•·'}
              </ion-card-subtitle>
            </ion-card-header>
            
            <ion-card-content>
              ${item.image_url ? `
                <img class="item-image" src="${item.image_url}" alt="${item.title || item.sanskrit_name}" loading="lazy">
              ` : ''}
              
              <p><strong>æ¢µæ–‡å:</strong> ${item.sanskrit_name || 'ç„¡'}</p>
              <p><strong>æ•™ç·´:</strong> ${item.instructor || 'æœªè¨­å®š'}</p>
              <p><strong>èªªæ˜:</strong> ${item.description || 'ç„¡èªªæ˜'}</p>
              
              ${item.benefits && Array.isArray(item.benefits) ? `
                <p><strong>å¥½è™•:</strong></p>
                <ul>
                  ${item.benefits.map(benefit => `<li>${benefit}</li>`).join('')}
                </ul>
              ` : ''}
              
              ${item.video_url ? `
                <div style="margin-top: 10px;">
                  <ion-button href="${item.video_url}" target="_blank" fill="outline" size="small">
                    <ion-icon name="play-circle-outline" slot="start"></ion-icon>
                    è§€çœ‹è¦–é »
                  </ion-button>
                </div>
              ` : ''}
              
              <div style="margin-top: 10px; display: flex; justify-content: space-between; align-items: center;">
                <ion-button 
                  fill="clear" 
                  size="small" 
                  onclick="toggleBookmark(${item.id})"
                  data-item-id="${item.id}"
                  class="bookmark-btn"
                  color="medium">
                  <ion-icon name="heart-outline" slot="start"></ion-icon>
                  æ”¶è—
                </ion-button>
                
                ${currentUser ? `
                  <ion-chip color="primary" size="small">
                    <ion-icon name="person"></ion-icon>
                    <ion-label>å·²ç™»éŒ„</ion-label>
                  </ion-chip>
                ` : `
                  <ion-chip color="medium" size="small">
                    <ion-icon name="person-outline"></ion-icon>
                    <ion-label>è¨ªå®¢</ion-label>
                  </ion-chip>
                `}
              </div>
            </ion-card-content>
          `;
          
          targetGrid.appendChild(card);
        });
        
        // æ›´æ–°é¡¯ç¤ºç‹€æ…‹
        loading.style.display = 'none';
        list.style.display = 'block';
        
        // ğŸ” è¨ˆç®—å¯¦éš›æ¸²æŸ“çš„å¡ç‰‡æ•¸é‡
        const page1Cards = document.querySelectorAll('#page-1-grid .pose-card').length;
        const page2Cards = document.querySelectorAll('#page-2-grid .pose-card').length;
        const totalCards = page1Cards + page2Cards;
        
        console.log(`ğŸ–¼ï¸ FINAL RENDER CHECK: ç¬¬1é  ${page1Cards} å¼µå¡ç‰‡, ç¬¬2é  ${page2Cards} å¼µå¡ç‰‡, ç¸½è¨ˆ ${totalCards} å¼µ`);
        console.log(`ğŸ–¼ï¸ é æœŸé¡¯ç¤ºæ•¸é‡: ${allItems.length}, å¯¦éš›é¡¯ç¤ºæ•¸é‡: ${totalCards}`);
        
        // æ›´æ–°æ›¸ç±¤UIç‹€æ…‹ - æ ¹æ“šåƒæ•¸æ±ºå®šæ˜¯å¦æ›´æ–°
        if (currentUser && shouldUpdateBookmarkUI) {
          updateBookmarkUI();
        }
        
        // æ›´æ–°åˆ†é ä¿¡æ¯
        updatePaginationInfo();
        pagination.style.display = 'block';
        
        console.log('æ•¸æ“šé¡¯ç¤ºå®Œæˆ');
      }

      // é‡æ–°é¡¯ç¤ºæ‰€æœ‰æ’åºå¾Œçš„æ•¸æ“š
      function redisplayAllItems() {
        console.log('ğŸ”„ é‡æ–°é¡¯ç¤ºæ‰€æœ‰æ’åºå¾Œçš„æ•¸æ“š');
        
        // åˆ†é…æ•¸æ“šï¼šå‰5é …åˆ°ç¬¬1é ï¼Œå¾Œ5é …åˆ°ç¬¬2é 
        const page1Items = allItems.slice(0, 5);
        const page2Items = allItems.slice(5, 10);
        
        console.log('ğŸ“„ ç¬¬1é é …ç›®:', page1Items.map(item => ({ 
          title: item.title || item.sanskrit_name, 
          difficulty: item.difficulty 
        })));
        console.log('ğŸ“„ ç¬¬2é é …ç›®:', page2Items.map(item => ({ 
          title: item.title || item.sanskrit_name, 
          difficulty: item.difficulty 
        })));
        
        // æ¸…ç©ºä¸¦é‡æ–°é¡¯ç¤ºç¬¬1é 
        const page1Grid = document.getElementById('page-1-grid');
        if (page1Grid && page1Items.length > 0) {
          page1Grid.innerHTML = '';
          page1Items.forEach(item => {
            const card = document.createElement('ion-card');
            card.className = 'pose-card';
            
            card.innerHTML = `
              <ion-card-header>
                <ion-card-title>${item.title || item.sanskrit_name || 'ç„¡æ¨™é¡Œ'}</ion-card-title>
                <ion-card-subtitle>
                  ${item.category || 'æœªåˆ†é¡'} â€¢ ${item.difficulty || 'æœªè¨­å®š'} â€¢ ${item.duration_minutes ? item.duration_minutes + ' åˆ†é˜' : 'æœªè¨­å®šæ™‚é•·'}
                </ion-card-subtitle>
              </ion-card-header>
              
              <ion-card-content>
                ${item.image_url ? `
                  <img class="item-image" src="${item.image_url}" alt="${item.title || item.sanskrit_name}" loading="lazy">
                ` : ''}
                
                <p><strong>æ¢µæ–‡å:</strong> ${item.sanskrit_name || 'ç„¡'}</p>
                <p><strong>æ•™ç·´:</strong> ${item.instructor || 'æœªè¨­å®š'}</p>
                <p><strong>èªªæ˜:</strong> ${item.description || 'ç„¡èªªæ˜'}</p>
                
                ${item.benefits && Array.isArray(item.benefits) ? `
                  <p><strong>å¥½è™•:</strong></p>
                  <ul>
                    ${item.benefits.map(benefit => `<li>${benefit}</li>`).join('')}
                  </ul>
                ` : ''}
                
                ${item.video_url ? `
                  <div style="margin-top: 10px;">
                    <ion-button href="${item.video_url}" target="_blank" fill="outline" size="small">
                      <ion-icon name="play-circle-outline" slot="start"></ion-icon>
                      è§€çœ‹è¦–é »
                    </ion-button>
                  </div>
                ` : ''}
                
                <div style="margin-top: 10px; display: flex; justify-content: space-between; align-items: center;">
                  <ion-button 
                    fill="clear" 
                    size="small" 
                    onclick="toggleBookmark(${item.id})"
                    data-item-id="${item.id}"
                    class="bookmark-btn"
                    color="medium">
                    <ion-icon name="heart-outline" slot="start"></ion-icon>
                    æ”¶è—
                  </ion-button>
                  
                  ${currentUser ? `
                    <ion-chip color="primary" size="small">
                      <ion-icon name="person"></ion-icon>
                      <ion-label>å·²ç™»éŒ„</ion-label>
                    </ion-chip>
                  ` : `
                    <ion-chip color="medium" size="small">
                      <ion-icon name="person-outline"></ion-icon>
                      <ion-label>è¨ªå®¢</ion-label>
                    </ion-chip>
                  `}
                </div>
              </ion-card-content>
            `;
            
            page1Grid.appendChild(card);
          });
        }
        
        // æ¸…ç©ºä¸¦é‡æ–°é¡¯ç¤ºç¬¬2é 
        const page2Grid = document.getElementById('page-2-grid');
        const page2Section = document.getElementById('page-2-section');
        
        if (page2Items.length > 0) {
          if (page2Grid) {
            page2Grid.innerHTML = '';
            page2Items.forEach(item => {
              const card = document.createElement('ion-card');
              card.className = 'pose-card';
              
              card.innerHTML = `
                <ion-card-header>
                  <ion-card-title>${item.title || item.sanskrit_name || 'ç„¡æ¨™é¡Œ'}</ion-card-title>
                  <ion-card-subtitle>
                    ${item.category || 'æœªåˆ†é¡'} â€¢ ${item.difficulty || 'æœªè¨­å®š'} â€¢ ${item.duration_minutes ? item.duration_minutes + ' åˆ†é˜' : 'æœªè¨­å®šæ™‚é•·'}
                  </ion-card-subtitle>
                </ion-card-header>
                
                <ion-card-content>
                  ${item.image_url ? `
                    <img class="item-image" src="${item.image_url}" alt="${item.title || item.sanskrit_name}" loading="lazy">
                  ` : ''}
                  
                  <p><strong>æ¢µæ–‡å:</strong> ${item.sanskrit_name || 'ç„¡'}</p>
                  <p><strong>æ•™ç·´:</strong> ${item.instructor || 'æœªè¨­å®š'}</p>
                  <p><strong>èªªæ˜:</strong> ${item.description || 'ç„¡èªªæ˜'}</p>
                  
                  ${item.benefits && Array.isArray(item.benefits) ? `
                    <p><strong>å¥½è™•:</strong></p>
                    <ul>
                      ${item.benefits.map(benefit => `<li>${benefit}</li>`).join('')}
                    </ul>
                  ` : ''}
                  
                  ${item.video_url ? `
                    <div style="margin-top: 10px;">
                      <ion-button href="${item.video_url}" target="_blank" fill="outline" size="small">
                        <ion-icon name="play-circle-outline" slot="start"></ion-icon>
                        è§€çœ‹è¦–é »
                      </ion-button>
                    </div>
                  ` : ''}
                  
                  <div style="margin-top: 10px; display: flex; justify-content: space-between; align-items: center;">
                    <ion-button 
                      fill="clear" 
                      size="small" 
                      onclick="toggleBookmark(${item.id})"
                      data-item-id="${item.id}"
                      class="bookmark-btn"
                      color="medium">
                      <ion-icon name="heart-outline" slot="start"></ion-icon>
                      æ”¶è—
                    </ion-button>
                    
                    ${currentUser ? `
                      <ion-chip color="primary" size="small">
                        <ion-icon name="person"></ion-icon>
                        <ion-label>å·²ç™»éŒ„</ion-label>
                      </ion-chip>
                    ` : `
                      <ion-chip color="medium" size="small">
                        <ion-icon name="person-outline"></ion-icon>
                        <ion-label>è¨ªå®¢</ion-label>
                      </ion-chip>
                    `}
                  </div>
                </ion-card-content>
              `;
              
              page2Grid.appendChild(card);
            });
          }
          if (page2Section) {
            page2Section.style.display = 'block';
          }
        } else {
          if (page2Section) {
            page2Section.style.display = 'none';
          }
        }
        
        // æ›´æ–°æ›¸ç±¤UIç‹€æ…‹
        if (currentUser) {
          updateBookmarkUI();
        }
        
        // æ›´æ–°åˆ†é ä¿¡æ¯
        updatePaginationInfo();
        
        console.log('âœ… æ‰€æœ‰æ•¸æ“šé‡æ–°é¡¯ç¤ºå®Œæˆ');
      }

      // å°ç¾æœ‰æ•¸æ“šé€²è¡Œæ•´é«”æ’åºè€Œä¸é‡æ–°è¼‰å…¥
      function applySortingToExistingData() {
        if (allItems.length === 0) {
          console.log('ğŸ“Š æ²’æœ‰ç¾æœ‰æ•¸æ“šå¯æ’åºï¼Œå°‡è§¸ç™¼é‡æ–°è¼‰å…¥');
          return false;
        }

        console.log('ğŸ“Š å°ç¾æœ‰ ' + allItems.length + ' é …æ•¸æ“šé€²è¡Œæ•´é«”æ’åº');
        
        // æ‡‰ç”¨æ’åº
        if (currentSearchParams.sort) {
          allItems = applySorting(allItems, currentSearchParams.sort, currentSearchParams.order);
          console.log('ğŸ“Š æ•´é«”æ’åºå®Œæˆ:', currentSearchParams.sort, currentSearchParams.order);
          console.log('ğŸ“Š æ’åºå¾Œçš„å®Œæ•´åˆ—è¡¨:', allItems.map(item => ({
            title: item.title || item.sanskrit_name,
            difficulty: item.difficulty
          })));
        }

        filteredItems = [...allItems];
        
        // é‡æ–°é¡¯ç¤ºæ‰€æœ‰æ’åºå¾Œçš„æ•¸æ“š
        redisplayAllItems();
        
        return true;
      }
      
      // æ›´æ–°åˆ†é ä¿¡æ¯
      function updatePaginationInfo() {
        const info = document.getElementById('pagination-info');
        const loadMoreBtn = document.getElementById('load-more-btn');
        const noMoreData = document.getElementById('no-more-data');
        const pagination = document.getElementById('pagination-container');
        
        const totalDisplayed = allItems.length;
        
        // æ›´æ–°ä¿¡æ¯æ–‡å­— - Step 7 åˆ†é æ¨¡å¼
        if (totalDisplayed === 5) {
          info.innerHTML = `<strong>ç¬¬1é : 5 é …ç‘œä¼½å‹•ä½œ</strong><br><small style="color: #666;">é»æ“Šä¸‹æ–¹æŒ‰éˆ•è¼‰å…¥ç¬¬2é </small>`;
        } else {
          info.innerHTML = `<strong>ç¬¬1é : 5 é … + ç¬¬2é : 5 é … = ç¸½è¨ˆ ${totalDisplayed} é …</strong><br><small style="color: #666;">å…©é æ•¸æ“šå·²å…¨éƒ¨é¡¯ç¤º</small>`;
        }
        
        console.log('Step 7 åˆ†é ä¿¡æ¯:', {
          totalDisplayed,
          hasMoreData,
          showingAllData,
          currentPage
        });
        
        // ç¢ºä¿åˆ†é å®¹å™¨é¡¯ç¤º
        pagination.style.display = 'block';
        
        // æ§åˆ¶ Load More æŒ‰éˆ•å’Œå®Œæˆæç¤ºçš„é¡¯ç¤º
        if (showingAllData || !hasMoreData || totalDisplayed >= 10) {
          // å·²é¡¯ç¤ºæ‰€æœ‰æ•¸æ“š
          loadMoreBtn.style.display = 'none';
          noMoreData.style.display = 'block';
          noMoreData.innerHTML = `
            <ion-icon name="checkmark-circle" style="color: #28a745; margin-right: 8px;"></ion-icon>
            å·²è¼‰å…¥æ‰€æœ‰ç‘œä¼½å‹•ä½œ (å…± ${totalDisplayed} é …)
          `;
          console.log('âœ… é¡¯ç¤ºå®Œæˆæç¤ºï¼Œéš±è— Load More æŒ‰éˆ•');
        } else if (totalDisplayed === 5 && hasMoreData) {
          // åªé¡¯ç¤ºäº†ç¬¬ä¸€é ï¼Œé‚„æœ‰æ›´å¤šæ•¸æ“š
          loadMoreBtn.style.display = 'block';
          noMoreData.style.display = 'none';
          console.log('âœ… é¡¯ç¤º Load More æŒ‰éˆ•');
        } else {
          // å…¶ä»–æƒ…æ³
          loadMoreBtn.style.display = 'none';
          noMoreData.style.display = 'none';
        }
      }
      
      // é¡¯ç¤ºéŒ¯èª¤
      function showError(message) {
        console.error('é¡¯ç¤ºéŒ¯èª¤:', message);
        const loading = document.getElementById('loading-container');
        const error = document.getElementById('error-container');
        const errorMsg = document.getElementById('error-message');
        
        loading.style.display = 'none';
        errorMsg.textContent = message;
        error.style.display = 'block';
      }

      // é€šç”¨è­¦å‘Š/æç¤ºå‡½æ•¸
      function showAlert(message, type = 'info') {
        console.log(`ğŸ“¢ ${type.toUpperCase()}: ${message}`);
        
        // ä½¿ç”¨ç€è¦½å™¨åŸç”Ÿ alert ä½œç‚ºç°¡å–®å¯¦ç¾
        alert(message);
        
        // æˆ–è€…å¯ä»¥åœ¨æœªä¾†æ“´å±•ç‚ºæ›´ç¾è§€çš„ Toast æç¤º
        // ä¾‹å¦‚ï¼šä½¿ç”¨ Ionic Toast çµ„ä»¶
      }
      
      // è¼‰å…¥æ•¸æ“š
      async function loadData() {
        console.log('ğŸš€ é–‹å§‹è¼‰å…¥ç‘œä¼½å‹•ä½œæ•¸æ“š...');
        const loading = document.getElementById('loading-container');
        const error = document.getElementById('error-container');
        const list = document.getElementById('poses-list');
        const pagination = document.getElementById('pagination-container');
        
        // é‡ç½® Load More ç‹€æ…‹
        currentPage = 1;
        allItems = [];
        hasMoreData = true;
        showingAllData = false;
        loading.style.display = 'block';
        error.style.display = 'none';
        list.style.display = 'none';
        pagination.style.display = 'none';
        
        // é‡ç½®åˆ†é å€åŸŸ
        const page1Grid = document.getElementById('page-1-grid');
        const page2Grid = document.getElementById('page-2-grid');
        const page2Section = document.getElementById('page-2-section');
        
        if (page1Grid) page1Grid.innerHTML = '';
        if (page2Grid) page2Grid.innerHTML = '';
        if (page2Section) page2Section.style.display = 'none';
        
        console.log(`è¼‰å…¥åƒæ•¸: page=${currentPage}, limit=5, æœç´¢æ¢ä»¶:`, currentSearchParams);
        
        try {
          // å§‹çµ‚è¼‰å…¥ç¬¬ä¸€é çš„5å€‹é …ç›®
          const result = await fetchFromAPIWithRetry(currentPage, 5, currentSearchParams);
          
          if (!result.items || result.items.length === 0) {
            showError('æ²’æœ‰æ‰¾åˆ°ç‘œä¼½å‹•ä½œæ•¸æ“š');
            return;
          }
          
          // è¨­ç½®åˆå§‹æ•¸æ“š - åªé¡¯ç¤ºç¬¬ä¸€é çš„5å€‹é …ç›®
          allItems = result.items;
          hasMoreData = result.hasMore;
          
          // æš«æ™‚ä¸å°ç¬¬ä¸€é é€²è¡Œæ’åºï¼Œç­‰è¼‰å…¥æ‰€æœ‰æ•¸æ“šå¾Œçµ±ä¸€æ’åº
          filteredItems = [...allItems];
          
          console.log(`âœ… Step 7 é¦–æ¬¡è¼‰å…¥æˆåŠŸ: ${result.items.length} é … (ç¬¬1é ), hasMore: ${result.hasMore}`);
          console.log('ğŸ“Š ç¬¬1é æ•¸æ“šè©³æƒ…:', {
            itemIds: allItems.map(item => item.id),
            itemTitles: allItems.map(item => item.title || item.sanskrit_name),
            difficulties: allItems.map(item => item.difficulty)
          });
          
          displayItems(allItems);
          
          // Step 23: æ‡‰ç”¨æ”¶è—éæ¿¾ï¼ˆå¦‚æœå•Ÿç”¨ï¼‰
          if (currentSearchParams.showBookmarkedOnly) {
            applyBookmarkFilter();
          }
          
        } catch (error) {
          console.error('âŒ è¼‰å…¥æ•¸æ“šå¤±æ•—:', error);
          showError(`è¼‰å…¥å¤±æ•—: ${error.message}`);
        }
      }
      
      // æª¢æ¸¬ç¶²çµ¡ç‹€æ…‹
      function checkNetworkStatus() {
        return navigator.onLine;
      }
      
      // æ›´æ–°éŒ¯èª¤çµ±è¨ˆ
      function updateErrorStats(error) {
        errorStats.totalErrors++;
        errorStats.lastErrorTime = new Date();
        errorStats.consecutiveErrors++;
        
        // åˆ†é¡éŒ¯èª¤é¡å‹
        if (error.message.includes('Failed to fetch') || error.message.includes('ç¶²çµ¡')) {
          errorStats.networkErrors++;
        } else if (error.message.includes('HTTP') && (error.message.includes('500') || error.message.includes('502') || error.message.includes('503'))) {
          errorStats.serverErrors++;
        } else if (error.message.includes('timeout') || error.message.includes('è¶…æ™‚')) {
          errorStats.timeoutErrors++;
        }
        
        console.log('éŒ¯èª¤çµ±è¨ˆæ›´æ–°:', errorStats);
      }
      
      // é‡ç½®éŒ¯èª¤çµ±è¨ˆï¼ˆæˆåŠŸè¼‰å…¥å¾Œèª¿ç”¨ï¼‰
      function resetErrorStats() {
        errorStats.consecutiveErrors = 0;
      }
      
      // æª¢æŸ¥æ˜¯å¦éœ€è¦æš«åœé‡è©¦ï¼ˆé€£çºŒéŒ¯èª¤éå¤šï¼‰
      function shouldPauseRetry() {
        return errorStats.consecutiveErrors >= errorStats.maxConsecutiveErrors;
      }
      
      // è‡ªå‹•é‡è©¦æ©Ÿåˆ¶ï¼ˆå¸¶é€€é¿ç­–ç•¥ï¼‰
      async function autoRetryLoadMore(maxRetries = 3, baseDelay = CONFIG.BASE_RETRY_DELAY) {
        for (let attempt = 1; attempt <= maxRetries; attempt++) {
          try {
            console.log(`å˜—è©¦è‡ªå‹•é‡è©¦è¼‰å…¥æ›´å¤šæ•¸æ“š (${attempt}/${maxRetries})`);
            
            // æª¢æŸ¥ç¶²çµ¡ç‹€æ…‹
            if (!checkNetworkStatus()) {
              throw new Error('ç¶²çµ¡é€£æ¥ä¸å¯ç”¨');
            }
            
            await loadMoreDataInfinite();
            return; // æˆåŠŸå‰‡é€€å‡º
            
          } catch (error) {
            console.log(`è‡ªå‹•é‡è©¦ ${attempt} å¤±æ•—:`, error.message);
            
            if (attempt === maxRetries) {
              throw error; // æ‰€æœ‰é‡è©¦éƒ½å¤±æ•—
            }
            
            // æŒ‡æ•¸é€€é¿å»¶é²
            const delay = baseDelay * Math.pow(2, attempt - 1);
            console.log(`ç­‰å¾… ${delay}ms å¾Œé‡è©¦...`);
            await new Promise(resolve => setTimeout(resolve, delay));
          }
        }
      }
      
      // Load More Button é‡è©¦åŠŸèƒ½
      async function retryLoadMore() {
        console.log('ğŸ”„ ç”¨æˆ¶é»æ“Šé‡è©¦');
        await loadMorePoses();
      }
      
      // è‡ªå®šç¾©æ’åºåŠŸèƒ½ - ç‰¹åˆ¥è™•ç†é›£åº¦æ’åº
      function applySorting(items, sortField, sortOrder) {
        if (!sortField || !items || items.length === 0) {
          return items;
        }
        
        console.log(`ğŸ”„ æ‡‰ç”¨è‡ªå®šç¾©æ’åº: ${sortField} (${sortOrder})`);
        
        const sortedItems = [...items]; // å‰µå»ºå‰¯æœ¬é¿å…ä¿®æ”¹åŸæ•¸çµ„
        
        if (sortField === 'difficulty') {
          // è‡ªå®šç¾©é›£åº¦æ’åº: BEGINNER > INTERMEDIATE > ADVANCED
          const difficultyOrder = {
            'BEGINNER': 1,
            'INTERMEDIATE': 2, 
            'ADVANCED': 3
          };
          
          sortedItems.sort((a, b) => {
            const difficultyA = (a.difficulty || '').toUpperCase();
            const difficultyB = (b.difficulty || '').toUpperCase();
            
            const orderA = difficultyOrder[difficultyA] || 999; // æœªçŸ¥é›£åº¦æ’åœ¨æœ€å¾Œ
            const orderB = difficultyOrder[difficultyB] || 999;
            
            if (sortOrder === 'desc') {
              return orderB - orderA; // é™åºï¼šADVANCED > INTERMEDIATE > BEGINNER
            } else {
              return orderA - orderB; // å‡åºï¼šBEGINNER > INTERMEDIATE > ADVANCED
            }
          });
          
          console.log('âœ… é›£åº¦æ’åºå®Œæˆ:', {
            order: sortOrder === 'asc' ? 'BEGINNER â†’ INTERMEDIATE â†’ ADVANCED' : 'ADVANCED â†’ INTERMEDIATE â†’ BEGINNER',
            results: sortedItems.map(item => ({
              title: item.title || item.sanskrit_name,
              difficulty: item.difficulty
            }))
          });
          
        } else {
          // å…¶ä»–å­—æ®µä½¿ç”¨æ¨™æº–æ’åº
          sortedItems.sort((a, b) => {
            let valueA = a[sortField] || '';
            let valueB = b[sortField] || '';
            
            // è™•ç†æ•¸å­—é¡å‹
            if (sortField === 'duration_minutes') {
              valueA = parseInt(valueA) || 0;
              valueB = parseInt(valueB) || 0;
            } else {
              // å­—ç¬¦ä¸²é¡å‹è½‰ç‚ºå°å¯«é€²è¡Œæ¯”è¼ƒ
              valueA = valueA.toString().toLowerCase();
              valueB = valueB.toString().toLowerCase();
            }
            
            if (sortOrder === 'desc') {
              return valueA < valueB ? 1 : valueA > valueB ? -1 : 0;
            } else {
              return valueA > valueB ? 1 : valueA < valueB ? -1 : 0;
            }
          });
          
          console.log(`âœ… ${sortField} æ’åºå®Œæˆ (${sortOrder})`);
        }
        
        return sortedItems;
      }

      // APIæœç´¢åŠŸèƒ½ - Step 20
      let searchTimeout = null;
      
      async function performAPISearch() {
        // æ¸…é™¤ä¹‹å‰çš„æœç´¢å»¶é²
        if (searchTimeout) {
          clearTimeout(searchTimeout);
        }
        
        // å»¶é²åŸ·è¡Œæœç´¢ï¼Œé¿å…é »ç¹APIèª¿ç”¨
        searchTimeout = setTimeout(async () => {
          const searchTerm = document.getElementById('search-bar').value.trim();
          const selectedCategory = document.getElementById('category-select').value;
          const selectedSort = document.getElementById('sort-select').value;
          const selectedOrder = document.getElementById('order-select').value;
          
          // æ›´æ–°æœç´¢åƒæ•¸
          currentSearchParams.search = searchTerm;
          currentSearchParams.category = selectedCategory;
          currentSearchParams.sort = selectedSort;
          currentSearchParams.order = selectedOrder;
          
          console.log('åŸ·è¡ŒAPIæœç´¢:', currentSearchParams);
          
          // ğŸ”¥ å„ªåŒ–ï¼šå¦‚æœåªæ˜¯æ’åºè®Šæ›´ä¸”å·²æœ‰æ•¸æ“šï¼Œç›´æ¥å°ç¾æœ‰æ•¸æ“šæ’åº
          if (!searchTerm && (!selectedCategory || selectedCategory === '') && selectedSort && allItems.length > 0) {
            console.log('ğŸ“Š æª¢æ¸¬åˆ°ç´”æ’åºæ“ä½œï¼Œå°ç¾æœ‰æ•¸æ“šé€²è¡Œæ•´é«”æ’åº');
            const sortingApplied = applySortingToExistingData();
            if (sortingApplied) {
              console.log('âœ… æ•´é«”æ’åºå®Œæˆï¼Œç„¡éœ€é‡æ–°è¼‰å…¥');
              return;
            }
          }
          
          // å¦‚æœæœ‰æœç´¢æ¢ä»¶ï¼Œé‡æ–°è¼‰å…¥æ•¸æ“š
          if (searchTerm || (selectedCategory && selectedCategory !== '') || selectedSort) {
            await loadData();
          } else {
            // å¦‚æœæ¸…ç©ºæ‰€æœ‰æœç´¢æ¢ä»¶ï¼Œä¹Ÿé‡æ–°è¼‰å…¥æ•¸æ“š
            await loadData();
          }
        }, 500);
      }
      
      // èªè­‰ç›¸é—œåŠŸèƒ½ï¼ˆç°¡åŒ–ç‰ˆï¼‰
      function openAuthModal() {
        document.getElementById('auth-modal').present();
      }
      
      function closeAuthModal() {
        document.getElementById('auth-modal').dismiss();
      }
      
      function closeLogoutModal() {
        document.getElementById('logout-confirm-modal').dismiss();
      }
      
      // Step 25: å¢å¼·è¡¨å–®é©—è­‰å·¥å…·å‡½æ•¸
      function validateEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
      }
      
      function validatePassword(password) {
        // è‡³å°‘8å€‹å­—ç¬¦ï¼ŒåŒ…å«å¤§å¯«å­—æ¯ã€å°å¯«å­—æ¯ã€æ•¸å­—
        const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)[a-zA-Z\d@$!%*?&]{8,}$/;
        return passwordRegex.test(password);
      }
      
      // Step 25: å¯†ç¢¼å¼·åº¦æª¢æŸ¥ï¼ˆè©³ç´°åˆ†æï¼‰
      function getPasswordStrength(password) {
        const checks = {
          length: password.length >= 8,
          lowercase: /[a-z]/.test(password),
          uppercase: /[A-Z]/.test(password),
          numbers: /\d/.test(password),
          special: /[@$!%*?&]/.test(password),
          noSpaces: !/\s/.test(password)
        };
        
        const passedChecks = Object.values(checks).filter(Boolean).length;
        let strength = 'weak';
        let score = 0;
        
        if (checks.length) score += 2;
        if (checks.lowercase) score += 1;
        if (checks.uppercase) score += 1;
        if (checks.numbers) score += 1;
        if (checks.special) score += 2;
        if (checks.noSpaces) score += 1;
        
        if (score >= 7) strength = 'strong';
        else if (score >= 5) strength = 'medium';
        
        return {
          strength,
          score,
          checks,
          isValid: checks.length && checks.lowercase && checks.uppercase && checks.numbers && checks.noSpaces
        };
      }
      
      function validateUsername(username) {
        // ç”¨æˆ¶åï¼š3-20å€‹å­—ç¬¦ï¼Œåªèƒ½åŒ…å«å­—æ¯ã€æ•¸å­—ã€ä¸‹åŠƒç·š
        const usernameRegex = /^[a-zA-Z0-9_]{3,20}$/;
        return usernameRegex.test(username);
      }
      
      // Step 25: å¯¦æ™‚å¯†ç¢¼å¼·åº¦æª¢æŸ¥å’Œè¦–è¦ºåé¥‹
      function updatePasswordStrength(password) {
        const strengthContainer = document.getElementById('password-strength-container');
        const strengthFill = document.getElementById('password-strength-fill');
        const strengthText = document.getElementById('password-strength-text');
        
        if (!password || password.length === 0) {
          strengthContainer.style.display = 'none';
          return;
        }
        
        strengthContainer.style.display = 'block';
        const analysis = getPasswordStrength(password);
        
        // æ›´æ–°å¼·åº¦æ¢
        let width = 0;
        let color = '#dc3545'; // ç´…è‰² (å¼±)
        let text = 'å¼±';
        
        if (analysis.strength === 'strong') {
          width = 100;
          color = '#28a745'; // ç¶ è‰² (å¼·)
          text = 'å¼·';
        } else if (analysis.strength === 'medium') {
          width = 66;
          color = '#ffc107'; // é»ƒè‰² (ä¸­ç­‰)
          text = 'ä¸­ç­‰';
        } else {
          width = 33;
          color = '#dc3545'; // ç´…è‰² (å¼±)
          text = 'å¼±';
        }
        
        strengthFill.style.width = width + '%';
        strengthFill.style.backgroundColor = color;
        strengthText.textContent = text;
        strengthText.style.color = color;
        
        // æ›´æ–°éœ€æ±‚æª¢æŸ¥åˆ—è¡¨
        updateRequirementChecklist(analysis.checks);
      }
      
      function updateRequirementChecklist(checks) {
        const requirements = [
          { id: 'req-length', check: checks.length, text: 'è‡³å°‘8å€‹å­—ç¬¦' },
          { id: 'req-lowercase', check: checks.lowercase, text: 'åŒ…å«å°å¯«å­—æ¯' },
          { id: 'req-uppercase', check: checks.uppercase, text: 'åŒ…å«å¤§å¯«å­—æ¯' },
          { id: 'req-numbers', check: checks.numbers, text: 'åŒ…å«æ•¸å­—' },
          { id: 'req-special', check: checks.special, text: 'åŒ…å«ç‰¹æ®Šå­—ç¬¦ (å¯é¸)' }
        ];
        
        requirements.forEach(req => {
          const element = document.getElementById(req.id);
          if (element) {
            if (req.check) {
              element.innerHTML = `<span style="color: #28a745;">âœ“</span> ${req.text}`;
            } else if (req.id === 'req-special') {
              element.innerHTML = `<span style="color: #6c757d;">â—‹</span> ${req.text}`;
            } else {
              element.innerHTML = `<span style="color: #dc3545;">âœ—</span> ${req.text}`;
            }
          }
        });
      }
      
      function showFieldError(fieldId, message) {
        const errorElement = document.getElementById(fieldId + '-error');
        if (errorElement) {
          errorElement.textContent = message;
          errorElement.classList.add('show');
        }
      }
      
      function hideFieldError(fieldId) {
        const errorElement = document.getElementById(fieldId + '-error');
        if (errorElement) {
          errorElement.classList.remove('show');
        }
      }
      
      function showAuthError(message) {
        const errorElement = document.getElementById('auth-error');
        errorElement.innerHTML = `
          <div style="display: flex; align-items: center;">
            <ion-icon name="alert-circle" style="margin-right: 8px; color: #dc3545;"></ion-icon>
            <span>${message}</span>
          </div>
        `;
        errorElement.classList.add('show');
        
        // 5ç§’å¾Œè‡ªå‹•éš±è—
        setTimeout(() => {
          errorElement.classList.remove('show');
        }, CONFIG.ERROR_DISPLAY_TIMEOUT);
      }
      
      function hideAuthError() {
        const errorElement = document.getElementById('auth-error');
        errorElement.classList.remove('show');
      }
      
      // è¡¨å–®é©—è­‰å‡½æ•¸
      function validateLoginForm() {
        let isValid = true;
        
        const username = document.getElementById('login-username').value.trim();
        const password = document.getElementById('login-password').value;
        
        // æ¸…é™¤ä¹‹å‰çš„éŒ¯èª¤
        hideFieldError('login-username');
        hideFieldError('login-password');
        hideAuthError();
        
        // é©—è­‰ç”¨æˆ¶å/éƒµä»¶
        if (!username) {
          showFieldError('login-username', 'è«‹è¼¸å…¥ç”¨æˆ¶åæˆ–éƒµä»¶');
          isValid = false;
        } else if (username.length < 3) {
          showFieldError('login-username', 'ç”¨æˆ¶åè‡³å°‘3å€‹å­—ç¬¦');
          isValid = false;
        }
        
        // é©—è­‰å¯†ç¢¼
        if (!password) {
          showFieldError('login-password', 'è«‹è¼¸å…¥å¯†ç¢¼');
          isValid = false;
        } else if (password.length < 6) {
          showFieldError('login-password', 'å¯†ç¢¼è‡³å°‘6å€‹å­—ç¬¦');
          isValid = false;
        }
        
        return isValid;
      }
      
      function validateRegisterForm() {
        let isValid = true;
        
        const username = document.getElementById('register-username').value.trim();
        const email = document.getElementById('register-email').value.trim();
        const password = document.getElementById('register-password').value;
        const confirmPassword = document.getElementById('register-confirm-password').value;
        
        // æ¸…é™¤ä¹‹å‰çš„éŒ¯èª¤
        hideFieldError('register-username');
        hideFieldError('register-email');
        hideFieldError('register-password');
        hideFieldError('register-confirm-password');
        hideAuthError();
        
        // é©—è­‰ç”¨æˆ¶å
        if (!username) {
          showFieldError('register-username', 'è«‹è¼¸å…¥ç”¨æˆ¶å');
          isValid = false;
        } else if (!validateUsername(username)) {
          showFieldError('register-username', 'ç”¨æˆ¶åï¼š3-20å€‹å­—ç¬¦ï¼Œåªèƒ½åŒ…å«å­—æ¯ã€æ•¸å­—ã€ä¸‹åŠƒç·š');
          isValid = false;
        }
        
        // é©—è­‰éƒµä»¶
        if (!email) {
          showFieldError('register-email', 'è«‹è¼¸å…¥é›»å­éƒµä»¶');
          isValid = false;
        } else if (!validateEmail(email)) {
          showFieldError('register-email', 'è«‹è¼¸å…¥æœ‰æ•ˆçš„é›»å­éƒµä»¶åœ°å€');
          isValid = false;
        }
        
        // Step 25: é©—è­‰å¯†ç¢¼ï¼ˆä½¿ç”¨å¢å¼·ç‰ˆæª¢æŸ¥ï¼‰
        if (!password) {
          showFieldError('register-password', 'è«‹è¼¸å…¥å¯†ç¢¼');
          isValid = false;
        } else {
          const passwordStrength = getPasswordStrength(password);
          if (!passwordStrength.isValid) {
            showFieldError('register-password', 'å¯†ç¢¼å¿…é ˆè‡³å°‘8ä½ï¼ŒåŒ…å«å¤§å¯«å­—æ¯ã€å°å¯«å­—æ¯ã€æ•¸å­—ä¸”ç„¡ç©ºæ ¼');
            isValid = false;
          }
        }
        
        // é©—è­‰ç¢ºèªå¯†ç¢¼
        if (!confirmPassword) {
          showFieldError('register-confirm-password', 'è«‹ç¢ºèªå¯†ç¢¼');
          isValid = false;
        } else if (password !== confirmPassword) {
          showFieldError('register-confirm-password', 'å…©æ¬¡è¼¸å…¥çš„å¯†ç¢¼ä¸ä¸€è‡´');
          isValid = false;
        }
        
        return isValid;
      }
      
      // åˆ‡æ›è¡¨å–®æ¨¡å¼
      function switchAuthMode(mode) {
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const title = document.getElementById('auth-title');
        
        if (mode === 'login') {
          loginForm.style.display = 'block';
          registerForm.style.display = 'none';
          title.textContent = 'ç™»éŒ„';
        } else {
          loginForm.style.display = 'none';
          registerForm.style.display = 'block';
          title.textContent = 'è¨»å†Š';
        }
        
        // æ¸…é™¤æ‰€æœ‰éŒ¯èª¤ä¿¡æ¯
        hideAuthError();
        hideFieldError('login-username');
        hideFieldError('login-password');
        hideFieldError('register-username');
        hideFieldError('register-email');
        hideFieldError('register-password');
        hideFieldError('register-confirm-password');
      }
      
      // è™•ç†ç™»éŒ„
      async function handleLogin(event) {
        event.preventDefault();
        
        if (!validateLoginForm()) {
          return;
        }
        
        const loginBtn = document.getElementById('login-submit-btn');
        const btnText = document.getElementById('login-btn-text');
        
        try {
          // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
          loginBtn.disabled = true;
          btnText.innerHTML = '<ion-spinner class="loading-spinner"></ion-spinner>ç™»éŒ„ä¸­...';
          
          const username = document.getElementById('login-username').value.trim();
          const password = document.getElementById('login-password').value;
          
          // èª¿ç”¨çœŸå¯¦APIï¼ˆå¸¶é‡è©¦æ©Ÿåˆ¶ï¼‰
          const response = await loginUser(username, password);
          
          // è™•ç†ç™»å…¥æˆåŠŸå›æ‡‰
          let user, token;
          
          if (response.user) {
            // å¦‚æœAPIè¿”å›å®Œæ•´ç”¨æˆ¶æ•¸æ“š
            user = response.user;
            token = response.token || response.access_token;
          } else {
            // å¦‚æœAPIåªè¿”å›åŸºæœ¬ä¿¡æ¯ï¼Œæ§‹å»ºç”¨æˆ¶å°è±¡
            user = {
              id: response.id || response.user_id || Date.now(),
              username: response.username || username,
              email: response.email || null,
              name: response.name || response.display_name || username,
              avatar: response.avatar || null,
              role: response.role || 'user',
              createdAt: response.created_at || new Date().toISOString()
            };
            token = response.token || response.access_token;
          }
          
          // ç™»éŒ„æˆåŠŸ
          currentUser = user;
          saveAuthSession(currentUser, token);
          
          // åˆå§‹åŒ–ç”¨æˆ¶æ•¸æ“š
          await initializeUserData();
          
          // æ›´æ–°UI
          updateUserUI();
          closeAuthModal();
          
          // æ¸…ç©ºè¡¨å–®
          document.getElementById('login-form').reset();
          
          // é¡¯ç¤ºæ­¡è¿æ¶ˆæ¯
          showSuccessMessage(`æ­¡è¿å›ä¾†ï¼Œ${getUserDisplayName()}ï¼`);
          
        } catch (error) {
          showAuthError(error.message);
        } finally {
          // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
          loginBtn.disabled = false;
          btnText.textContent = 'ç™»éŒ„';
        }
      }
      
      // è™•ç†è¨»å†Š
      async function handleRegister(event) {
        event.preventDefault();
        
        if (!validateRegisterForm()) {
          return;
        }
        
        const registerBtn = document.getElementById('register-submit-btn');
        const btnText = document.getElementById('register-btn-text');
        
        try {
          // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
          registerBtn.disabled = true;
          btnText.innerHTML = '<ion-spinner class="loading-spinner"></ion-spinner>è¨»å†Šä¸­...';
          
          const username = document.getElementById('register-username').value.trim();
          const email = document.getElementById('register-email').value.trim();
          const password = document.getElementById('register-password').value;
          
          // èª¿ç”¨çœŸå¯¦APIï¼ˆå¸¶é‡è©¦æ©Ÿåˆ¶ï¼‰
          const response = await signupUser(username, email, password);
          
          // è™•ç†è¨»å†ŠæˆåŠŸå›æ‡‰
          let user, token;
          
          if (response.user) {
            // å¦‚æœAPIè¿”å›å®Œæ•´ç”¨æˆ¶æ•¸æ“š
            user = response.user;
            token = response.token || response.access_token;
          } else {
            // å¦‚æœAPIåªè¿”å›åŸºæœ¬ä¿¡æ¯ï¼Œæ§‹å»ºç”¨æˆ¶å°è±¡
            user = {
              id: response.id || Date.now(),
              username: username,
              email: email,
              name: response.name || username,
              avatar: response.avatar || null,
              role: response.role || 'user',
              createdAt: response.created_at || new Date().toISOString()
            };
            token = response.token || response.access_token;
          }
          
          // è¨»å†ŠæˆåŠŸï¼Œä¿å­˜æœƒè©±
          currentUser = user;
          saveAuthSession(currentUser, token);
          
          // åˆå§‹åŒ–ç”¨æˆ¶æ•¸æ“š
          await initializeUserData();
          
          // æ›´æ–°UI
          updateUserUI();
          closeAuthModal();
          
          // æ¸…ç©ºè¡¨å–®
          document.getElementById('register-form').reset();
          
          // é¡¯ç¤ºæ­¡è¿æ¶ˆæ¯
          showSuccessMessage(`è¨»å†ŠæˆåŠŸï¼æ­¡è¿åŠ å…¥ï¼Œ${getUserDisplayName()}ï¼`);
          
        } catch (error) {
          showAuthError(error.message);
        } finally {
          // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
          registerBtn.disabled = false;
          btnText.textContent = 'è¨»å†Š';
        }
      }
      
      // æœƒè©±ç®¡ç†å‡½æ•¸
      function saveAuthSession(user, token = null) {
        const authData = {
          user: user,
          token: token,
          timestamp: Date.now(),
          expiresAt: Date.now() + CONFIG.SESSION_TIMEOUT
        };
        
        localStorage.setItem(CONFIG.AUTH_STORAGE_KEY, JSON.stringify(authData));
        localStorage.setItem(CONFIG.USER_STORAGE_KEY, JSON.stringify(user));
        
        console.log('æœƒè©±å·²ä¿å­˜:', authData);
      }
      
      function loadAuthSession() {
        try {
          const authData = localStorage.getItem(CONFIG.AUTH_STORAGE_KEY);
          if (!authData) return null;
          
          const session = JSON.parse(authData);
          
          // æª¢æŸ¥æœƒè©±æ˜¯å¦éæœŸ
          if (Date.now() > session.expiresAt) {
            clearAuthSession();
            return null;
          }
          
          return session;
        } catch (error) {
          console.error('è¼‰å…¥æœƒè©±å¤±æ•—:', error);
          clearAuthSession();
          return null;
        }
      }
      
      function clearAuthSession() {
        localStorage.removeItem(CONFIG.AUTH_STORAGE_KEY);
        localStorage.removeItem(CONFIG.USER_STORAGE_KEY);
        currentUser = null;
        console.log('æœƒè©±å·²æ¸…é™¤');
      }
      
      function isSessionValid() {
        const session = loadAuthSession();
        return session && Date.now() < session.expiresAt;
      }
      
      function refreshSession() {
        const session = loadAuthSession();
        if (session) {
          session.timestamp = Date.now();
          session.expiresAt = Date.now() + CONFIG.SESSION_TIMEOUT;
          localStorage.setItem(CONFIG.AUTH_STORAGE_KEY, JSON.stringify(session));
        }
      }
      
      // çœŸå¯¦APIç™»éŒ„å‡½æ•¸ - å¸¶é‡è©¦æ©Ÿåˆ¶
      async function loginUser(username, password, maxRetries = 3) {
        for (let attempt = 1; attempt <= maxRetries; attempt++) {
          try {
            console.log(`ç™»éŒ„å˜—è©¦ ${attempt}/${maxRetries}`);
            
            const response = await fetch('https://dae-mobile-assignment.hkit.cc/api/auth/login', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                username: username,
                password: password
              })
            });

            const data = await response.json();
            
            // æª¢æŸ¥æ˜¯å¦æ˜¯æ¸¬è©¦éŒ¯èª¤ï¼ˆå¯ä»¥é‡è©¦ï¼‰
            if (data.error && data.error.includes('Error injected for testing purposes')) {
              console.log(`æ”¶åˆ°æ¸¬è©¦éŒ¯èª¤ï¼Œç¬¬ ${attempt} æ¬¡å˜—è©¦å¤±æ•—ï¼Œæº–å‚™é‡è©¦...`);
              if (attempt < maxRetries) {
                // æŒ‡æ•¸é€€é¿å»¶é²
                const delay = Math.pow(2, attempt - 1) * 1000;
                console.log(`ç­‰å¾… ${delay}ms å¾Œé‡è©¦...`);
                await new Promise(resolve => setTimeout(resolve, delay));
                continue;
              }
            }
            
            // æª¢æŸ¥å…¶ä»–éŒ¯èª¤
            if (!response.ok || data.error) {
              throw new Error(data.message || data.error || `ç™»éŒ„å¤±æ•— (HTTP ${response.status})`);
            }

            console.log(`ç™»éŒ„æˆåŠŸï¼ç¬¬ ${attempt} æ¬¡å˜—è©¦`);
            return data;
            
          } catch (error) {
            console.error(`ç™»éŒ„APIéŒ¯èª¤ (å˜—è©¦ ${attempt}/${maxRetries}):`, error);
            
            // å¦‚æœæ˜¯æœ€å¾Œä¸€æ¬¡å˜—è©¦ï¼Œæ‹‹å‡ºéŒ¯èª¤
            if (attempt === maxRetries) {
              throw error;
            }
            
            // å¦å‰‡ç­‰å¾…å¾Œé‡è©¦
            const delay = Math.pow(2, attempt - 1) * 1000;
            console.log(`ç­‰å¾… ${delay}ms å¾Œé‡è©¦...`);
            await new Promise(resolve => setTimeout(resolve, delay));
          }
        }
      }

      // çœŸå¯¦APIè¨»å†Šå‡½æ•¸ - å¸¶é‡è©¦æ©Ÿåˆ¶
      async function signupUser(username, email, password, maxRetries = 3) {
        for (let attempt = 1; attempt <= maxRetries; attempt++) {
          try {
            console.log(`è¨»å†Šå˜—è©¦ ${attempt}/${maxRetries}`);
            
            const response = await fetch('https://dae-mobile-assignment.hkit.cc/api/auth/signup', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                username: username,
                email: email,
                password: password
              })
            });

            const data = await response.json();
            
            // æª¢æŸ¥æ˜¯å¦æ˜¯æ¸¬è©¦éŒ¯èª¤ï¼ˆå¯ä»¥é‡è©¦ï¼‰
            if (data.error && data.error.includes('Error injected for testing purposes')) {
              console.log(`æ”¶åˆ°æ¸¬è©¦éŒ¯èª¤ï¼Œç¬¬ ${attempt} æ¬¡å˜—è©¦å¤±æ•—ï¼Œæº–å‚™é‡è©¦...`);
              if (attempt < maxRetries) {
                // æŒ‡æ•¸é€€é¿å»¶é²
                const delay = Math.pow(2, attempt - 1) * 1000;
                console.log(`ç­‰å¾… ${delay}ms å¾Œé‡è©¦...`);
                await new Promise(resolve => setTimeout(resolve, delay));
                continue;
              }
            }
            
            // æª¢æŸ¥å…¶ä»–éŒ¯èª¤
            if (!response.ok || data.error) {
              throw new Error(data.message || data.error || `è¨»å†Šå¤±æ•— (HTTP ${response.status})`);
            }

            console.log(`è¨»å†ŠæˆåŠŸï¼ç¬¬ ${attempt} æ¬¡å˜—è©¦`);
            return data;
            
          } catch (error) {
            console.error(`è¨»å†ŠAPIéŒ¯èª¤ (å˜—è©¦ ${attempt}/${maxRetries}):`, error);
            
            // å¦‚æœæ˜¯æœ€å¾Œä¸€æ¬¡å˜—è©¦ï¼Œæ‹‹å‡ºéŒ¯èª¤
            if (attempt === maxRetries) {
              throw error;
            }
            
            // å¦å‰‡ç­‰å¾…å¾Œé‡è©¦
            const delay = Math.pow(2, attempt - 1) * 1000;
            console.log(`ç­‰å¾… ${delay}ms å¾Œé‡è©¦...`);
            await new Promise(resolve => setTimeout(resolve, delay));
          }
        }
      }

      // æ¨¡æ“¬ç™»éŒ„APIï¼ˆç¨å¾Œæ›¿æ›ï¼‰
      async function simulateLogin(username, password) {
        return new Promise((resolve, reject) => {
          setTimeout(() => {
            // æ¨¡æ“¬APIéŸ¿æ‡‰ - æ¼”ç¤ºç”¨æˆ¶ï¼šdemo/demo123
            if (username === 'demo' && password === 'demo123') {
              const user = { 
                id: 1,
                username, 
                email: 'demo@example.com',
                name: 'Demo User',
                avatar: null,
                role: 'user'
              };
              resolve({ 
                success: true, 
                user: user,
                token: 'demo_token_' + Date.now()
              });
            } else if (username === 'admin' && password === 'admin123') {
              const user = { 
                id: 2,
                username, 
                email: 'admin@example.com',
                name: 'Admin User',
                avatar: null,
                role: 'admin'
              };
              resolve({ 
                success: true, 
                user: user,
                token: 'admin_token_' + Date.now()
              });
            } else {
              reject(new Error('ç”¨æˆ¶åæˆ–å¯†ç¢¼éŒ¯èª¤'));
            }
          }, CONFIG.LOGOUT_DELAY);
        });
      }
      
      // æ¨¡æ“¬è¨»å†ŠAPIï¼ˆç¨å¾Œæ›¿æ›ï¼‰
      async function simulateRegister(username, email, password) {
        return new Promise((resolve, reject) => {
          setTimeout(() => {
            // æ¨¡æ“¬è¨»å†Šé©—è­‰
            if (username === 'existing') {
              reject(new Error('ç”¨æˆ¶åå·²å­˜åœ¨'));
            } else if (email === 'existing@example.com') {
              reject(new Error('éƒµä»¶åœ°å€å·²è¢«è¨»å†Š'));
            } else {
              const user = {
                id: Date.now(), // ç°¡å–®çš„IDç”Ÿæˆ
                username,
                email,
                name: username,
                avatar: null,
                role: 'user',
                createdAt: new Date().toISOString()
              };
              resolve({ 
                success: true, 
                user: user,
                token: 'new_user_token_' + Date.now()
              });
            }
          }, CONFIG.BUTTON_FEEDBACK_DELAY);
        });
      }
      
      // ç”¨æˆ¶ä¿¡æ¯ç®¡ç†
      function updateUserProfile(updates) {
        if (currentUser) {
          currentUser = { ...currentUser, ...updates };
          localStorage.setItem(CONFIG.USER_STORAGE_KEY, JSON.stringify(currentUser));
          
          // æ›´æ–°æœƒè©±ä¸­çš„ç”¨æˆ¶ä¿¡æ¯
          const session = loadAuthSession();
          if (session) {
            session.user = currentUser;
            localStorage.setItem(CONFIG.AUTH_STORAGE_KEY, JSON.stringify(session));
          }
        }
      }
      
      function getUserDisplayName() {
        if (!currentUser) return 'è¨ªå®¢';
        return currentUser.name || currentUser.username || currentUser.email;
      }
      
      // æ›¸ç±¤ç®¡ç† - API æ”¶è—åŠŸèƒ½
      
      // æ·»åŠ æ”¶è— API èª¿ç”¨
      async function addBookmark(itemId, maxRetries = 3) {
        if (!currentUser) {
          throw new Error('è«‹å…ˆç™»éŒ„ä»¥ä½¿ç”¨æ”¶è—åŠŸèƒ½');
        }
        
        for (let attempt = 1; attempt <= maxRetries; attempt++) {
          try {
            console.log(`æ·»åŠ æ”¶è—å˜—è©¦ ${attempt}/${maxRetries} - Item ID: ${itemId}`);
            
            const session = loadAuthSession();
            const token = session ? session.token : null;
            
            const response = await fetch(`${CONFIG.API_BASE_URL}/bookmarks/${itemId}`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': token ? `Bearer ${token}` : ''
              },
              body: JSON.stringify({
                item_id: itemId
              })
            });

            const data = await response.json();
            
            // æª¢æŸ¥æ˜¯å¦æ˜¯æ¸¬è©¦éŒ¯èª¤ï¼ˆå¯ä»¥é‡è©¦ï¼‰
            if (data.error && data.error.includes('Error injected for testing purposes')) {
              console.log(`æ”¶åˆ°æ¸¬è©¦éŒ¯èª¤ï¼Œç¬¬ ${attempt} æ¬¡å˜—è©¦å¤±æ•—ï¼Œæº–å‚™é‡è©¦...`);
              if (attempt < maxRetries) {
                const delay = Math.pow(2, attempt - 1) * 1000;
                console.log(`ç­‰å¾… ${delay}ms å¾Œé‡è©¦...`);
                await new Promise(resolve => setTimeout(resolve, delay));
                continue;
              }
            }
            
            // æª¢æŸ¥å…¶ä»–éŒ¯èª¤
            if (!response.ok || data.error) {
              throw new Error(data.message || data.error || `æ·»åŠ æ”¶è—å¤±æ•— (HTTP ${response.status})`);
            }

            console.log(`æ”¶è—æ·»åŠ æˆåŠŸï¼ç¬¬ ${attempt} æ¬¡å˜—è©¦`);
            return data;
            
          } catch (error) {
            console.error(`æ·»åŠ æ”¶è—APIéŒ¯èª¤ (å˜—è©¦ ${attempt}/${maxRetries}):`, error);
            
            if (attempt === maxRetries) {
              throw error;
            }
            
            const delay = Math.pow(2, attempt - 1) * 1000;
            console.log(`ç­‰å¾… ${delay}ms å¾Œé‡è©¦...`);
            await new Promise(resolve => setTimeout(resolve, delay));
          }
        }
      }
      
      // ç§»é™¤æ”¶è— API èª¿ç”¨
      async function removeBookmark(itemId, maxRetries = 3) {
        if (!currentUser) {
          throw new Error('è«‹å…ˆç™»éŒ„ä»¥ä½¿ç”¨æ”¶è—åŠŸèƒ½');
        }
        
        for (let attempt = 1; attempt <= maxRetries; attempt++) {
          try {
            console.log(`ç§»é™¤æ”¶è—å˜—è©¦ ${attempt}/${maxRetries} - Item ID: ${itemId}`);
            
            const session = loadAuthSession();
            const token = session ? session.token : null;
            
            const response = await fetch(`${CONFIG.API_BASE_URL}/bookmarks/${itemId}`, {
              method: 'DELETE',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': token ? `Bearer ${token}` : ''
              }
            });

            const data = await response.json();
            
            // æª¢æŸ¥æ˜¯å¦æ˜¯æ¸¬è©¦éŒ¯èª¤ï¼ˆå¯ä»¥é‡è©¦ï¼‰
            if (data.error && data.error.includes('Error injected for testing purposes')) {
              console.log(`æ”¶åˆ°æ¸¬è©¦éŒ¯èª¤ï¼Œç¬¬ ${attempt} æ¬¡å˜—è©¦å¤±æ•—ï¼Œæº–å‚™é‡è©¦...`);
              if (attempt < maxRetries) {
                const delay = Math.pow(2, attempt - 1) * 1000;
                console.log(`ç­‰å¾… ${delay}ms å¾Œé‡è©¦...`);
                await new Promise(resolve => setTimeout(resolve, delay));
                continue;
              }
            }
            
            // æª¢æŸ¥å…¶ä»–éŒ¯èª¤
            if (!response.ok || data.error) {
              throw new Error(data.message || data.error || `ç§»é™¤æ”¶è—å¤±æ•— (HTTP ${response.status})`);
            }

            console.log(`æ”¶è—ç§»é™¤æˆåŠŸï¼ç¬¬ ${attempt} æ¬¡å˜—è©¦`);
            return data;
            
          } catch (error) {
            console.error(`ç§»é™¤æ”¶è—APIéŒ¯èª¤ (å˜—è©¦ ${attempt}/${maxRetries}):`, error);
            
            if (attempt === maxRetries) {
              throw error;
            }
            
            const delay = Math.pow(2, attempt - 1) * 1000;
            console.log(`ç­‰å¾… ${delay}ms å¾Œé‡è©¦...`);
            await new Promise(resolve => setTimeout(resolve, delay));
          }
        }
      }
      
      // ç²å–ç”¨æˆ¶æ”¶è—åˆ—è¡¨ API èª¿ç”¨
      async function fetchUserBookmarks(maxRetries = 3) {
        if (!currentUser) {
          console.log('ç”¨æˆ¶æœªç™»éŒ„ï¼Œç„¡æ³•ç²å–æ”¶è—åˆ—è¡¨');
          return [];
        }
        
        for (let attempt = 1; attempt <= maxRetries; attempt++) {
          try {
            console.log(`ç²å–æ”¶è—åˆ—è¡¨å˜—è©¦ ${attempt}/${maxRetries}`);
            
            const session = loadAuthSession();
            const token = session ? session.token : null;
            
            const response = await fetch(`${CONFIG.API_BASE_URL}/bookmarks`, {
              method: 'GET',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': token ? `Bearer ${token}` : ''
              }
            });

            const data = await response.json();
            
            // æª¢æŸ¥æ˜¯å¦æ˜¯æ¸¬è©¦éŒ¯èª¤ï¼ˆå¯ä»¥é‡è©¦ï¼‰
            if (data.error && data.error.includes('Error injected for testing purposes')) {
              console.log(`æ”¶åˆ°æ¸¬è©¦éŒ¯èª¤ï¼Œç¬¬ ${attempt} æ¬¡å˜—è©¦å¤±æ•—ï¼Œæº–å‚™é‡è©¦...`);
              if (attempt < maxRetries) {
                const delay = Math.pow(2, attempt - 1) * 1000;
                console.log(`ç­‰å¾… ${delay}ms å¾Œé‡è©¦...`);
                await new Promise(resolve => setTimeout(resolve, delay));
                continue;
              }
            }
            
            // æª¢æŸ¥å…¶ä»–éŒ¯èª¤
            if (!response.ok || data.error) {
              console.warn(`ç²å–æ”¶è—åˆ—è¡¨å¤±æ•—: ${data.message || data.error || `HTTP ${response.status}`}`);
              return []; // å¤±æ•—æ™‚è¿”å›ç©ºæ•¸çµ„
            }

            console.log(`æ”¶è—åˆ—è¡¨ç²å–æˆåŠŸï¼ç¬¬ ${attempt} æ¬¡å˜—è©¦`);
            return data.bookmarks || data || [];
            
          } catch (error) {
            console.error(`ç²å–æ”¶è—åˆ—è¡¨APIéŒ¯èª¤ (å˜—è©¦ ${attempt}/${maxRetries}):`, error);
            
            if (attempt === maxRetries) {
              console.warn('ç²å–æ”¶è—åˆ—è¡¨å¤±æ•—ï¼Œä½¿ç”¨æœ¬åœ°ç·©å­˜');
              return []; // æœ€çµ‚å¤±æ•—æ™‚è¿”å›ç©ºæ•¸çµ„
            }
            
            const delay = Math.pow(2, attempt - 1) * 1000;
            console.log(`ç­‰å¾… ${delay}ms å¾Œé‡è©¦...`);
            await new Promise(resolve => setTimeout(resolve, delay));
          }
        }
        
        return [];
      }
      
      // åˆå§‹åŒ–ç”¨æˆ¶æ•¸æ“šï¼ˆç™»éŒ„/è¨»å†ŠæˆåŠŸå¾Œèª¿ç”¨ï¼‰
      async function initializeUserData() {
        if (!currentUser) return;
        
        try {
          console.log('æ­£åœ¨åˆå§‹åŒ–ç”¨æˆ¶æ•¸æ“š...');
          
          // å…ˆåŠ è¼‰æœ¬åœ°æ”¶è—ä½œç‚ºå‚™ç”¨
          const localBookmarks = loadUserBookmarks();
          
          // å˜—è©¦å¾APIåŠ è¼‰æ”¶è—åˆ—è¡¨
          const apiBookmarks = await fetchUserBookmarks();
          
          if (apiBookmarks && apiBookmarks.length > 0) {
            console.log(`å¾APIåŠ è¼‰äº† ${apiBookmarks.length} å€‹æ”¶è—`);
            bookmarks = apiBookmarks;
            
            // å°‡APIæ•¸æ“šä¿å­˜åˆ°æœ¬åœ°ä½œç‚ºå‚™ä»½
            saveUserBookmarks(bookmarks);
          } else {
            console.log('APIæ²’æœ‰è¿”å›æ”¶è—æ•¸æ“šï¼Œä½¿ç”¨æœ¬åœ°æ”¶è—');
            bookmarks = localBookmarks;
          }
          
          // æ›´æ–°UI
          updateBookmarkUI();
          
        } catch (error) {
          console.error('åˆå§‹åŒ–ç”¨æˆ¶æ•¸æ“šå¤±æ•—:', error);
          
          // ä½¿ç”¨æœ¬åœ°æ”¶è—ä½œç‚ºå¾Œå‚™
          bookmarks = loadUserBookmarks();
          updateBookmarkUI();
        }
      }
      
      // æœ¬åœ°æ›¸ç±¤ç®¡ç†ï¼ˆä½œç‚ºAPIçš„å¾Œå‚™ï¼‰
      function loadUserBookmarks() {
        if (!currentUser) return [];
        
        try {
          const bookmarksData = localStorage.getItem(CONFIG.BOOKMARKS_KEY + '_' + currentUser.id);
          return bookmarksData ? JSON.parse(bookmarksData) : [];
        } catch (error) {
          console.error('è¼‰å…¥æ›¸ç±¤å¤±æ•—:', error);
          return [];
        }
      }
      
      function saveUserBookmarks(bookmarkList) {
        if (!currentUser) return;
        
        try {
          localStorage.setItem(CONFIG.BOOKMARKS_KEY + '_' + currentUser.id, JSON.stringify(bookmarkList));
          bookmarks = bookmarkList;
        } catch (error) {
          console.error('ä¿å­˜æ›¸ç±¤å¤±æ•—:', error);
        }
      }
      
      // æ”¶è—åˆ‡æ›åŠŸèƒ½ï¼ˆä½¿ç”¨çœŸå¯¦APIï¼‰
      async function toggleBookmark(itemId) {
        if (!currentUser) {
          showAuthError('è«‹å…ˆç™»éŒ„ä»¥ä½¿ç”¨æ”¶è—åŠŸèƒ½');
          return false;
        }
        
        const bookmarkIndex = bookmarks.findIndex(b => parseInt(b.id) === parseInt(itemId));
        const isCurrentlyBookmarked = bookmarkIndex > -1;
        
        // æ›´æ–°UIç‹€æ…‹ï¼ˆæ¨‚è§€æ›´æ–°ï¼‰
        const bookmarkBtn = document.querySelector(`[data-item-id="${itemId}"] .bookmark-btn`);
        if (bookmarkBtn) {
          bookmarkBtn.disabled = true;
          bookmarkBtn.innerHTML = '<ion-spinner name="crescent"></ion-spinner>';
        }
        
        try {
          if (isCurrentlyBookmarked) {
            // ç§»é™¤æ”¶è—
            await removeBookmark(itemId);
            
            // å¾æœ¬åœ°åˆ—è¡¨ç§»é™¤
            bookmarks.splice(bookmarkIndex, 1);
            showSuccessMessage('å·²ç§»é™¤æ”¶è—');
          } else {
            // æ·»åŠ æ”¶è—
            await addBookmark(itemId);
            
            // æ·»åŠ åˆ°æœ¬åœ°åˆ—è¡¨
            const item = allItems.find(i => parseInt(i.id) === parseInt(itemId));
            if (item) {
              bookmarks.push({
                id: parseInt(itemId), // ç¢ºä¿ ID æ˜¯æ•¸å­—
                title: item.title || item.sanskrit_name || 'ç„¡æ¨™é¡Œ',
                addedAt: new Date().toISOString()
              });
              console.log('âœ… å·²æ·»åŠ æ›¸ç±¤:', {id: parseInt(itemId), title: item.title || item.sanskrit_name});
            } else {
              console.error('âŒ æ‰¾ä¸åˆ°è¦æ”¶è—çš„é …ç›®:', itemId, 'åœ¨', allItems.length, 'å€‹é …ç›®ä¸­');
            }
            showSuccessMessage('å·²åŠ å…¥æ”¶è—');
          }
          
          // ä¿å­˜åˆ°æœ¬åœ°å­˜å„²ï¼ˆä½œç‚ºå‚™ä»½ï¼‰
          saveUserBookmarks(bookmarks);
          updateBookmarkUI();
          return true;
          
        } catch (error) {
          console.error('æ”¶è—æ“ä½œå¤±æ•—:', error);
          showAuthError(`æ”¶è—æ“ä½œå¤±æ•—: ${error.message}`);
          
          // æ¢å¾©UIç‹€æ…‹
          updateBookmarkUI();
          return false;
        }
      }

      // UIæ›´æ–°å‡½æ•¸
      function updateUserUI() {
        const authBtn = document.getElementById('auth-btn');
        
        if (currentUser) {
          authBtn.textContent = `${getUserDisplayName()} â–¼`;
          authBtn.style.maxWidth = '150px';
          authBtn.style.overflow = 'hidden';
          authBtn.style.textOverflow = 'ellipsis';
          
          // é¡¯ç¤ºç”¨æˆ¶ç›¸é—œåŠŸèƒ½
          updateBookmarkUI();
        } else {
          authBtn.textContent = 'ç™»å…¥';
          authBtn.style.maxWidth = 'none';
          authBtn.style.overflow = 'visible';
          authBtn.style.textOverflow = 'unset';
          
          // ç™»å‡ºæ™‚ä¹Ÿè¦æ›´æ–°æ”¶è—æŒ‰éˆ•ç‹€æ…‹
          updateBookmarkUI();
        }
      }
      
      function updateBookmarkUI() {
        // æ›´æ–°æ‰€æœ‰æ”¶è—æŒ‰éˆ•ç‹€æ…‹
        const bookmarkBtns = document.querySelectorAll('.bookmark-btn');
        bookmarkBtns.forEach(btn => {
          const itemId = parseInt(btn.getAttribute('data-item-id'));
          const isBookmarked = bookmarks.some(b => parseInt(b.id) === itemId);
          
          // é‡ç½®æŒ‰éˆ•ç‹€æ…‹
          btn.disabled = false;
          
          if (isBookmarked) {
            // å·²æ”¶è—ç‹€æ…‹
            btn.setAttribute('fill', 'solid');
            btn.setAttribute('color', 'danger');
            btn.innerHTML = '<ion-icon name="heart" slot="start"></ion-icon>å·²æ”¶è—';
          } else {
            // æœªæ”¶è—ç‹€æ…‹
            btn.setAttribute('fill', 'clear');
            btn.setAttribute('color', 'medium');
            btn.innerHTML = '<ion-icon name="heart-outline" slot="start"></ion-icon>æ”¶è—';
          }
        });
        
        console.log(`æ›´æ–°äº† ${bookmarkBtns.length} å€‹æ”¶è—æŒ‰éˆ•ï¼Œç•¶å‰æ”¶è—æ•¸: ${bookmarks.length}`);
        
        // ğŸ”¥ ä¿®å¾©ï¼šç§»é™¤éè¿´èª¿ç”¨ï¼Œé¿å…ç„¡é™å¾ªç’°
        // æ”¶è—éæ¿¾çš„æ‡‰ç”¨æ‡‰è©²ç”±èª¿ç”¨æ–¹æ§åˆ¶ï¼Œè€Œä¸æ˜¯åœ¨UIæ›´æ–°æ™‚è‡ªå‹•è§¸ç™¼
      }
      
      function showSuccessMessage(message) {
        // å‰µå»ºæˆåŠŸæç¤º
        const toast = document.createElement('ion-toast');
        toast.message = message;
        toast.duration = 3000;
        toast.color = 'success';
        toast.position = 'top';
        
        document.body.appendChild(toast);
        toast.present();
        
        // è‡ªå‹•ç§»é™¤å…ƒç´ 
        setTimeout(() => {
          if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
          }
        }, CONFIG.TOAST_DISPLAY_DELAY);
      }
      
      function confirmLogout() {
        // æ¸…é™¤æœƒè©±
        clearAuthSession();
        
        // æ¸…ç©ºæ›¸ç±¤
        bookmarks = [];
        
        // æ›´æ–°UI
        updateUserUI();
        
        // é‡è¦ï¼šæ›´æ–°æ”¶è—æŒ‰éˆ•ç‹€æ…‹ï¼Œç§»é™¤æ‰€æœ‰æ”¶è—æ¨™ç¤º
        updateBookmarkUI();
        
        closeLogoutModal();
        
        // é¡¯ç¤ºç™»å‡ºæ¶ˆæ¯
        showSuccessMessage('å·²æˆåŠŸç™»å‡º');
      }
      
      // åˆå§‹åŒ–æ‡‰ç”¨
      document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM å·²åŠ è¼‰ï¼Œé–‹å§‹åˆå§‹åŒ–...');
        
        // æª¢æŸ¥ä¸¦è¼‰å…¥ç¾æœ‰æœƒè©±
        const existingSession = loadAuthSession();
        if (existingSession && isSessionValid()) {
          currentUser = existingSession.user;
          updateUserUI();
          console.log('å·²è¼‰å…¥ç¾æœ‰æœƒè©±:', currentUser);
          
          // ç•°æ­¥åˆå§‹åŒ–ç”¨æˆ¶æ•¸æ“š
          initializeUserData().catch(error => {
            console.error('åˆå§‹åŒ–ç”¨æˆ¶æ•¸æ“šå¤±æ•—:', error);
          });
        }
        
        // è¨­ç½®æœƒè©±è‡ªå‹•åˆ·æ–°ï¼ˆæ¯5åˆ†é˜ï¼‰
        setInterval(() => {
          if (currentUser && isSessionValid()) {
            refreshSession();
          }
        }, CONFIG.AUTO_LOGOUT_INTERVAL);
        
        // å¼·åˆ¶è¨­ç½® itemsPerPage ç‚º 5 (é¿å…åˆå§‹åŒ–å•é¡Œ)
        itemsPerPage = 5;
        console.log('ğŸ”§ å¼·åˆ¶è¨­ç½® itemsPerPage =', itemsPerPage);
        
        // è¨­ç½®äº‹ä»¶ç›£è½å™¨ - Step 20: APIæœç´¢, Step 22: æ’åºåŠŸèƒ½
        document.getElementById('search-bar').addEventListener('ionInput', performAPISearch);
        document.getElementById('category-select').addEventListener('ionChange', performAPISearch);
        document.getElementById('sort-select').addEventListener('ionChange', performAPISearch);
        document.getElementById('order-select').addEventListener('ionChange', performAPISearch);
        
        // è¨­ç½®æ”¶è—éæ¿¾æŒ‰éˆ•äº‹ä»¶ç›£è½å™¨
        const bookmarkFilterBtn = document.getElementById('bookmark-filter-btn');
        if (bookmarkFilterBtn) {
          bookmarkFilterBtn.addEventListener('click', toggleBookmarkFilter);
          console.log('âœ… æ”¶è—éæ¿¾æŒ‰éˆ•äº‹ä»¶ç›£è½å™¨å·²è¨­ç½®');
        } else {
          console.error('âŒ æ‰¾ä¸åˆ°æ”¶è—éæ¿¾æŒ‰éˆ•');
        }
        
        document.getElementById('auth-btn').addEventListener('click', () => {
          if (currentUser) {
            document.getElementById('logout-confirm-modal').present();
          } else {
            openAuthModal();
          }
        });
        
        // è¨­ç½®èªè­‰è¡¨å–®äº‹ä»¶ç›£è½å™¨
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const switchToRegister = document.getElementById('switch-to-register');
        const switchToLogin = document.getElementById('switch-to-login');
        
        // è¡¨å–®æäº¤äº‹ä»¶
        if (loginForm) {
          loginForm.addEventListener('submit', handleLogin);
        }
        
        if (registerForm) {
          registerForm.addEventListener('submit', handleRegister);
        }
        
        // è¡¨å–®åˆ‡æ›äº‹ä»¶
        if (switchToRegister) {
          switchToRegister.addEventListener('click', () => switchAuthMode('register'));
        }
        
        if (switchToLogin) {
          switchToLogin.addEventListener('click', () => switchAuthMode('login'));
        }
        
        // è¨­ç½®è¼¸å…¥æ¡†èšç„¦æ•ˆæœ
        const allInputs = document.querySelectorAll('#auth-form-container ion-input');
        allInputs.forEach(input => {
          const item = input.closest('ion-item');
          
          // æ·»åŠ èšç„¦æ•ˆæœ
          input.addEventListener('ionFocus', () => {
            item.classList.add('item-has-focus');
            // æ¸…é™¤ä½”ä½ç¬¦ï¼ˆé€šéè¨­ç½®ç‚ºç©ºï¼‰
            const placeholder = input.getAttribute('placeholder');
            if (placeholder) {
              input.setAttribute('data-original-placeholder', placeholder);
              input.setAttribute('placeholder', '');
            }
          });
          
          // ç§»é™¤èšç„¦æ•ˆæœ
          input.addEventListener('ionBlur', () => {
            item.classList.remove('item-has-focus');
            // å¦‚æœè¼¸å…¥æ¡†ç‚ºç©ºï¼Œæ¢å¾©ä½”ä½ç¬¦
            const value = input.value?.trim();
            if (!value) {
              const originalPlaceholder = input.getAttribute('data-original-placeholder');
              if (originalPlaceholder) {
                input.setAttribute('placeholder', originalPlaceholder);
              }
            }
          });
        });
        
        // å¯¦æ™‚é©—è­‰äº‹ä»¶
        const loginUsername = document.getElementById('login-username');
        if (loginUsername) {
          loginUsername.addEventListener('ionBlur', () => {
            const value = loginUsername.value.trim();
            if (value && value.length < 3) {
              showFieldError('login-username', 'ç”¨æˆ¶åè‡³å°‘3å€‹å­—ç¬¦');
            } else {
              hideFieldError('login-username');
            }
          });
        }
        
        const registerEmail = document.getElementById('register-email');
        if (registerEmail) {
          registerEmail.addEventListener('ionBlur', () => {
            const value = registerEmail.value.trim();
            if (value && !validateEmail(value)) {
              showFieldError('register-email', 'è«‹è¼¸å…¥æœ‰æ•ˆçš„é›»å­éƒµä»¶åœ°å€');
            } else {
              hideFieldError('register-email');
            }
          });
        }
        
        const registerPassword = document.getElementById('register-password');
        if (registerPassword) {
          registerPassword.addEventListener('ionInput', () => {
            const value = registerPassword.value;
            
            // Step 25: å¯¦æ™‚å¯†ç¢¼å¼·åº¦æª¢æŸ¥
            updatePasswordStrength(value);
            
            if (value) {
              const strength = getPasswordStrength(value);
              if (!strength.isValid) {
                showFieldError('register-password', 'å¯†ç¢¼éœ€è‡³å°‘8ä½ï¼ŒåŒ…å«å¤§å¯«ã€å°å¯«å­—æ¯å’Œæ•¸å­—');
              } else {
                hideFieldError('register-password');
              }
            }
          });
        }
        
        // Step 7: Load More Buttonæ¨¡å¼ - ä¸éœ€è¦ç„¡é™æ»¾å‹•è¨­ç½®
        console.log('âœ… Step 7 Load More Button æ¨¡å¼å·²å•Ÿç”¨');
        
        // é–‹å§‹è¼‰å…¥æ•¸æ“š
        loadData();
      });
    </script>
  </body>
</html>