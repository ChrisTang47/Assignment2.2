<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ç‘œä¼½å‹•ä½œæ‡‰ç”¨ - Assignment 2.2</title>
    <script
      type="module"
      src="https://cdn.jsdelivr.net/npm/@ionic/core/dist/ionic/ionic.esm.js"
    ></script>
    <script
      nomodule
      src="https://cdn.jsdelivr.net/npm/@ionic/core/dist/ionic/ionic.js"
    ></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@ionic/core/css/ionic.bundle.css"
    />
    
    <style>
      /* èˆ‡åŸç‰ˆç›¸åŒçš„æ¨£å¼ */
      .item-image {
        width: 100%;
        max-width: 300px;
        height: auto;
        border-radius: 8px;
        margin-bottom: 10px;
      }
      
      .video-thumbnail {
        position: relative;
        display: inline-block;
        cursor: pointer;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        transition: transform 0.2s ease;
      }
      
      .video-thumbnail:hover {
        transform: scale(1.02);
      }
      
      .poses-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        padding: 16px;
      }
      
      .pose-card {
        flex: 1 1 300px;
        min-width: 280px;
      }
      
      .filter-container {
        padding: 16px;
        background: #f8f9fa;
        border-bottom: 1px solid #e0e0e0;
      }
      
      .filter-row {
        display: flex;
        gap: 16px;
        align-items: center;
        flex-wrap: wrap;
      }
      
      .filter-item {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }
      
      .filter-item label {
        font-size: 14px;
        font-weight: 500;
        color: #666;
      }
      
      @media (max-width: 768px) {
        .filter-row {
          flex-direction: column;
          align-items: stretch;
        }
        
        .filter-item {
          width: 100%;
        }
      }
      
      /* èªè­‰è¡¨å–®æ¨£å¼ */
      .form-group {
        margin-bottom: 20px;
      }
      
      /* è‡ªå®šç¾©è¼¸å…¥æ¡†æ¨£å¼ - ä¿®å¾©é‡ç–Šå•é¡Œ */
      .custom-input-item {
        --padding-start: 16px;
        --inner-padding-end: 16px;
        --min-height: 60px;
        --background: transparent;
        --border-radius: 8px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        margin-bottom: 8px;
      }
      
      .custom-input-item:focus-within {
        border-color: var(--ion-color-primary);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }
      
      .custom-input-item ion-label {
        font-size: 12px;
        font-weight: 500;
        color: #6b7280;
        margin-bottom: 4px;
        position: static !important;
        transform: none !important;
      }
      
      .custom-input-item ion-input {
        --padding-top: 8px;
        --padding-bottom: 8px;
        --padding-start: 0px;
        font-size: 16px;
        line-height: 1.5;
      }
      
      .custom-input-item ion-input input {
        padding-left: 0 !important;
      }
      
      /* ä½”ä½ç¬¦æ¨£å¼ */
      .custom-input-item ion-input::part(native) {
        color: #374151;
      }
      
      .custom-input-item ion-input::part(native)::placeholder {
        color: #9ca3af;
        opacity: 1;
      }
      
      /* ç•¶è¼¸å…¥æ¡†ç²å¾—ç„¦é»æ™‚éš±è—ä½”ä½ç¬¦ */
      .custom-input-item:focus-within ion-input::part(native)::placeholder {
        opacity: 0.3;
      }
      
      .error-message {
        color: #dc3545;
        font-size: 12px;
        margin-top: 5px;
        margin-left: 16px;
        display: none;
      }
      
      .error-message.show {
        display: block;
      }
      
      .password-requirements {
        margin-top: 5px;
        margin-left: 16px;
        color: #6c757d;
      }
      
      .form-actions {
        margin: 24px 0;
      }
      
      .form-switch {
        text-align: center;
        margin-top: 16px;
      }
      
      .auth-error {
        margin: 16px 0;
        padding: 12px;
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        border-radius: 8px;
        color: #721c24;
      }
      
      .auth-error.show {
        display: block !important;
      }
      
      .loading-spinner {
        width: 16px;
        height: 16px;
        margin-right: 8px;
      }
      
      .password-strength {
        margin-top: 5px;
        margin-left: 16px;
      }
      
      .password-strength-bar {
        height: 4px;
        background: #e9ecef;
        border-radius: 2px;
        margin-top: 4px;
        overflow: hidden;
      }
      
      .password-strength-fill {
        height: 100%;
        transition: width 0.3s ease, background-color 0.3s ease;
      }
      
      .strength-weak { background-color: #dc3545; }
      .strength-medium { background-color: #ffc107; }
      .strength-strong { background-color: #28a745; }
      
      /* è¼¸å…¥æ¡†èšç„¦æ•ˆæœ */
      .form-group ion-item {
        --border-radius: 8px;
        --background: #f8f9fa;
        margin-bottom: 8px;
        transition: all 0.3s ease;
      }
      
      .form-group ion-item.item-has-focus {
        --background: #ffffff;
        --border-color: #007bff;
        box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
      }
      
      .form-group ion-input {
        --placeholder-color: #6c757d;
        --color: #212529;
      }
      
      /* æµ®å‹•æ¨™ç±¤å‹•ç•« */
      .form-group ion-label {
        transition: all 0.3s ease;
      }
    </style>
  </head>
  <body>
    <ion-app>
      <!-- Header -->
      <ion-header>
        <ion-toolbar>
          <ion-title>ç‘œä¼½å‹•ä½œæ‡‰ç”¨</ion-title>
          <ion-buttons slot="end">
            <ion-button id="auth-btn">ç™»å…¥</ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>

      <!-- Content -->
      <ion-content>
        <!-- æœç´¢å’Œç¯©é¸å€åŸŸ -->
        <div class="filter-container">
          <div class="filter-row">
            <div class="filter-item" style="flex: 2;">
              <label>æœç´¢ç‘œä¼½å‹•ä½œ</label>
              <ion-searchbar id="search-bar" placeholder="æœç´¢å‹•ä½œåç¨±ã€æè¿°æˆ–å¥½è™•..."></ion-searchbar>
            </div>
            
            <div class="filter-item">
              <label>åˆ†é¡ç¯©é¸</label>
              <ion-select id="category-select" placeholder="æ‰€æœ‰åˆ†é¡">
                <ion-select-option value="">æ‰€æœ‰åˆ†é¡</ion-select-option>
                <ion-select-option value="ç«™å§¿å¼">ç«™å§¿å¼</ion-select-option>
                <ion-select-option value="åå§¿å¼">åå§¿å¼</ion-select-option>
                <ion-select-option value="å¹³è¡¡å¼">å¹³è¡¡å¼</ion-select-option>
                <ion-select-option value="å¾Œå½å¼">å¾Œå½å¼</ion-select-option>
                <ion-select-option value="å‰å½å¼">å‰å½å¼</ion-select-option>
                <ion-select-option value="æ‰­è½‰å¼">æ‰­è½‰å¼</ion-select-option>
                <ion-select-option value="å€’ç«‹å¼">å€’ç«‹å¼</ion-select-option>
                <ion-select-option value="ä¼‘æ¯å¼">ä¼‘æ¯å¼</ion-select-option>
                <ion-select-option value="é–‹é«–å¼">é–‹é«–å¼</ion-select-option>
              </ion-select>
            </div>
            
            <!-- Step 22: æ’åºåŠŸèƒ½ -->
            <div class="filter-item">
              <label>æ’åºæ–¹å¼</label>
              <ion-select id="sort-select" placeholder="é è¨­æ’åº">
                <ion-select-option value="">é è¨­æ’åº</ion-select-option>
                <ion-select-option value="name">æŒ‰åç¨±æ’åº</ion-select-option>
                <ion-select-option value="difficulty">æŒ‰é›£åº¦æ’åº</ion-select-option>
                <ion-select-option value="duration_minutes">æŒ‰æ™‚é•·æ’åº</ion-select-option>
                <ion-select-option value="category">æŒ‰åˆ†é¡æ’åº</ion-select-option>
              </ion-select>
            </div>
            
            <div class="filter-item">
              <label>æ’åºé †åº</label>
              <ion-select id="order-select" value="asc">
                <ion-select-option value="asc">å‡åº (A-Z, 1-9)</ion-select-option>
                <ion-select-option value="desc">é™åº (Z-A, 9-1)</ion-select-option>
              </ion-select>
            </div>
            
            <!-- Step 23: åªé¡¯ç¤ºå·²æ”¶è—é …ç›®éæ¿¾ -->
            <div class="filter-item">
              <label>æ”¶è—éæ¿¾</label>
              <ion-button id="bookmark-filter-btn" fill="outline" color="primary" onclick="toggleBookmarkFilter()">
                <ion-icon name="heart-outline"></ion-icon>
                é¡¯ç¤ºå…¨éƒ¨
              </ion-button>
            </div>
            
            <div class="filter-item">
              <label>æ¯é é¡¯ç¤º</label>
              <ion-select id="limit-select" value="10">
                <ion-select-option value="5">5 é …</ion-select-option>
                <ion-select-option value="10">10 é …</ion-select-option>
                <ion-select-option value="20">20 é …</ion-select-option>
                <ion-select-option value="50">50 é …</ion-select-option>
              </ion-select>
            </div>
          </div>
        </div>

        <!-- è¼‰å…¥ç‹€æ…‹ -->
        <div id="loading-container" style="text-align: center; padding: 40px;">
          <ion-spinner name="crescent"></ion-spinner>
          <p id="loading-message">è¼‰å…¥ç‘œä¼½å‹•ä½œä¸­...</p>
        </div>
        
        <!-- éŒ¯èª¤ç‹€æ…‹ -->
        <div id="error-container" style="display: none; text-align: center; padding: 40px;">
          <p id="error-message">è¼‰å…¥å¤±æ•—</p>
          <ion-button id="retry-btn" onclick="loadData()">é‡è©¦</ion-button>
        </div>
        
        <!-- æ•¸æ“šé¡¯ç¤ºå€åŸŸ -->
        <div id="poses-list" style="display: none;">
          <!-- ç‘œä¼½å‹•ä½œå¡ç‰‡å°‡åœ¨é€™è£¡é¡¯ç¤º -->
        </div>
        
        <!-- åˆ†é ä¿¡æ¯å’Œè¼‰å…¥æ›´å¤š -->
        <div id="pagination-container" style="display: none; text-align: center; padding: 20px;">
          <p id="pagination-info">é¡¯ç¤ºç¬¬ 1-10 é …ï¼Œå…± 50 é …</p>
          
          <!-- Step 24: å‚³çµ±è¼‰å…¥æ›´å¤šæŒ‰éˆ•ï¼ˆå¯é¸ï¼‰ -->
          <ion-button id="load-more-btn" fill="outline" onclick="loadMoreData()" style="display: none;">è¼‰å…¥æ›´å¤š</ion-button>
          
          <!-- Step 24: ç„¡é™æ»¾å‹•è¼‰å…¥æŒ‡ç¤ºå™¨ -->
          <div id="infinite-scroll-loading" style="display: none; padding: 20px;">
            <ion-spinner name="crescent" style="margin-right: 10px;"></ion-spinner>
            <span>æ­£åœ¨è¼‰å…¥æ›´å¤šç‘œä¼½å‹•ä½œ...</span>
          </div>
          
          <div id="load-more-error" style="display: none; color: red; margin-top: 10px;">è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡è©¦</div>
          <div id="no-more-data" style="display: none; color: #666; margin-top: 10px;">æ²’æœ‰æ›´å¤šæ•¸æ“šäº†</div>
        </div>
      </ion-content>

      <!-- ç™»å…¥/è¨»å†Šæ¨¡æ…‹æ¡† -->
      <ion-modal id="auth-modal">
        <ion-header>
          <ion-toolbar>
            <ion-title id="auth-title">ç™»å…¥</ion-title>
            <ion-buttons slot="end">
              <ion-button onclick="closeAuthModal()">
                <ion-icon name="close"></ion-icon>
              </ion-button>
            </ion-buttons>
          </ion-toolbar>
        </ion-header>
        
        <ion-content class="ion-padding">
          <!-- èªè­‰è¡¨å–®å®¹å™¨ -->
          <div id="auth-form-container">
            <!-- ç™»éŒ„è¡¨å–® -->
            <form id="login-form" style="display: block;">
              <div class="form-group">
                <ion-item lines="none" class="custom-input-item">
                  <ion-label position="stacked">ç”¨æˆ¶åæˆ–éƒµä»¶</ion-label>
                  <ion-input 
                    id="login-username" 
                    type="text" 
                    placeholder="è«‹è¼¸å…¥ç”¨æˆ¶åæˆ–éƒµä»¶"
                    required 
                    clearInput="true"
                    autocomplete="username">
                  </ion-input>
                </ion-item>
                <div id="login-username-error" class="error-message"></div>
              </div>
              
              <div class="form-group">
                <ion-item lines="none" class="custom-input-item">
                  <ion-label position="stacked">å¯†ç¢¼</ion-label>
                  <ion-input 
                    id="login-password" 
                    type="password" 
                    placeholder="è«‹è¼¸å…¥å¯†ç¢¼"
                    required 
                    clearInput="true"
                    autocomplete="current-password">
                  </ion-input>
                </ion-item>
                <div id="login-password-error" class="error-message"></div>
              </div>
              
              <div class="form-actions">
                <ion-button 
                  id="login-submit-btn" 
                  expand="block" 
                  type="submit"
                  color="primary">
                  <ion-icon name="log-in" slot="start"></ion-icon>
                  <span id="login-btn-text">ç™»éŒ„</span>
                </ion-button>
              </div>
              
              <div class="form-switch">
                <ion-button 
                  id="switch-to-register" 
                  fill="clear" 
                  expand="block">
                  é‚„æ²’æœ‰å¸³è™Ÿï¼Ÿé»æ“Šè¨»å†Š
                </ion-button>
              </div>
            </form>
            
            <!-- è¨»å†Šè¡¨å–® -->
            <form id="register-form" style="display: none;">
              <div class="form-group">
                <ion-item lines="none" class="custom-input-item">
                  <ion-label position="stacked">ç”¨æˆ¶å</ion-label>
                  <ion-input 
                    id="register-username" 
                    type="text" 
                    placeholder="è«‹è¼¸å…¥ç”¨æˆ¶åï¼ˆ3-20å€‹å­—ç¬¦ï¼‰"
                    required 
                    clearInput="true"
                    autocomplete="username">
                  </ion-input>
                </ion-item>
                <div id="register-username-error" class="error-message"></div>
              </div>
              
              <div class="form-group">
                <ion-item lines="none" class="custom-input-item">
                  <ion-label position="stacked">é›»å­éƒµä»¶</ion-label>
                  <ion-input 
                    id="register-email" 
                    type="email" 
                    placeholder="è«‹è¼¸å…¥é›»å­éƒµä»¶åœ°å€"
                    required 
                    clearInput="true"
                    autocomplete="email">
                  </ion-input>
                </ion-item>
                <div id="register-email-error" class="error-message"></div>
              </div>
              
              <div class="form-group">
                <ion-item lines="none" class="custom-input-item">
                  <ion-label position="stacked">å¯†ç¢¼</ion-label>
                  <ion-input 
                    id="register-password" 
                    type="password" 
                    placeholder="è«‹è¼¸å…¥å¯†ç¢¼ï¼ˆè‡³å°‘8å€‹å­—ç¬¦ï¼‰"
                    required 
                    clearInput="true"
                    autocomplete="new-password">
                  </ion-input>
                </ion-item>
                <div id="register-password-error" class="error-message"></div>
                
                <!-- Step 25: å¯†ç¢¼å¼·åº¦æŒ‡ç¤ºå™¨ -->
                <div id="password-strength-container" style="margin-top: 10px; display: none;">
                  <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                    <span style="font-size: 14px; font-weight: 500;">å¯†ç¢¼å¼·åº¦:</span>
                    <div id="password-strength-bar" style="flex: 1; height: 6px; background: #e0e0e0; border-radius: 3px; overflow: hidden;">
                      <div id="password-strength-fill" style="height: 100%; width: 0%; transition: width 0.3s, background-color 0.3s;"></div>
                    </div>
                    <span id="password-strength-text" style="font-size: 12px; font-weight: 500;">å¼±</span>
                  </div>
                  <div id="password-requirements-checklist" style="font-size: 12px; color: #666;">
                    <div id="req-length">âœ— è‡³å°‘8å€‹å­—ç¬¦</div>
                    <div id="req-lowercase">âœ— åŒ…å«å°å¯«å­—æ¯</div>
                    <div id="req-uppercase">âœ— åŒ…å«å¤§å¯«å­—æ¯</div>
                    <div id="req-numbers">âœ— åŒ…å«æ•¸å­—</div>
                    <div id="req-special">â—‹ åŒ…å«ç‰¹æ®Šå­—ç¬¦ (å¯é¸)</div>
                  </div>
                </div>
                
                <div class="password-requirements">
                  <small>è«‹è¼¸å…¥ç¬¦åˆå®‰å…¨è¦æ±‚çš„å¯†ç¢¼</small>
                </div>
              </div>
              
              <div class="form-group">
                <ion-item lines="none" class="custom-input-item">
                  <ion-label position="stacked">ç¢ºèªå¯†ç¢¼</ion-label>
                  <ion-input 
                    id="register-confirm-password" 
                    type="password" 
                    placeholder="è«‹å†æ¬¡è¼¸å…¥å¯†ç¢¼"
                    required 
                    clearInput="true"
                    autocomplete="new-password">
                  </ion-input>
                </ion-item>
                <div id="register-confirm-password-error" class="error-message"></div>
              </div>
              
              <div class="form-actions">
                <ion-button 
                  id="register-submit-btn" 
                  expand="block" 
                  type="submit"
                  color="success">
                  <ion-icon name="person-add" slot="start"></ion-icon>
                  <span id="register-btn-text">è¨»å†Š</span>
                </ion-button>
              </div>
              
              <div class="form-switch">
                <ion-button 
                  id="switch-to-login" 
                  fill="clear" 
                  expand="block">
                  å·²æœ‰å¸³è™Ÿï¼Ÿé»æ“Šç™»éŒ„
                </ion-button>
              </div>
            </form>
            
            <!-- API éŒ¯èª¤ä¿¡æ¯é¡¯ç¤º -->
            <div id="auth-error" class="auth-error" style="display: none;"></div>
          </div>
        </ion-content>
      </ion-modal>

      <!-- ç™»å‡ºç¢ºèªæ¨¡æ…‹æ¡† -->
      <ion-modal id="logout-confirm-modal">
        <ion-header>
          <ion-toolbar>
            <ion-title>ç¢ºèªç™»å‡º</ion-title>
          </ion-toolbar>
        </ion-header>
        
        <ion-content>
          <div style="padding: 20px; text-align: center;">
            <p>æ‚¨ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ</p>
            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
              <ion-button fill="outline" onclick="closeLogoutModal()">å–æ¶ˆ</ion-button>
              <ion-button onclick="confirmLogout()">ç¢ºèªç™»å‡º</ion-button>
            </div>
          </div>
        </ion-content>
      </ion-modal>
    </ion-app>

    <script>
      // é…ç½®å¸¸æ•¸ - Step 27: ç¨‹å¼ç¢¼å„ªåŒ–
      const CONFIG = {
        API_BASE_URL: 'https://dae-mobile-assignment.hkit.cc/api',
        MAX_RETRIES: 15,
        SESSION_TIMEOUT: 24 * 60 * 60 * 1000, // 24å°æ™‚
        SEARCH_DELAY: 500, // æœç´¢å»¶é²æ¯«ç§’
        INFINITE_SCROLL_THRESHOLD: 200, // è·é›¢åº•éƒ¨è§¸ç™¼è¼‰å…¥çš„åƒç´ 
        ITEMS_PER_PAGE_OPTIONS: [5, 10, 20, 50],
        ERROR_DISPLAY_TIMEOUT: 5000, // éŒ¯èª¤ä¿¡æ¯é¡¯ç¤ºæ™‚é–“
        // æ™‚é–“å»¶é²é…ç½®
        RETRY_DELAY: 500,
        BASE_RETRY_DELAY: 1000,
        LOGOUT_DELAY: 1000,
        BUTTON_FEEDBACK_DELAY: 1500,
        TOAST_DISPLAY_DELAY: 3500,
        AUTO_LOGOUT_INTERVAL: 5 * 60 * 1000,
        // LocalStorage éµå€¼
        AUTH_TOKEN_KEY: 'authToken',
        USER_DATA_KEY: 'userData', 
        BOOKMARKS_KEY: 'yoga_app_bookmarks',
        AUTH_STORAGE_KEY: 'yoga_app_auth',
        USER_STORAGE_KEY: 'yoga_app_user'
      };
      
      // å…¨å±€è®Šé‡
      let allItems = [];
      let filteredItems = [];
      let currentUser = null;
      let currentPage = 1;
      let itemsPerPage = 5; // æ­¥é©Ÿ7: æ¯é é¡¯ç¤º5å€‹ï¼Œç¢ºä¿æœ‰æ›´å¤šæ•¸æ“šè¼‰å…¥
      let isLoginMode = true;
      let bookmarks = [];
      let hasMoreData = true;
      
      // æœç´¢ã€ç¯©é¸å’Œæ’åºç‹€æ…‹
      let currentSearchParams = {
        search: '',
        category: 'all',
        sort: '',
        order: 'asc',
        showBookmarkedOnly: false
      };
      
      // Step 24: ç„¡é™æ»¾å‹•ç‹€æ…‹ (é»˜èªå•Ÿç”¨ç„¡é™æ»¾å‹•)
      let isInfiniteScrollEnabled = true;
      let isLoadingMore = false;
      
      // èªè­‰å’Œæœƒè©±ç®¡ç†
      
      // éŒ¯èª¤è™•ç†çµ±è¨ˆ
      let errorStats = {
        totalErrors: 0,
        networkErrors: 0,
        serverErrors: 0,
        timeoutErrors: 0,
        lastErrorTime: null,
        consecutiveErrors: 0,
        maxConsecutiveErrors: 5
      };
      
      // API å‡½æ•¸ - å¸¶é‡è©¦æ©Ÿåˆ¶ (æ”¯æŒæœç´¢ã€åˆ†é¡ã€æ’åºåƒæ•¸)
      async function fetchFromAPIWithRetry(page = 1, limit = 10, searchParams = {}) {
        const maxRetries = CONFIG.MAX_RETRIES;
        
        for (let attempt = 1; attempt <= maxRetries; attempt++) {
          try {
            // æ§‹å»ºURLåƒæ•¸
            const urlParams = new URLSearchParams();
            urlParams.append('page', page);
            urlParams.append('limit', limit);
            
            // æ·»åŠ æœç´¢åƒæ•¸
            if (searchParams.search && searchParams.search.trim()) {
              urlParams.append('search', searchParams.search.trim());
            }
            
            // æ·»åŠ åˆ†é¡åƒæ•¸
            if (searchParams.category && searchParams.category !== '' && searchParams.category !== 'all') {
              urlParams.append('category', searchParams.category);
            }
            
            // æ·»åŠ æ’åºåƒæ•¸
            if (searchParams.sort) {
              urlParams.append('sort', searchParams.sort);
              if (searchParams.order) {
                urlParams.append('order', searchParams.order);
              }
            }
            
            const url = `${CONFIG.API_BASE_URL}/yoga-poses/?${urlParams.toString()}`;
            console.log(`API å˜—è©¦ ${attempt}/${maxRetries}:`, url);
            
            // æ›´æ–°è¼‰å…¥æ¶ˆæ¯
            const loadingMessage = document.getElementById('loading-message');
            if (loadingMessage) {
              loadingMessage.textContent = `è¼‰å…¥ç‘œä¼½å‹•ä½œä¸­... (å˜—è©¦ ${attempt}/${maxRetries})`;
            }
            
            const response = await fetch(url);
            
            if (!response.ok) {
              throw new Error(`HTTP éŒ¯èª¤: ${response.status}`);
            }
            
            const data = await response.json();
            console.log('API éŸ¿æ‡‰:', data);
            
            // æª¢æŸ¥æ˜¯å¦æ˜¯æ¸¬è©¦éŒ¯èª¤
            if (data.error) {
              console.log('æ”¶åˆ°æ¸¬è©¦éŒ¯èª¤ï¼Œé‡è©¦ä¸­...', data.error);
              if (attempt < maxRetries) {
                await new Promise(resolve => setTimeout(resolve, CONFIG.RETRY_DELAY));
                continue;
              } else {
                throw new Error(`API æ¸¬è©¦éŒ¯èª¤: ${data.error}`);
              }
            }
            
            // æˆåŠŸç²å–æ•¸æ“š
            if (data.items && Array.isArray(data.items)) {
              const totalItems = data.pagination?.total || data.items.length;
              const currentTotal = (page - 1) * limit + data.items.length;
              // ä¿®æ­£: æ›´æ™ºèƒ½çš„æª¢æ¸¬æ˜¯å¦é‚„æœ‰æ›´å¤šæ•¸æ“š
              const hasMoreItems = data.pagination ? 
                (data.pagination.total > currentTotal) : 
                (data.items.length === limit); // å¦‚æœè¿”å›çš„é …ç›®æ•¸ç­‰æ–¼è«‹æ±‚çš„é™åˆ¶ï¼Œé€šå¸¸è¡¨ç¤ºé‚„æœ‰æ›´å¤šæ•¸æ“š
              
              console.log('åˆ†é ä¿¡æ¯:', {
                page,
                limit,
                itemsInResponse: data.items.length,
                totalItems,
                currentTotal,
                hasMoreItems,
                paginationData: data.pagination
              });
              
              return {
                items: data.items,
                total: totalItems,
                hasMore: hasMoreItems
              };
            } else {
              throw new Error('ç„¡æ•ˆçš„æ•¸æ“šæ ¼å¼');
            }
            
          } catch (error) {
            console.log(`å˜—è©¦ ${attempt} å¤±æ•—:`, error.message);
            
            if (attempt < maxRetries) {
              await new Promise(resolve => setTimeout(resolve, CONFIG.BASE_RETRY_DELAY));
            } else {
              throw error;
            }
          }
        }
      }
      
      // Step 23: æ”¶è—éæ¿¾åŠŸèƒ½
      function toggleBookmarkFilter() {
        currentSearchParams.showBookmarkedOnly = !currentSearchParams.showBookmarkedOnly;
        
        const filterBtn = document.getElementById('bookmark-filter-btn');
        const icon = filterBtn.querySelector('ion-icon');
        
        if (currentSearchParams.showBookmarkedOnly) {
          filterBtn.setAttribute('fill', 'solid');
          filterBtn.setAttribute('color', 'danger');
          icon.setAttribute('name', 'heart');
          filterBtn.innerHTML = '<ion-icon name="heart"></ion-icon> åªé¡¯ç¤ºæ”¶è—';
        } else {
          filterBtn.setAttribute('fill', 'outline');
          filterBtn.setAttribute('color', 'primary');
          icon.setAttribute('name', 'heart-outline');
          filterBtn.innerHTML = '<ion-icon name="heart-outline"></ion-icon> é¡¯ç¤ºå…¨éƒ¨';
        }
        
        // é‡æ–°é¡¯ç¤ºç•¶å‰é …ç›®ï¼Œæ‡‰ç”¨æ”¶è—éæ¿¾
        applyBookmarkFilter();
      }
      
      function applyBookmarkFilter() {
        const itemsToDisplay = currentSearchParams.showBookmarkedOnly 
          ? allItems.filter(item => bookmarks.includes(item.id))
          : allItems;
          
        console.log(`æ”¶è—éæ¿¾: ${currentSearchParams.showBookmarkedOnly ? 'åªé¡¯ç¤ºæ”¶è—' : 'é¡¯ç¤ºå…¨éƒ¨'}, çµæœ: ${itemsToDisplay.length}/${allItems.length}`);
        
        // é‡æ–°é¡¯ç¤ºé …ç›®
        const list = document.getElementById('poses-list');
        list.innerHTML = '<div class="poses-grid"></div>';
        displayItems(itemsToDisplay);
        
        // æ›´æ–°åˆ†é ä¿¡æ¯
        if (currentSearchParams.showBookmarkedOnly) {
          const pagination = document.getElementById('pagination-container');
          const loadMoreBtn = document.getElementById('load-more-btn');
          const noMoreData = document.getElementById('no-more-data');
          const info = document.getElementById('pagination-info');
          
          loadMoreBtn.style.display = 'none';
          noMoreData.style.display = 'none';
          info.innerHTML = `
            <strong>æ”¶è—é …ç›®: ${itemsToDisplay.length} é …</strong>
            <br>
            <small style="color: #666;">${currentUser ? 'åªé¡¯ç¤ºæ‚¨æ”¶è—çš„é …ç›®' : 'è«‹ç™»éŒ„å¾Œæ”¶è—é …ç›®'}</small>
          `;
        } else {
          updatePaginationInfo();
        }
      }
      
      // Step 24: ç„¡é™æ»¾å‹•åŠŸèƒ½
      function setupInfiniteScroll() {
        // ç§»é™¤èˆŠçš„äº‹ä»¶ç›£è½å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        window.removeEventListener('scroll', handleInfiniteScroll);
        
        // æ·»åŠ æ»¾å‹•äº‹ä»¶ç›£è½å™¨
        window.addEventListener('scroll', handleInfiniteScroll);
        console.log('âœ… ç„¡é™æ»¾å‹•å·²å•Ÿç”¨');
      }
      
      function handleInfiniteScroll() {
        // èª¿è©¦ä¿¡æ¯
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        const windowHeight = window.innerHeight;
        const documentHeight = document.documentElement.scrollHeight;
        
        console.log('æ»¾å‹•æª¢æ¸¬:', {
          scrollTop,
          windowHeight, 
          documentHeight,
          isLoadingMore,
          hasMoreData,
          isInfiniteScrollEnabled,
          showBookmarkedOnly: currentSearchParams.showBookmarkedOnly
        });
        
        // å¦‚æœæ­£åœ¨åŠ è¼‰æˆ–æ²’æœ‰æ›´å¤šæ•¸æ“šï¼Œå‰‡ä¸åŸ·è¡Œ
        if (isLoadingMore || !hasMoreData || !isInfiniteScrollEnabled) {
          console.log('ç„¡é™æ»¾å‹•è¢«é˜»æ­¢:', { isLoadingMore, hasMoreData, isInfiniteScrollEnabled });
          return;
        }
        
        // å¦‚æœå•Ÿç”¨äº†æ”¶è—éæ¿¾ï¼Œå‰‡ä¸åŸ·è¡Œç„¡é™æ»¾å‹•
        if (currentSearchParams.showBookmarkedOnly) {
          console.log('æ”¶è—éæ¿¾æ¨¡å¼ï¼Œè·³éç„¡é™æ»¾å‹•');
          return;
        }
        
        // æª¢æŸ¥æ˜¯å¦æ¥è¿‘é é¢åº•éƒ¨ï¼ˆè·é›¢åº•éƒ¨200pxæ™‚è§¸ç™¼ï¼Œæˆ–è€…å¦‚æœé é¢å¤ªçŸ­å‰‡ç«‹å³è§¸ç™¼ï¼‰
        if (scrollTop + windowHeight >= documentHeight - 200 || documentHeight <= windowHeight + 50) {
          console.log('âœ… è§¸ç™¼ç„¡é™æ»¾å‹•è¼‰å…¥');
          loadMoreDataInfinite();
        }
      }
      
      async function loadMoreDataInfinite() {
        if (isLoadingMore || !hasMoreData) {
          return;
        }
        
        isLoadingMore = true;
        const infiniteLoading = document.getElementById('infinite-scroll-loading');
        const loadMoreError = document.getElementById('load-more-error');
        
        try {
          // é¡¯ç¤ºè¼‰å…¥æŒ‡ç¤ºå™¨
          infiniteLoading.style.display = 'block';
          loadMoreError.style.display = 'none';
          
          console.log(`ç„¡é™æ»¾å‹•è¼‰å…¥ç¬¬ ${currentPage + 1} é æ•¸æ“šï¼Œæœç´¢æ¢ä»¶:`, currentSearchParams);
          currentPage++;
          
          const result = await fetchFromAPIWithRetry(currentPage, itemsPerPage, currentSearchParams);
          
          if (result.items.length === 0) {
            // æ²’æœ‰æ›´å¤šæ•¸æ“š
            hasMoreData = false;
            updatePaginationInfo();
            return;
          }
          
          // åˆä½µæ–°æ•¸æ“š
          allItems = [...allItems, ...result.items];
          hasMoreData = result.hasMore;
          filteredItems = [...allItems];
          
          console.log(`âœ… ç„¡é™æ»¾å‹•è¼‰å…¥æˆåŠŸ: æ–°å¢ ${result.items.length} é …, ç¸½è¨ˆ ${allItems.length} é …`);
          
          // è¿½åŠ é¡¯ç¤ºæ–°é …ç›®ï¼ˆä¸æ¸…ç©ºç¾æœ‰é …ç›®ï¼‰
          displayItems(result.items, true);
          
          // æ›´æ–°åˆ†é ä¿¡æ¯
          updatePaginationInfo();
          
          // å¦‚æœé‚„æœ‰æ›´å¤šæ•¸æ“šï¼Œå†æ¬¡æª¢æŸ¥æ˜¯å¦éœ€è¦ç¹¼çºŒè¼‰å…¥
          if (hasMoreData) {
            setTimeout(() => {
              checkAndTriggerInfiniteScroll();
            }, 300);
          }
          
        } catch (error) {
          console.error('âŒ ç„¡é™æ»¾å‹•è¼‰å…¥å¤±æ•—:', error);
          currentPage--; // å›é€€é æ•¸
          
          // é¡¯ç¤ºéŒ¯èª¤ä¿¡æ¯
          loadMoreError.style.display = 'block';
          loadMoreError.innerHTML = `
            <ion-icon name="warning" style="color: #dc3545; margin-right: 5px;"></ion-icon>
            è¼‰å…¥å¤±æ•—: ${error.message}
            <ion-button size="small" fill="clear" onclick="loadMoreDataInfinite()" style="margin-left: 10px;">
              <ion-icon name="refresh" slot="start"></ion-icon>
              é‡è©¦
            </ion-button>
          `;
          
        } finally {
          isLoadingMore = false;
          infiniteLoading.style.display = 'none';
        }
      }
      
      function toggleInfiniteScroll() {
        isInfiniteScrollEnabled = !isInfiniteScrollEnabled;
        const loadMoreBtn = document.getElementById('load-more-btn');
        
        if (isInfiniteScrollEnabled) {
          setupInfiniteScroll();
          loadMoreBtn.style.display = 'none';
          console.log('âœ… åˆ‡æ›åˆ°ç„¡é™æ»¾å‹•æ¨¡å¼');
        } else {
          window.removeEventListener('scroll', handleInfiniteScroll);
          loadMoreBtn.style.display = hasMoreData ? 'block' : 'none';
          console.log('âœ… åˆ‡æ›åˆ°æ‰‹å‹•è¼‰å…¥æ¨¡å¼');
        }
      }
      
      // é¡¯ç¤ºæ•¸æ“š
      function displayItems(items, appendMode = false) {
        console.log('é¡¯ç¤ºé …ç›®:', items.length, appendMode ? '(è¿½åŠ æ¨¡å¼)' : '(æ›¿æ›æ¨¡å¼)');
        const list = document.getElementById('poses-list');
        const loading = document.getElementById('loading-container');
        const pagination = document.getElementById('pagination-container');
        
        if (!list) {
          console.error('æ‰¾ä¸åˆ° poses-list å…ƒç´ ');
          return;
        }
        
        // å¦‚æœä¸æ˜¯è¿½åŠ æ¨¡å¼æˆ–æ˜¯ç¬¬ä¸€é ï¼Œæ¸…ç©ºåˆ—è¡¨
        if (!appendMode || currentPage === 1) {
          list.innerHTML = '<div class="poses-grid"></div>';
        }
        
        const grid = list.querySelector('.poses-grid');
        
        items.forEach(item => {
          const card = document.createElement('ion-card');
          card.className = 'pose-card';
          
          card.innerHTML = `
            <ion-card-header>
              <ion-card-title>${item.title || item.sanskrit_name || 'ç„¡æ¨™é¡Œ'}</ion-card-title>
              <ion-card-subtitle>
                ${item.category || 'æœªåˆ†é¡'} â€¢ ${item.difficulty || 'æœªè¨­å®š'} â€¢ ${item.duration_minutes ? item.duration_minutes + ' åˆ†é˜' : 'æœªè¨­å®šæ™‚é•·'}
              </ion-card-subtitle>
            </ion-card-header>
            
            <ion-card-content>
              ${item.image_url ? `
                <img class="item-image" src="${item.image_url}" alt="${item.title || item.sanskrit_name}" loading="lazy">
              ` : ''}
              
              <p><strong>æ¢µæ–‡å:</strong> ${item.sanskrit_name || 'ç„¡'}</p>
              <p><strong>æ•™ç·´:</strong> ${item.instructor || 'æœªè¨­å®š'}</p>
              <p><strong>èªªæ˜:</strong> ${item.description || 'ç„¡èªªæ˜'}</p>
              
              ${item.benefits && Array.isArray(item.benefits) ? `
                <p><strong>å¥½è™•:</strong></p>
                <ul>
                  ${item.benefits.map(benefit => `<li>${benefit}</li>`).join('')}
                </ul>
              ` : ''}
              
              ${item.video_url ? `
                <div style="margin-top: 10px;">
                  <ion-button href="${item.video_url}" target="_blank" fill="outline" size="small">
                    <ion-icon name="play-circle-outline" slot="start"></ion-icon>
                    è§€çœ‹è¦–é »
                  </ion-button>
                </div>
              ` : ''}
              
              <div style="margin-top: 10px; display: flex; justify-content: space-between; align-items: center;">
                <ion-button 
                  fill="clear" 
                  size="small" 
                  onclick="toggleBookmark(${item.id})"
                  data-item-id="${item.id}"
                  class="bookmark-btn"
                  color="medium">
                  <ion-icon name="heart-outline" slot="start"></ion-icon>
                  æ”¶è—
                </ion-button>
                
                ${currentUser ? `
                  <ion-chip color="primary" size="small">
                    <ion-icon name="person"></ion-icon>
                    <ion-label>å·²ç™»éŒ„</ion-label>
                  </ion-chip>
                ` : `
                  <ion-chip color="medium" size="small">
                    <ion-icon name="person-outline"></ion-icon>
                    <ion-label>è¨ªå®¢</ion-label>
                  </ion-chip>
                `}
              </div>
            </ion-card-content>
          `;
          
          grid.appendChild(card);
        });
        
        // æ›´æ–°é¡¯ç¤ºç‹€æ…‹
        loading.style.display = 'none';
        list.style.display = 'block';
        
        // æ›´æ–°æ›¸ç±¤UIç‹€æ…‹
        if (currentUser) {
          updateBookmarkUI();
        }
        
        // æ›´æ–°åˆ†é ä¿¡æ¯
        updatePaginationInfo();
        pagination.style.display = 'block';
        
        console.log('æ•¸æ“šé¡¯ç¤ºå®Œæˆ');
      }
      
      // æ›´æ–°åˆ†é ä¿¡æ¯
      function updatePaginationInfo() {
        const info = document.getElementById('pagination-info');
        const loadMoreBtn = document.getElementById('load-more-btn');
        const noMoreData = document.getElementById('no-more-data');
        const pagination = document.getElementById('pagination-container');
        
        const totalDisplayed = allItems.length;
        const pageInfo = currentPage > 1 ? ` (ç¬¬ ${currentPage} é )` : '';
        
        info.innerHTML = `
          <strong>å·²é¡¯ç¤º ${totalDisplayed} é …ç‘œä¼½å‹•ä½œ</strong>${pageInfo}
          <br>
          <small style="color: #666;">æ¯é è¼‰å…¥ ${itemsPerPage} é …</small>
        `;
        
        console.log('æ›´æ–°åˆ†é ä¿¡æ¯:', {
          totalDisplayed,
          hasMoreData,
          currentPage,
          itemsPerPage,
          pageInfo
        });
        
        // ç¢ºä¿åˆ†é å®¹å™¨é¡¯ç¤º
        pagination.style.display = 'block';
        
        if (hasMoreData) {
          // Step 24: æ ¹æ“šç„¡é™æ»¾å‹•ç‹€æ…‹æ±ºå®šæ˜¯å¦é¡¯ç¤ºæŒ‰éˆ•
          loadMoreBtn.style.display = isInfiniteScrollEnabled ? 'none' : 'block';
          loadMoreBtn.disabled = false;
          noMoreData.style.display = 'none';
          console.log('é¡¯ç¤ºè¼‰å…¥æ›´å¤šæŒ‰éˆ•');
        } else {
          loadMoreBtn.style.display = 'none';
          noMoreData.style.display = 'block';
          noMoreData.innerHTML = `
            <ion-icon name="checkmark-circle" style="color: #28a745; margin-right: 8px;"></ion-icon>
            å·²è¼‰å…¥æ‰€æœ‰ç‘œä¼½å‹•ä½œ (å…± ${totalDisplayed} é …)
          `;
          console.log('é¡¯ç¤ºæ²’æœ‰æ›´å¤šæ•¸æ“šæç¤º');
        }
      }
      
      // é¡¯ç¤ºéŒ¯èª¤
      function showError(message) {
        console.error('é¡¯ç¤ºéŒ¯èª¤:', message);
        const loading = document.getElementById('loading-container');
        const error = document.getElementById('error-container');
        const errorMsg = document.getElementById('error-message');
        
        loading.style.display = 'none';
        errorMsg.textContent = message;
        error.style.display = 'block';
      }
      
      // è¼‰å…¥æ•¸æ“š
      async function loadData() {
        console.log('ğŸš€ é–‹å§‹è¼‰å…¥ç‘œä¼½å‹•ä½œæ•¸æ“š...');
        const loading = document.getElementById('loading-container');
        const error = document.getElementById('error-container');
        const list = document.getElementById('poses-list');
        const pagination = document.getElementById('pagination-container');
        
        // é‡ç½®ç‹€æ…‹
        currentPage = 1;
        allItems = [];
        hasMoreData = true;
        loading.style.display = 'block';
        error.style.display = 'none';
        list.style.display = 'none';
        pagination.style.display = 'none';
        
        console.log(`è¼‰å…¥åƒæ•¸: page=${currentPage}, limit=${itemsPerPage}, æœç´¢æ¢ä»¶:`, currentSearchParams);
        
        try {
          const result = await fetchFromAPIWithRetry(currentPage, itemsPerPage, currentSearchParams);
          
          if (!result.items || result.items.length === 0) {
            showError('æ²’æœ‰æ‰¾åˆ°ç‘œä¼½å‹•ä½œæ•¸æ“š');
            return;
          }
          
          // è¨­ç½®åˆå§‹æ•¸æ“š
          allItems = result.items;
          hasMoreData = result.hasMore;
          filteredItems = [...allItems];
          
          console.log(`âœ… é¦–æ¬¡è¼‰å…¥æˆåŠŸ: ${result.items.length} é …, hasMore: ${result.hasMore}`);
          
          displayItems(allItems);
          
          // Step 23: æ‡‰ç”¨æ”¶è—éæ¿¾ï¼ˆå¦‚æœå•Ÿç”¨ï¼‰
          if (currentSearchParams.showBookmarkedOnly) {
            applyBookmarkFilter();
          }
          
          // æª¢æŸ¥æ˜¯å¦éœ€è¦ç«‹å³è¼‰å…¥æ›´å¤šæ•¸æ“šï¼ˆå¦‚æœé é¢å¤ªçŸ­ç„¡æ³•æ»¾å‹•ï¼‰
          setTimeout(() => {
            checkAndTriggerInfiniteScroll();
          }, 500);
          
        } catch (error) {
          console.error('âŒ è¼‰å…¥æ•¸æ“šå¤±æ•—:', error);
          showError(`è¼‰å…¥å¤±æ•—: ${error.message}`);
        }
      }
      
      // æª¢æ¸¬ç¶²çµ¡ç‹€æ…‹
      function checkNetworkStatus() {
        return navigator.onLine;
      }
      
      // æ›´æ–°éŒ¯èª¤çµ±è¨ˆ
      function updateErrorStats(error) {
        errorStats.totalErrors++;
        errorStats.lastErrorTime = new Date();
        errorStats.consecutiveErrors++;
        
        // åˆ†é¡éŒ¯èª¤é¡å‹
        if (error.message.includes('Failed to fetch') || error.message.includes('ç¶²çµ¡')) {
          errorStats.networkErrors++;
        } else if (error.message.includes('HTTP') && (error.message.includes('500') || error.message.includes('502') || error.message.includes('503'))) {
          errorStats.serverErrors++;
        } else if (error.message.includes('timeout') || error.message.includes('è¶…æ™‚')) {
          errorStats.timeoutErrors++;
        }
        
        console.log('éŒ¯èª¤çµ±è¨ˆæ›´æ–°:', errorStats);
      }
      
      // é‡ç½®éŒ¯èª¤çµ±è¨ˆï¼ˆæˆåŠŸè¼‰å…¥å¾Œèª¿ç”¨ï¼‰
      function resetErrorStats() {
        errorStats.consecutiveErrors = 0;
      }
      
      // æª¢æŸ¥æ˜¯å¦éœ€è¦æš«åœé‡è©¦ï¼ˆé€£çºŒéŒ¯èª¤éå¤šï¼‰
      function shouldPauseRetry() {
        return errorStats.consecutiveErrors >= errorStats.maxConsecutiveErrors;
      }
      
      // è‡ªå‹•é‡è©¦æ©Ÿåˆ¶ï¼ˆå¸¶é€€é¿ç­–ç•¥ï¼‰
      async function autoRetryLoadMore(maxRetries = 3, baseDelay = CONFIG.BASE_RETRY_DELAY) {
        for (let attempt = 1; attempt <= maxRetries; attempt++) {
          try {
            console.log(`å˜—è©¦è‡ªå‹•é‡è©¦è¼‰å…¥æ›´å¤šæ•¸æ“š (${attempt}/${maxRetries})`);
            
            // æª¢æŸ¥ç¶²çµ¡ç‹€æ…‹
            if (!checkNetworkStatus()) {
              throw new Error('ç¶²çµ¡é€£æ¥ä¸å¯ç”¨');
            }
            
            await loadMoreData();
            return; // æˆåŠŸå‰‡é€€å‡º
            
          } catch (error) {
            console.log(`è‡ªå‹•é‡è©¦ ${attempt} å¤±æ•—:`, error.message);
            
            if (attempt === maxRetries) {
              throw error; // æ‰€æœ‰é‡è©¦éƒ½å¤±æ•—
            }
            
            // æŒ‡æ•¸é€€é¿å»¶é²
            const delay = baseDelay * Math.pow(2, attempt - 1);
            console.log(`ç­‰å¾… ${delay}ms å¾Œé‡è©¦...`);
            await new Promise(resolve => setTimeout(resolve, delay));
          }
        }
      }
      
      // æ‰‹å‹•é‡è©¦è¼‰å…¥æ›´å¤šæ•¸æ“š
      async function retryLoadMore() {
        const loadMoreError = document.getElementById('loadMoreError');
        const loadMoreBtn = document.getElementById('loadMoreBtn');
        
        try {
          loadMoreError.style.display = 'none';
          
          // é¡¯ç¤ºé‡è©¦ç‹€æ…‹
          loadMoreBtn.disabled = true;
          loadMoreBtn.innerHTML = '<ion-spinner name="crescent"></ion-spinner> é‡è©¦ä¸­...';
          
          await loadMoreData();
          
        } catch (error) {
          console.error('æ‰‹å‹•é‡è©¦å¤±æ•—:', error);
          
          // é¡¯ç¤ºé‡è©¦å¤±æ•—ä¿¡æ¯
          loadMoreError.style.display = 'block';
          loadMoreError.innerHTML = `
            <div style="color: #dc3545; padding: 8px 0;">
              <ion-icon name="alert-circle" style="margin-right: 4px;"></ion-icon>
              é‡è©¦å¤±æ•—: ${error.message}
              <ion-button size="small" fill="clear" onclick="autoRetryLoadMore()" style="margin-left: 10px;">
                <ion-icon name="refresh" slot="start"></ion-icon>
                è‡ªå‹•é‡è©¦
              </ion-button>
            </div>
          `;
          
        } finally {
          loadMoreBtn.disabled = false;
          loadMoreBtn.innerHTML = 'è¼‰å…¥æ›´å¤š';
        }
      }
      
      // æª¢æŸ¥ä¸¦è§¸ç™¼ç„¡é™æ»¾å‹•ï¼ˆç”¨æ–¼é é¢å…§å®¹å¤ªå°‘çš„æƒ…æ³ï¼‰
      function checkAndTriggerInfiniteScroll() {
        const windowHeight = window.innerHeight;
        const documentHeight = document.documentElement.scrollHeight;
        
        console.log('æª¢æŸ¥æ˜¯å¦éœ€è¦è‡ªå‹•è¼‰å…¥æ›´å¤š:', {
          windowHeight,
          documentHeight,
          hasMoreData,
          isInfiniteScrollEnabled,
          ratio: documentHeight / windowHeight
        });
        
        // å¦‚æœé é¢å…§å®¹å¤ªå°‘ï¼ˆå°æ–¼è¦–çª—é«˜åº¦çš„1.2å€ï¼‰ï¼Œä¸”é‚„æœ‰æ›´å¤šæ•¸æ“šï¼Œå‰‡è‡ªå‹•è¼‰å…¥
        if (documentHeight < windowHeight * 1.2 && hasMoreData && isInfiniteScrollEnabled && !isLoadingMore) {
          console.log('ğŸ”„ é é¢å…§å®¹å¤ªå°‘ï¼Œè‡ªå‹•è§¸ç™¼è¼‰å…¥æ›´å¤šæ•¸æ“š');
          loadMoreDataInfinite();
        }
      }
      
      // è¼‰å…¥æ›´å¤šæ•¸æ“š
      async function loadMoreData() {
        if (!hasMoreData) {
          console.log('æ²’æœ‰æ›´å¤šæ•¸æ“šå¯è¼‰å…¥');
          return;
        }
        
        const loadMoreBtn = document.getElementById('load-more-btn');
        const loadMoreError = document.getElementById('load-more-error');
        
        try {
          // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
          loadMoreBtn.disabled = true;
          loadMoreBtn.innerHTML = `
            <ion-spinner name="crescent" style="width: 16px; height: 16px; margin-right: 8px;"></ion-spinner>
            è¼‰å…¥ä¸­...
          `;
          loadMoreError.style.display = 'none';
          
          console.log(`è¼‰å…¥ç¬¬ ${currentPage + 1} é æ•¸æ“šï¼Œæœç´¢æ¢ä»¶:`, currentSearchParams);
          currentPage++;
          
          const result = await fetchFromAPIWithRetry(currentPage, itemsPerPage, currentSearchParams);
          
          if (result.items.length === 0) {
            // æ²’æœ‰æ›´å¤šæ•¸æ“š
            hasMoreData = false;
            updatePaginationInfo();
            return;
          }
          
          // åˆä½µæ–°æ•¸æ“š
          allItems = [...allItems, ...result.items];
          hasMoreData = result.hasMore;
          filteredItems = [...allItems];
          
          console.log(`æˆåŠŸè¼‰å…¥ ${result.items.length} é …æ–°æ•¸æ“šï¼Œç¸½è¨ˆ ${allItems.length} é …`);
          
          // é‡ç½®éŒ¯èª¤çµ±è¨ˆ
          resetErrorStats();
          
          // é¡¯ç¤ºæ–°æ•¸æ“šï¼ˆè¿½åŠ åˆ°ç¾æœ‰åˆ—è¡¨ï¼‰
          displayItems(result.items);
          
        } catch (error) {
          console.error('è¼‰å…¥æ›´å¤šå¤±æ•—:', error);
          
          // å›é€€é ç¢¼ï¼ˆå› ç‚ºè«‹æ±‚å¤±æ•—ï¼‰
          currentPage--;
          
          // æ›´æ–°éŒ¯èª¤çµ±è¨ˆ
          updateErrorStats(error);
          
          // åˆ†é¡éŒ¯èª¤é¡å‹ä¸¦é¡¯ç¤ºç›¸æ‡‰ä¿¡æ¯
          let errorMessage = 'è¼‰å…¥å¤±æ•—';
          let showRetryOption = true;
          
          if (error.message.includes('HTTP')) {
            if (error.message.includes('404')) {
              errorMessage = 'é é¢ä¸å­˜åœ¨ï¼Œå¯èƒ½å·²è¼‰å…¥æ‰€æœ‰æ•¸æ“š';
              hasMoreData = false;
              showRetryOption = false;
            } else if (error.message.includes('500')) {
              errorMessage = 'æœå‹™å™¨éŒ¯èª¤ï¼Œè«‹ç¨å¾Œé‡è©¦';
            } else if (error.message.includes('429')) {
              errorMessage = 'è«‹æ±‚éæ–¼é »ç¹ï¼Œè«‹ç¨å¾Œé‡è©¦';
            } else {
              errorMessage = `ç¶²çµ¡éŒ¯èª¤ (${error.message})`;
            }
          } else if (error.message.includes('Failed to fetch')) {
            errorMessage = 'ç¶²çµ¡é€£æ¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡';
          } else if (error.message.includes('API æ¸¬è©¦éŒ¯èª¤')) {
            errorMessage = 'è¼‰å…¥å¤±æ•— (æ¸¬è©¦ç’°å¢ƒéš¨æ©ŸéŒ¯èª¤)';
          } else {
            errorMessage = `è¼‰å…¥å¤±æ•—: ${error.message}`;
          }
          
          // æª¢æŸ¥æ˜¯å¦éœ€è¦æš«åœé‡è©¦
          const shouldPause = shouldPauseRetry();
          
          // é¡¯ç¤ºéŒ¯èª¤ä¿¡æ¯å’Œé‡è©¦é¸é …
          loadMoreError.style.display = 'block';
          loadMoreError.innerHTML = `
            <div style="padding: 12px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; margin: 8px 0;">
              <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                <span style="color: #dc3545; font-weight: 500;">
                  <ion-icon name="alert-circle" style="margin-right: 4px;"></ion-icon>
                  ${errorMessage}
                </span>
                ${showRetryOption && !shouldPause ? `
                  <ion-button size="small" fill="clear" onclick="retryLoadMore()" style="margin-left: 10px;">
                    <ion-icon name="refresh" slot="start"></ion-icon>
                    é‡è©¦
                  </ion-button>
                ` : ''}
              </div>
              
              ${errorStats.consecutiveErrors > 1 ? `
                <div style="font-size: 12px; color: #6c757d; margin-top: 4px;">
                  <ion-icon name="warning" style="margin-right: 4px; font-size: 14px;"></ion-icon>
                  é€£çºŒéŒ¯èª¤ ${errorStats.consecutiveErrors} æ¬¡
                  ${shouldPause ? ' - æš«åœè‡ªå‹•é‡è©¦' : ''}
                </div>
              ` : ''}
              
              ${shouldPause ? `
                <div style="margin-top: 8px;">
                  <ion-button size="small" fill="outline" onclick="resetErrorStats(); retryLoadMore();">
                    <ion-icon name="refresh" slot="start"></ion-icon>
                    å¼·åˆ¶é‡è©¦
                  </ion-button>
                </div>
              ` : ''}
            </div>
          `;
          
          // å¦‚æœæ²’æœ‰æ›´å¤šæ•¸æ“šï¼Œæ›´æ–°åˆ†é ä¿¡æ¯
          if (!showRetryOption) {
            updatePaginationInfo();
          }
          
          // 5ç§’å¾Œè‡ªå‹•éš±è—éŒ¯èª¤ä¿¡æ¯ï¼ˆå¦‚æœæœ‰é‡è©¦é¸é …å‰‡å»¶é•·åˆ°8ç§’ï¼‰
          const hideDelay = showRetryOption ? 8000 : 5000;
          setTimeout(() => {
            if (loadMoreError.style.display === 'block') {
              loadMoreError.style.display = 'none';
            }
          }, hideDelay);
          
        } finally {
          // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
          loadMoreBtn.disabled = false;
          loadMoreBtn.innerHTML = 'è¼‰å…¥æ›´å¤š';
        }
      }
      
      // APIæœç´¢åŠŸèƒ½ - Step 20
      let searchTimeout = null;
      
      async function performAPISearch() {
        // æ¸…é™¤ä¹‹å‰çš„æœç´¢å»¶é²
        if (searchTimeout) {
          clearTimeout(searchTimeout);
        }
        
        // å»¶é²åŸ·è¡Œæœç´¢ï¼Œé¿å…é »ç¹APIèª¿ç”¨
        searchTimeout = setTimeout(async () => {
          const searchTerm = document.getElementById('search-bar').value.trim();
          const selectedCategory = document.getElementById('category-select').value;
          const selectedSort = document.getElementById('sort-select').value;
          const selectedOrder = document.getElementById('order-select').value;
          
          // æ›´æ–°æœç´¢åƒæ•¸
          currentSearchParams.search = searchTerm;
          currentSearchParams.category = selectedCategory;
          currentSearchParams.sort = selectedSort;
          currentSearchParams.order = selectedOrder;
          
          console.log('åŸ·è¡ŒAPIæœç´¢:', currentSearchParams);
          
          // å¦‚æœæœ‰æœç´¢æ¢ä»¶ï¼Œé‡æ–°è¼‰å…¥æ•¸æ“š
          if (searchTerm || (selectedCategory && selectedCategory !== '') || selectedSort) {
            await loadData();
          } else {
            // å¦‚æœæ¸…ç©ºæ‰€æœ‰æœç´¢æ¢ä»¶ï¼Œä¹Ÿé‡æ–°è¼‰å…¥æ•¸æ“š
            await loadData();
          }
        }, 500);
      }
      
      // èªè­‰ç›¸é—œåŠŸèƒ½ï¼ˆç°¡åŒ–ç‰ˆï¼‰
      function openAuthModal() {
        document.getElementById('auth-modal').present();
      }
      
      function closeAuthModal() {
        document.getElementById('auth-modal').dismiss();
      }
      
      function closeLogoutModal() {
        document.getElementById('logout-confirm-modal').dismiss();
      }
      
      // Step 25: å¢å¼·è¡¨å–®é©—è­‰å·¥å…·å‡½æ•¸
      function validateEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
      }
      
      function validatePassword(password) {
        // è‡³å°‘8å€‹å­—ç¬¦ï¼ŒåŒ…å«å¤§å¯«å­—æ¯ã€å°å¯«å­—æ¯ã€æ•¸å­—
        const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)[a-zA-Z\d@$!%*?&]{8,}$/;
        return passwordRegex.test(password);
      }
      
      // Step 25: å¯†ç¢¼å¼·åº¦æª¢æŸ¥ï¼ˆè©³ç´°åˆ†æï¼‰
      function getPasswordStrength(password) {
        const checks = {
          length: password.length >= 8,
          lowercase: /[a-z]/.test(password),
          uppercase: /[A-Z]/.test(password),
          numbers: /\d/.test(password),
          special: /[@$!%*?&]/.test(password),
          noSpaces: !/\s/.test(password)
        };
        
        const passedChecks = Object.values(checks).filter(Boolean).length;
        let strength = 'weak';
        let score = 0;
        
        if (checks.length) score += 2;
        if (checks.lowercase) score += 1;
        if (checks.uppercase) score += 1;
        if (checks.numbers) score += 1;
        if (checks.special) score += 2;
        if (checks.noSpaces) score += 1;
        
        if (score >= 7) strength = 'strong';
        else if (score >= 5) strength = 'medium';
        
        return {
          strength,
          score,
          checks,
          isValid: checks.length && checks.lowercase && checks.uppercase && checks.numbers && checks.noSpaces
        };
      }
      
      function validateUsername(username) {
        // ç”¨æˆ¶åï¼š3-20å€‹å­—ç¬¦ï¼Œåªèƒ½åŒ…å«å­—æ¯ã€æ•¸å­—ã€ä¸‹åŠƒç·š
        const usernameRegex = /^[a-zA-Z0-9_]{3,20}$/;
        return usernameRegex.test(username);
      }
      
      // Step 25: å¯¦æ™‚å¯†ç¢¼å¼·åº¦æª¢æŸ¥å’Œè¦–è¦ºåé¥‹
      function updatePasswordStrength(password) {
        const strengthContainer = document.getElementById('password-strength-container');
        const strengthFill = document.getElementById('password-strength-fill');
        const strengthText = document.getElementById('password-strength-text');
        
        if (!password || password.length === 0) {
          strengthContainer.style.display = 'none';
          return;
        }
        
        strengthContainer.style.display = 'block';
        const analysis = getPasswordStrength(password);
        
        // æ›´æ–°å¼·åº¦æ¢
        let width = 0;
        let color = '#dc3545'; // ç´…è‰² (å¼±)
        let text = 'å¼±';
        
        if (analysis.strength === 'strong') {
          width = 100;
          color = '#28a745'; // ç¶ è‰² (å¼·)
          text = 'å¼·';
        } else if (analysis.strength === 'medium') {
          width = 66;
          color = '#ffc107'; // é»ƒè‰² (ä¸­ç­‰)
          text = 'ä¸­ç­‰';
        } else {
          width = 33;
          color = '#dc3545'; // ç´…è‰² (å¼±)
          text = 'å¼±';
        }
        
        strengthFill.style.width = width + '%';
        strengthFill.style.backgroundColor = color;
        strengthText.textContent = text;
        strengthText.style.color = color;
        
        // æ›´æ–°éœ€æ±‚æª¢æŸ¥åˆ—è¡¨
        updateRequirementChecklist(analysis.checks);
      }
      
      function updateRequirementChecklist(checks) {
        const requirements = [
          { id: 'req-length', check: checks.length, text: 'è‡³å°‘8å€‹å­—ç¬¦' },
          { id: 'req-lowercase', check: checks.lowercase, text: 'åŒ…å«å°å¯«å­—æ¯' },
          { id: 'req-uppercase', check: checks.uppercase, text: 'åŒ…å«å¤§å¯«å­—æ¯' },
          { id: 'req-numbers', check: checks.numbers, text: 'åŒ…å«æ•¸å­—' },
          { id: 'req-special', check: checks.special, text: 'åŒ…å«ç‰¹æ®Šå­—ç¬¦ (å¯é¸)' }
        ];
        
        requirements.forEach(req => {
          const element = document.getElementById(req.id);
          if (element) {
            if (req.check) {
              element.innerHTML = `<span style="color: #28a745;">âœ“</span> ${req.text}`;
            } else if (req.id === 'req-special') {
              element.innerHTML = `<span style="color: #6c757d;">â—‹</span> ${req.text}`;
            } else {
              element.innerHTML = `<span style="color: #dc3545;">âœ—</span> ${req.text}`;
            }
          }
        });
      }
      
      function showFieldError(fieldId, message) {
        const errorElement = document.getElementById(fieldId + '-error');
        if (errorElement) {
          errorElement.textContent = message;
          errorElement.classList.add('show');
        }
      }
      
      function hideFieldError(fieldId) {
        const errorElement = document.getElementById(fieldId + '-error');
        if (errorElement) {
          errorElement.classList.remove('show');
        }
      }
      
      function showAuthError(message) {
        const errorElement = document.getElementById('auth-error');
        errorElement.innerHTML = `
          <div style="display: flex; align-items: center;">
            <ion-icon name="alert-circle" style="margin-right: 8px; color: #dc3545;"></ion-icon>
            <span>${message}</span>
          </div>
        `;
        errorElement.classList.add('show');
        
        // 5ç§’å¾Œè‡ªå‹•éš±è—
        setTimeout(() => {
          errorElement.classList.remove('show');
        }, CONFIG.ERROR_DISPLAY_TIMEOUT);
      }
      
      function hideAuthError() {
        const errorElement = document.getElementById('auth-error');
        errorElement.classList.remove('show');
      }
      
      // è¡¨å–®é©—è­‰å‡½æ•¸
      function validateLoginForm() {
        let isValid = true;
        
        const username = document.getElementById('login-username').value.trim();
        const password = document.getElementById('login-password').value;
        
        // æ¸…é™¤ä¹‹å‰çš„éŒ¯èª¤
        hideFieldError('login-username');
        hideFieldError('login-password');
        hideAuthError();
        
        // é©—è­‰ç”¨æˆ¶å/éƒµä»¶
        if (!username) {
          showFieldError('login-username', 'è«‹è¼¸å…¥ç”¨æˆ¶åæˆ–éƒµä»¶');
          isValid = false;
        } else if (username.length < 3) {
          showFieldError('login-username', 'ç”¨æˆ¶åè‡³å°‘3å€‹å­—ç¬¦');
          isValid = false;
        }
        
        // é©—è­‰å¯†ç¢¼
        if (!password) {
          showFieldError('login-password', 'è«‹è¼¸å…¥å¯†ç¢¼');
          isValid = false;
        } else if (password.length < 6) {
          showFieldError('login-password', 'å¯†ç¢¼è‡³å°‘6å€‹å­—ç¬¦');
          isValid = false;
        }
        
        return isValid;
      }
      
      function validateRegisterForm() {
        let isValid = true;
        
        const username = document.getElementById('register-username').value.trim();
        const email = document.getElementById('register-email').value.trim();
        const password = document.getElementById('register-password').value;
        const confirmPassword = document.getElementById('register-confirm-password').value;
        
        // æ¸…é™¤ä¹‹å‰çš„éŒ¯èª¤
        hideFieldError('register-username');
        hideFieldError('register-email');
        hideFieldError('register-password');
        hideFieldError('register-confirm-password');
        hideAuthError();
        
        // é©—è­‰ç”¨æˆ¶å
        if (!username) {
          showFieldError('register-username', 'è«‹è¼¸å…¥ç”¨æˆ¶å');
          isValid = false;
        } else if (!validateUsername(username)) {
          showFieldError('register-username', 'ç”¨æˆ¶åï¼š3-20å€‹å­—ç¬¦ï¼Œåªèƒ½åŒ…å«å­—æ¯ã€æ•¸å­—ã€ä¸‹åŠƒç·š');
          isValid = false;
        }
        
        // é©—è­‰éƒµä»¶
        if (!email) {
          showFieldError('register-email', 'è«‹è¼¸å…¥é›»å­éƒµä»¶');
          isValid = false;
        } else if (!validateEmail(email)) {
          showFieldError('register-email', 'è«‹è¼¸å…¥æœ‰æ•ˆçš„é›»å­éƒµä»¶åœ°å€');
          isValid = false;
        }
        
        // Step 25: é©—è­‰å¯†ç¢¼ï¼ˆä½¿ç”¨å¢å¼·ç‰ˆæª¢æŸ¥ï¼‰
        if (!password) {
          showFieldError('register-password', 'è«‹è¼¸å…¥å¯†ç¢¼');
          isValid = false;
        } else {
          const passwordStrength = getPasswordStrength(password);
          if (!passwordStrength.isValid) {
            showFieldError('register-password', 'å¯†ç¢¼å¿…é ˆè‡³å°‘8ä½ï¼ŒåŒ…å«å¤§å¯«å­—æ¯ã€å°å¯«å­—æ¯ã€æ•¸å­—ä¸”ç„¡ç©ºæ ¼');
            isValid = false;
          }
        }
        
        // é©—è­‰ç¢ºèªå¯†ç¢¼
        if (!confirmPassword) {
          showFieldError('register-confirm-password', 'è«‹ç¢ºèªå¯†ç¢¼');
          isValid = false;
        } else if (password !== confirmPassword) {
          showFieldError('register-confirm-password', 'å…©æ¬¡è¼¸å…¥çš„å¯†ç¢¼ä¸ä¸€è‡´');
          isValid = false;
        }
        
        return isValid;
      }
      
      // åˆ‡æ›è¡¨å–®æ¨¡å¼
      function switchAuthMode(mode) {
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const title = document.getElementById('auth-title');
        
        if (mode === 'login') {
          loginForm.style.display = 'block';
          registerForm.style.display = 'none';
          title.textContent = 'ç™»éŒ„';
        } else {
          loginForm.style.display = 'none';
          registerForm.style.display = 'block';
          title.textContent = 'è¨»å†Š';
        }
        
        // æ¸…é™¤æ‰€æœ‰éŒ¯èª¤ä¿¡æ¯
        hideAuthError();
        hideFieldError('login-username');
        hideFieldError('login-password');
        hideFieldError('register-username');
        hideFieldError('register-email');
        hideFieldError('register-password');
        hideFieldError('register-confirm-password');
      }
      
      // è™•ç†ç™»éŒ„
      async function handleLogin(event) {
        event.preventDefault();
        
        if (!validateLoginForm()) {
          return;
        }
        
        const loginBtn = document.getElementById('login-submit-btn');
        const btnText = document.getElementById('login-btn-text');
        
        try {
          // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
          loginBtn.disabled = true;
          btnText.innerHTML = '<ion-spinner class="loading-spinner"></ion-spinner>ç™»éŒ„ä¸­...';
          
          const username = document.getElementById('login-username').value.trim();
          const password = document.getElementById('login-password').value;
          
          // èª¿ç”¨çœŸå¯¦APIï¼ˆå¸¶é‡è©¦æ©Ÿåˆ¶ï¼‰
          const response = await loginUser(username, password);
          
          // è™•ç†ç™»å…¥æˆåŠŸå›æ‡‰
          let user, token;
          
          if (response.user) {
            // å¦‚æœAPIè¿”å›å®Œæ•´ç”¨æˆ¶æ•¸æ“š
            user = response.user;
            token = response.token || response.access_token;
          } else {
            // å¦‚æœAPIåªè¿”å›åŸºæœ¬ä¿¡æ¯ï¼Œæ§‹å»ºç”¨æˆ¶å°è±¡
            user = {
              id: response.id || response.user_id || Date.now(),
              username: response.username || username,
              email: response.email || null,
              name: response.name || response.display_name || username,
              avatar: response.avatar || null,
              role: response.role || 'user',
              createdAt: response.created_at || new Date().toISOString()
            };
            token = response.token || response.access_token;
          }
          
          // ç™»éŒ„æˆåŠŸ
          currentUser = user;
          saveAuthSession(currentUser, token);
          
          // åˆå§‹åŒ–ç”¨æˆ¶æ•¸æ“š
          await initializeUserData();
          
          // æ›´æ–°UI
          updateUserUI();
          closeAuthModal();
          
          // æ¸…ç©ºè¡¨å–®
          document.getElementById('login-form').reset();
          
          // é¡¯ç¤ºæ­¡è¿æ¶ˆæ¯
          showSuccessMessage(`æ­¡è¿å›ä¾†ï¼Œ${getUserDisplayName()}ï¼`);
          
        } catch (error) {
          showAuthError(error.message);
        } finally {
          // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
          loginBtn.disabled = false;
          btnText.textContent = 'ç™»éŒ„';
        }
      }
      
      // è™•ç†è¨»å†Š
      async function handleRegister(event) {
        event.preventDefault();
        
        if (!validateRegisterForm()) {
          return;
        }
        
        const registerBtn = document.getElementById('register-submit-btn');
        const btnText = document.getElementById('register-btn-text');
        
        try {
          // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
          registerBtn.disabled = true;
          btnText.innerHTML = '<ion-spinner class="loading-spinner"></ion-spinner>è¨»å†Šä¸­...';
          
          const username = document.getElementById('register-username').value.trim();
          const email = document.getElementById('register-email').value.trim();
          const password = document.getElementById('register-password').value;
          
          // èª¿ç”¨çœŸå¯¦APIï¼ˆå¸¶é‡è©¦æ©Ÿåˆ¶ï¼‰
          const response = await signupUser(username, email, password);
          
          // è™•ç†è¨»å†ŠæˆåŠŸå›æ‡‰
          let user, token;
          
          if (response.user) {
            // å¦‚æœAPIè¿”å›å®Œæ•´ç”¨æˆ¶æ•¸æ“š
            user = response.user;
            token = response.token || response.access_token;
          } else {
            // å¦‚æœAPIåªè¿”å›åŸºæœ¬ä¿¡æ¯ï¼Œæ§‹å»ºç”¨æˆ¶å°è±¡
            user = {
              id: response.id || Date.now(),
              username: username,
              email: email,
              name: response.name || username,
              avatar: response.avatar || null,
              role: response.role || 'user',
              createdAt: response.created_at || new Date().toISOString()
            };
            token = response.token || response.access_token;
          }
          
          // è¨»å†ŠæˆåŠŸï¼Œä¿å­˜æœƒè©±
          currentUser = user;
          saveAuthSession(currentUser, token);
          
          // åˆå§‹åŒ–ç”¨æˆ¶æ•¸æ“š
          await initializeUserData();
          
          // æ›´æ–°UI
          updateUserUI();
          closeAuthModal();
          
          // æ¸…ç©ºè¡¨å–®
          document.getElementById('register-form').reset();
          
          // é¡¯ç¤ºæ­¡è¿æ¶ˆæ¯
          showSuccessMessage(`è¨»å†ŠæˆåŠŸï¼æ­¡è¿åŠ å…¥ï¼Œ${getUserDisplayName()}ï¼`);
          
        } catch (error) {
          showAuthError(error.message);
        } finally {
          // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
          registerBtn.disabled = false;
          btnText.textContent = 'è¨»å†Š';
        }
      }
      
      // æœƒè©±ç®¡ç†å‡½æ•¸
      function saveAuthSession(user, token = null) {
        const authData = {
          user: user,
          token: token,
          timestamp: Date.now(),
          expiresAt: Date.now() + CONFIG.SESSION_TIMEOUT
        };
        
        localStorage.setItem(CONFIG.AUTH_STORAGE_KEY, JSON.stringify(authData));
        localStorage.setItem(CONFIG.USER_STORAGE_KEY, JSON.stringify(user));
        
        console.log('æœƒè©±å·²ä¿å­˜:', authData);
      }
      
      function loadAuthSession() {
        try {
          const authData = localStorage.getItem(CONFIG.AUTH_STORAGE_KEY);
          if (!authData) return null;
          
          const session = JSON.parse(authData);
          
          // æª¢æŸ¥æœƒè©±æ˜¯å¦éæœŸ
          if (Date.now() > session.expiresAt) {
            clearAuthSession();
            return null;
          }
          
          return session;
        } catch (error) {
          console.error('è¼‰å…¥æœƒè©±å¤±æ•—:', error);
          clearAuthSession();
          return null;
        }
      }
      
      function clearAuthSession() {
        localStorage.removeItem(CONFIG.AUTH_STORAGE_KEY);
        localStorage.removeItem(CONFIG.USER_STORAGE_KEY);
        currentUser = null;
        console.log('æœƒè©±å·²æ¸…é™¤');
      }
      
      function isSessionValid() {
        const session = loadAuthSession();
        return session && Date.now() < session.expiresAt;
      }
      
      function refreshSession() {
        const session = loadAuthSession();
        if (session) {
          session.timestamp = Date.now();
          session.expiresAt = Date.now() + CONFIG.SESSION_TIMEOUT;
          localStorage.setItem(CONFIG.AUTH_STORAGE_KEY, JSON.stringify(session));
        }
      }
      
      // çœŸå¯¦APIç™»éŒ„å‡½æ•¸ - å¸¶é‡è©¦æ©Ÿåˆ¶
      async function loginUser(username, password, maxRetries = 3) {
        for (let attempt = 1; attempt <= maxRetries; attempt++) {
          try {
            console.log(`ç™»éŒ„å˜—è©¦ ${attempt}/${maxRetries}`);
            
            const response = await fetch('https://dae-mobile-assignment.hkit.cc/api/auth/login', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                username: username,
                password: password
              })
            });

            const data = await response.json();
            
            // æª¢æŸ¥æ˜¯å¦æ˜¯æ¸¬è©¦éŒ¯èª¤ï¼ˆå¯ä»¥é‡è©¦ï¼‰
            if (data.error && data.error.includes('Error injected for testing purposes')) {
              console.log(`æ”¶åˆ°æ¸¬è©¦éŒ¯èª¤ï¼Œç¬¬ ${attempt} æ¬¡å˜—è©¦å¤±æ•—ï¼Œæº–å‚™é‡è©¦...`);
              if (attempt < maxRetries) {
                // æŒ‡æ•¸é€€é¿å»¶é²
                const delay = Math.pow(2, attempt - 1) * 1000;
                console.log(`ç­‰å¾… ${delay}ms å¾Œé‡è©¦...`);
                await new Promise(resolve => setTimeout(resolve, delay));
                continue;
              }
            }
            
            // æª¢æŸ¥å…¶ä»–éŒ¯èª¤
            if (!response.ok || data.error) {
              throw new Error(data.message || data.error || `ç™»éŒ„å¤±æ•— (HTTP ${response.status})`);
            }

            console.log(`ç™»éŒ„æˆåŠŸï¼ç¬¬ ${attempt} æ¬¡å˜—è©¦`);
            return data;
            
          } catch (error) {
            console.error(`ç™»éŒ„APIéŒ¯èª¤ (å˜—è©¦ ${attempt}/${maxRetries}):`, error);
            
            // å¦‚æœæ˜¯æœ€å¾Œä¸€æ¬¡å˜—è©¦ï¼Œæ‹‹å‡ºéŒ¯èª¤
            if (attempt === maxRetries) {
              throw error;
            }
            
            // å¦å‰‡ç­‰å¾…å¾Œé‡è©¦
            const delay = Math.pow(2, attempt - 1) * 1000;
            console.log(`ç­‰å¾… ${delay}ms å¾Œé‡è©¦...`);
            await new Promise(resolve => setTimeout(resolve, delay));
          }
        }
      }

      // çœŸå¯¦APIè¨»å†Šå‡½æ•¸ - å¸¶é‡è©¦æ©Ÿåˆ¶
      async function signupUser(username, email, password, maxRetries = 3) {
        for (let attempt = 1; attempt <= maxRetries; attempt++) {
          try {
            console.log(`è¨»å†Šå˜—è©¦ ${attempt}/${maxRetries}`);
            
            const response = await fetch('https://dae-mobile-assignment.hkit.cc/api/auth/signup', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                username: username,
                email: email,
                password: password
              })
            });

            const data = await response.json();
            
            // æª¢æŸ¥æ˜¯å¦æ˜¯æ¸¬è©¦éŒ¯èª¤ï¼ˆå¯ä»¥é‡è©¦ï¼‰
            if (data.error && data.error.includes('Error injected for testing purposes')) {
              console.log(`æ”¶åˆ°æ¸¬è©¦éŒ¯èª¤ï¼Œç¬¬ ${attempt} æ¬¡å˜—è©¦å¤±æ•—ï¼Œæº–å‚™é‡è©¦...`);
              if (attempt < maxRetries) {
                // æŒ‡æ•¸é€€é¿å»¶é²
                const delay = Math.pow(2, attempt - 1) * 1000;
                console.log(`ç­‰å¾… ${delay}ms å¾Œé‡è©¦...`);
                await new Promise(resolve => setTimeout(resolve, delay));
                continue;
              }
            }
            
            // æª¢æŸ¥å…¶ä»–éŒ¯èª¤
            if (!response.ok || data.error) {
              throw new Error(data.message || data.error || `è¨»å†Šå¤±æ•— (HTTP ${response.status})`);
            }

            console.log(`è¨»å†ŠæˆåŠŸï¼ç¬¬ ${attempt} æ¬¡å˜—è©¦`);
            return data;
            
          } catch (error) {
            console.error(`è¨»å†ŠAPIéŒ¯èª¤ (å˜—è©¦ ${attempt}/${maxRetries}):`, error);
            
            // å¦‚æœæ˜¯æœ€å¾Œä¸€æ¬¡å˜—è©¦ï¼Œæ‹‹å‡ºéŒ¯èª¤
            if (attempt === maxRetries) {
              throw error;
            }
            
            // å¦å‰‡ç­‰å¾…å¾Œé‡è©¦
            const delay = Math.pow(2, attempt - 1) * 1000;
            console.log(`ç­‰å¾… ${delay}ms å¾Œé‡è©¦...`);
            await new Promise(resolve => setTimeout(resolve, delay));
          }
        }
      }

      // æ¨¡æ“¬ç™»éŒ„APIï¼ˆç¨å¾Œæ›¿æ›ï¼‰
      async function simulateLogin(username, password) {
        return new Promise((resolve, reject) => {
          setTimeout(() => {
            // æ¨¡æ“¬APIéŸ¿æ‡‰ - æ¼”ç¤ºç”¨æˆ¶ï¼šdemo/demo123
            if (username === 'demo' && password === 'demo123') {
              const user = { 
                id: 1,
                username, 
                email: 'demo@example.com',
                name: 'Demo User',
                avatar: null,
                role: 'user'
              };
              resolve({ 
                success: true, 
                user: user,
                token: 'demo_token_' + Date.now()
              });
            } else if (username === 'admin' && password === 'admin123') {
              const user = { 
                id: 2,
                username, 
                email: 'admin@example.com',
                name: 'Admin User',
                avatar: null,
                role: 'admin'
              };
              resolve({ 
                success: true, 
                user: user,
                token: 'admin_token_' + Date.now()
              });
            } else {
              reject(new Error('ç”¨æˆ¶åæˆ–å¯†ç¢¼éŒ¯èª¤'));
            }
          }, CONFIG.LOGOUT_DELAY);
        });
      }
      
      // æ¨¡æ“¬è¨»å†ŠAPIï¼ˆç¨å¾Œæ›¿æ›ï¼‰
      async function simulateRegister(username, email, password) {
        return new Promise((resolve, reject) => {
          setTimeout(() => {
            // æ¨¡æ“¬è¨»å†Šé©—è­‰
            if (username === 'existing') {
              reject(new Error('ç”¨æˆ¶åå·²å­˜åœ¨'));
            } else if (email === 'existing@example.com') {
              reject(new Error('éƒµä»¶åœ°å€å·²è¢«è¨»å†Š'));
            } else {
              const user = {
                id: Date.now(), // ç°¡å–®çš„IDç”Ÿæˆ
                username,
                email,
                name: username,
                avatar: null,
                role: 'user',
                createdAt: new Date().toISOString()
              };
              resolve({ 
                success: true, 
                user: user,
                token: 'new_user_token_' + Date.now()
              });
            }
          }, CONFIG.BUTTON_FEEDBACK_DELAY);
        });
      }
      
      // ç”¨æˆ¶ä¿¡æ¯ç®¡ç†
      function updateUserProfile(updates) {
        if (currentUser) {
          currentUser = { ...currentUser, ...updates };
          localStorage.setItem(CONFIG.USER_STORAGE_KEY, JSON.stringify(currentUser));
          
          // æ›´æ–°æœƒè©±ä¸­çš„ç”¨æˆ¶ä¿¡æ¯
          const session = loadAuthSession();
          if (session) {
            session.user = currentUser;
            localStorage.setItem(CONFIG.AUTH_STORAGE_KEY, JSON.stringify(session));
          }
        }
      }
      
      function getUserDisplayName() {
        if (!currentUser) return 'è¨ªå®¢';
        return currentUser.name || currentUser.username || currentUser.email;
      }
      
      // æ›¸ç±¤ç®¡ç† - API æ”¶è—åŠŸèƒ½
      
      // æ·»åŠ æ”¶è— API èª¿ç”¨
      async function addBookmark(itemId, maxRetries = 3) {
        if (!currentUser) {
          throw new Error('è«‹å…ˆç™»éŒ„ä»¥ä½¿ç”¨æ”¶è—åŠŸèƒ½');
        }
        
        for (let attempt = 1; attempt <= maxRetries; attempt++) {
          try {
            console.log(`æ·»åŠ æ”¶è—å˜—è©¦ ${attempt}/${maxRetries} - Item ID: ${itemId}`);
            
            const session = loadAuthSession();
            const token = session ? session.token : null;
            
            const response = await fetch(`${CONFIG.API_BASE_URL}/bookmarks/${itemId}`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': token ? `Bearer ${token}` : ''
              },
              body: JSON.stringify({
                item_id: itemId
              })
            });

            const data = await response.json();
            
            // æª¢æŸ¥æ˜¯å¦æ˜¯æ¸¬è©¦éŒ¯èª¤ï¼ˆå¯ä»¥é‡è©¦ï¼‰
            if (data.error && data.error.includes('Error injected for testing purposes')) {
              console.log(`æ”¶åˆ°æ¸¬è©¦éŒ¯èª¤ï¼Œç¬¬ ${attempt} æ¬¡å˜—è©¦å¤±æ•—ï¼Œæº–å‚™é‡è©¦...`);
              if (attempt < maxRetries) {
                const delay = Math.pow(2, attempt - 1) * 1000;
                console.log(`ç­‰å¾… ${delay}ms å¾Œé‡è©¦...`);
                await new Promise(resolve => setTimeout(resolve, delay));
                continue;
              }
            }
            
            // æª¢æŸ¥å…¶ä»–éŒ¯èª¤
            if (!response.ok || data.error) {
              throw new Error(data.message || data.error || `æ·»åŠ æ”¶è—å¤±æ•— (HTTP ${response.status})`);
            }

            console.log(`æ”¶è—æ·»åŠ æˆåŠŸï¼ç¬¬ ${attempt} æ¬¡å˜—è©¦`);
            return data;
            
          } catch (error) {
            console.error(`æ·»åŠ æ”¶è—APIéŒ¯èª¤ (å˜—è©¦ ${attempt}/${maxRetries}):`, error);
            
            if (attempt === maxRetries) {
              throw error;
            }
            
            const delay = Math.pow(2, attempt - 1) * 1000;
            console.log(`ç­‰å¾… ${delay}ms å¾Œé‡è©¦...`);
            await new Promise(resolve => setTimeout(resolve, delay));
          }
        }
      }
      
      // ç§»é™¤æ”¶è— API èª¿ç”¨
      async function removeBookmark(itemId, maxRetries = 3) {
        if (!currentUser) {
          throw new Error('è«‹å…ˆç™»éŒ„ä»¥ä½¿ç”¨æ”¶è—åŠŸèƒ½');
        }
        
        for (let attempt = 1; attempt <= maxRetries; attempt++) {
          try {
            console.log(`ç§»é™¤æ”¶è—å˜—è©¦ ${attempt}/${maxRetries} - Item ID: ${itemId}`);
            
            const session = loadAuthSession();
            const token = session ? session.token : null;
            
            const response = await fetch(`${CONFIG.API_BASE_URL}/bookmarks/${itemId}`, {
              method: 'DELETE',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': token ? `Bearer ${token}` : ''
              }
            });

            const data = await response.json();
            
            // æª¢æŸ¥æ˜¯å¦æ˜¯æ¸¬è©¦éŒ¯èª¤ï¼ˆå¯ä»¥é‡è©¦ï¼‰
            if (data.error && data.error.includes('Error injected for testing purposes')) {
              console.log(`æ”¶åˆ°æ¸¬è©¦éŒ¯èª¤ï¼Œç¬¬ ${attempt} æ¬¡å˜—è©¦å¤±æ•—ï¼Œæº–å‚™é‡è©¦...`);
              if (attempt < maxRetries) {
                const delay = Math.pow(2, attempt - 1) * 1000;
                console.log(`ç­‰å¾… ${delay}ms å¾Œé‡è©¦...`);
                await new Promise(resolve => setTimeout(resolve, delay));
                continue;
              }
            }
            
            // æª¢æŸ¥å…¶ä»–éŒ¯èª¤
            if (!response.ok || data.error) {
              throw new Error(data.message || data.error || `ç§»é™¤æ”¶è—å¤±æ•— (HTTP ${response.status})`);
            }

            console.log(`æ”¶è—ç§»é™¤æˆåŠŸï¼ç¬¬ ${attempt} æ¬¡å˜—è©¦`);
            return data;
            
          } catch (error) {
            console.error(`ç§»é™¤æ”¶è—APIéŒ¯èª¤ (å˜—è©¦ ${attempt}/${maxRetries}):`, error);
            
            if (attempt === maxRetries) {
              throw error;
            }
            
            const delay = Math.pow(2, attempt - 1) * 1000;
            console.log(`ç­‰å¾… ${delay}ms å¾Œé‡è©¦...`);
            await new Promise(resolve => setTimeout(resolve, delay));
          }
        }
      }
      
      // ç²å–ç”¨æˆ¶æ”¶è—åˆ—è¡¨ API èª¿ç”¨
      async function fetchUserBookmarks(maxRetries = 3) {
        if (!currentUser) {
          console.log('ç”¨æˆ¶æœªç™»éŒ„ï¼Œç„¡æ³•ç²å–æ”¶è—åˆ—è¡¨');
          return [];
        }
        
        for (let attempt = 1; attempt <= maxRetries; attempt++) {
          try {
            console.log(`ç²å–æ”¶è—åˆ—è¡¨å˜—è©¦ ${attempt}/${maxRetries}`);
            
            const session = loadAuthSession();
            const token = session ? session.token : null;
            
            const response = await fetch(`${CONFIG.API_BASE_URL}/bookmarks`, {
              method: 'GET',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': token ? `Bearer ${token}` : ''
              }
            });

            const data = await response.json();
            
            // æª¢æŸ¥æ˜¯å¦æ˜¯æ¸¬è©¦éŒ¯èª¤ï¼ˆå¯ä»¥é‡è©¦ï¼‰
            if (data.error && data.error.includes('Error injected for testing purposes')) {
              console.log(`æ”¶åˆ°æ¸¬è©¦éŒ¯èª¤ï¼Œç¬¬ ${attempt} æ¬¡å˜—è©¦å¤±æ•—ï¼Œæº–å‚™é‡è©¦...`);
              if (attempt < maxRetries) {
                const delay = Math.pow(2, attempt - 1) * 1000;
                console.log(`ç­‰å¾… ${delay}ms å¾Œé‡è©¦...`);
                await new Promise(resolve => setTimeout(resolve, delay));
                continue;
              }
            }
            
            // æª¢æŸ¥å…¶ä»–éŒ¯èª¤
            if (!response.ok || data.error) {
              console.warn(`ç²å–æ”¶è—åˆ—è¡¨å¤±æ•—: ${data.message || data.error || `HTTP ${response.status}`}`);
              return []; // å¤±æ•—æ™‚è¿”å›ç©ºæ•¸çµ„
            }

            console.log(`æ”¶è—åˆ—è¡¨ç²å–æˆåŠŸï¼ç¬¬ ${attempt} æ¬¡å˜—è©¦`);
            return data.bookmarks || data || [];
            
          } catch (error) {
            console.error(`ç²å–æ”¶è—åˆ—è¡¨APIéŒ¯èª¤ (å˜—è©¦ ${attempt}/${maxRetries}):`, error);
            
            if (attempt === maxRetries) {
              console.warn('ç²å–æ”¶è—åˆ—è¡¨å¤±æ•—ï¼Œä½¿ç”¨æœ¬åœ°ç·©å­˜');
              return []; // æœ€çµ‚å¤±æ•—æ™‚è¿”å›ç©ºæ•¸çµ„
            }
            
            const delay = Math.pow(2, attempt - 1) * 1000;
            console.log(`ç­‰å¾… ${delay}ms å¾Œé‡è©¦...`);
            await new Promise(resolve => setTimeout(resolve, delay));
          }
        }
        
        return [];
      }
      
      // åˆå§‹åŒ–ç”¨æˆ¶æ•¸æ“šï¼ˆç™»éŒ„/è¨»å†ŠæˆåŠŸå¾Œèª¿ç”¨ï¼‰
      async function initializeUserData() {
        if (!currentUser) return;
        
        try {
          console.log('æ­£åœ¨åˆå§‹åŒ–ç”¨æˆ¶æ•¸æ“š...');
          
          // å…ˆåŠ è¼‰æœ¬åœ°æ”¶è—ä½œç‚ºå‚™ç”¨
          const localBookmarks = loadUserBookmarks();
          
          // å˜—è©¦å¾APIåŠ è¼‰æ”¶è—åˆ—è¡¨
          const apiBookmarks = await fetchUserBookmarks();
          
          if (apiBookmarks && apiBookmarks.length > 0) {
            console.log(`å¾APIåŠ è¼‰äº† ${apiBookmarks.length} å€‹æ”¶è—`);
            bookmarks = apiBookmarks;
            
            // å°‡APIæ•¸æ“šä¿å­˜åˆ°æœ¬åœ°ä½œç‚ºå‚™ä»½
            saveUserBookmarks(bookmarks);
          } else {
            console.log('APIæ²’æœ‰è¿”å›æ”¶è—æ•¸æ“šï¼Œä½¿ç”¨æœ¬åœ°æ”¶è—');
            bookmarks = localBookmarks;
          }
          
          // æ›´æ–°UI
          updateBookmarkUI();
          
        } catch (error) {
          console.error('åˆå§‹åŒ–ç”¨æˆ¶æ•¸æ“šå¤±æ•—:', error);
          
          // ä½¿ç”¨æœ¬åœ°æ”¶è—ä½œç‚ºå¾Œå‚™
          bookmarks = loadUserBookmarks();
          updateBookmarkUI();
        }
      }
      
      // æœ¬åœ°æ›¸ç±¤ç®¡ç†ï¼ˆä½œç‚ºAPIçš„å¾Œå‚™ï¼‰
      function loadUserBookmarks() {
        if (!currentUser) return [];
        
        try {
          const bookmarksData = localStorage.getItem(CONFIG.BOOKMARKS_KEY + '_' + currentUser.id);
          return bookmarksData ? JSON.parse(bookmarksData) : [];
        } catch (error) {
          console.error('è¼‰å…¥æ›¸ç±¤å¤±æ•—:', error);
          return [];
        }
      }
      
      function saveUserBookmarks(bookmarkList) {
        if (!currentUser) return;
        
        try {
          localStorage.setItem(CONFIG.BOOKMARKS_KEY + '_' + currentUser.id, JSON.stringify(bookmarkList));
          bookmarks = bookmarkList;
        } catch (error) {
          console.error('ä¿å­˜æ›¸ç±¤å¤±æ•—:', error);
        }
      }
      
      // æ”¶è—åˆ‡æ›åŠŸèƒ½ï¼ˆä½¿ç”¨çœŸå¯¦APIï¼‰
      async function toggleBookmark(itemId) {
        if (!currentUser) {
          showAuthError('è«‹å…ˆç™»éŒ„ä»¥ä½¿ç”¨æ”¶è—åŠŸèƒ½');
          return false;
        }
        
        const bookmarkIndex = bookmarks.findIndex(b => b.id === itemId);
        const isCurrentlyBookmarked = bookmarkIndex > -1;
        
        // æ›´æ–°UIç‹€æ…‹ï¼ˆæ¨‚è§€æ›´æ–°ï¼‰
        const bookmarkBtn = document.querySelector(`[data-item-id="${itemId}"] .bookmark-btn`);
        if (bookmarkBtn) {
          bookmarkBtn.disabled = true;
          bookmarkBtn.innerHTML = '<ion-spinner name="crescent"></ion-spinner>';
        }
        
        try {
          if (isCurrentlyBookmarked) {
            // ç§»é™¤æ”¶è—
            await removeBookmark(itemId);
            
            // å¾æœ¬åœ°åˆ—è¡¨ç§»é™¤
            bookmarks.splice(bookmarkIndex, 1);
            showSuccessMessage('å·²ç§»é™¤æ”¶è—');
          } else {
            // æ·»åŠ æ”¶è—
            await addBookmark(itemId);
            
            // æ·»åŠ åˆ°æœ¬åœ°åˆ—è¡¨
            const item = allItems.find(i => i.id === itemId);
            if (item) {
              bookmarks.push({
                id: itemId,
                title: item.name,
                addedAt: new Date().toISOString()
              });
            }
            showSuccessMessage('å·²åŠ å…¥æ”¶è—');
          }
          
          // ä¿å­˜åˆ°æœ¬åœ°å­˜å„²ï¼ˆä½œç‚ºå‚™ä»½ï¼‰
          saveUserBookmarks(bookmarks);
          updateBookmarkUI();
          return true;
          
        } catch (error) {
          console.error('æ”¶è—æ“ä½œå¤±æ•—:', error);
          showAuthError(`æ”¶è—æ“ä½œå¤±æ•—: ${error.message}`);
          
          // æ¢å¾©UIç‹€æ…‹
          updateBookmarkUI();
          return false;
        }
      }

      // UIæ›´æ–°å‡½æ•¸
      function updateUserUI() {
        const authBtn = document.getElementById('auth-btn');
        
        if (currentUser) {
          authBtn.textContent = `${getUserDisplayName()} â–¼`;
          authBtn.style.maxWidth = '150px';
          authBtn.style.overflow = 'hidden';
          authBtn.style.textOverflow = 'ellipsis';
          
          // é¡¯ç¤ºç”¨æˆ¶ç›¸é—œåŠŸèƒ½
          updateBookmarkUI();
        } else {
          authBtn.textContent = 'ç™»å…¥';
          authBtn.style.maxWidth = 'none';
          authBtn.style.overflow = 'visible';
          authBtn.style.textOverflow = 'unset';
          
          // ç™»å‡ºæ™‚ä¹Ÿè¦æ›´æ–°æ”¶è—æŒ‰éˆ•ç‹€æ…‹
          updateBookmarkUI();
        }
      }
      
      function updateBookmarkUI() {
        // æ›´æ–°æ‰€æœ‰æ”¶è—æŒ‰éˆ•ç‹€æ…‹
        const bookmarkBtns = document.querySelectorAll('.bookmark-btn');
        bookmarkBtns.forEach(btn => {
          const itemId = parseInt(btn.getAttribute('data-item-id'));
          const isBookmarked = bookmarks.some(b => b.id === itemId);
          
          // é‡ç½®æŒ‰éˆ•ç‹€æ…‹
          btn.disabled = false;
          
          if (isBookmarked) {
            // å·²æ”¶è—ç‹€æ…‹
            btn.setAttribute('fill', 'solid');
            btn.setAttribute('color', 'danger');
            btn.innerHTML = '<ion-icon name="heart" slot="start"></ion-icon>å·²æ”¶è—';
          } else {
            // æœªæ”¶è—ç‹€æ…‹
            btn.setAttribute('fill', 'clear');
            btn.setAttribute('color', 'medium');
            btn.innerHTML = '<ion-icon name="heart-outline" slot="start"></ion-icon>æ”¶è—';
          }
        });
        
        console.log(`æ›´æ–°äº† ${bookmarkBtns.length} å€‹æ”¶è—æŒ‰éˆ•ï¼Œç•¶å‰æ”¶è—æ•¸: ${bookmarks.length}`);
        
        // Step 23: å¦‚æœå•Ÿç”¨äº†æ”¶è—éæ¿¾ï¼Œé‡æ–°æ‡‰ç”¨éæ¿¾
        if (currentSearchParams.showBookmarkedOnly) {
          applyBookmarkFilter();
        }
      }
      
      function showSuccessMessage(message) {
        // å‰µå»ºæˆåŠŸæç¤º
        const toast = document.createElement('ion-toast');
        toast.message = message;
        toast.duration = 3000;
        toast.color = 'success';
        toast.position = 'top';
        
        document.body.appendChild(toast);
        toast.present();
        
        // è‡ªå‹•ç§»é™¤å…ƒç´ 
        setTimeout(() => {
          if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
          }
        }, CONFIG.TOAST_DISPLAY_DELAY);
      }
      
      function confirmLogout() {
        // æ¸…é™¤æœƒè©±
        clearAuthSession();
        
        // æ¸…ç©ºæ›¸ç±¤
        bookmarks = [];
        
        // æ›´æ–°UI
        updateUserUI();
        
        // é‡è¦ï¼šæ›´æ–°æ”¶è—æŒ‰éˆ•ç‹€æ…‹ï¼Œç§»é™¤æ‰€æœ‰æ”¶è—æ¨™ç¤º
        updateBookmarkUI();
        
        closeLogoutModal();
        
        // é¡¯ç¤ºç™»å‡ºæ¶ˆæ¯
        showSuccessMessage('å·²æˆåŠŸç™»å‡º');
      }
      
      // åˆå§‹åŒ–æ‡‰ç”¨
      document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM å·²åŠ è¼‰ï¼Œé–‹å§‹åˆå§‹åŒ–...');
        
        // æª¢æŸ¥ä¸¦è¼‰å…¥ç¾æœ‰æœƒè©±
        const existingSession = loadAuthSession();
        if (existingSession && isSessionValid()) {
          currentUser = existingSession.user;
          updateUserUI();
          console.log('å·²è¼‰å…¥ç¾æœ‰æœƒè©±:', currentUser);
          
          // ç•°æ­¥åˆå§‹åŒ–ç”¨æˆ¶æ•¸æ“š
          initializeUserData().catch(error => {
            console.error('åˆå§‹åŒ–ç”¨æˆ¶æ•¸æ“šå¤±æ•—:', error);
          });
        }
        
        // è¨­ç½®æœƒè©±è‡ªå‹•åˆ·æ–°ï¼ˆæ¯5åˆ†é˜ï¼‰
        setInterval(() => {
          if (currentUser && isSessionValid()) {
            refreshSession();
          }
        }, CONFIG.AUTO_LOGOUT_INTERVAL);
        
        // è¨­ç½®äº‹ä»¶ç›£è½å™¨ - Step 20: APIæœç´¢, Step 22: æ’åºåŠŸèƒ½
        document.getElementById('search-bar').addEventListener('ionInput', performAPISearch);
        document.getElementById('category-select').addEventListener('ionChange', performAPISearch);
        document.getElementById('sort-select').addEventListener('ionChange', performAPISearch);
        document.getElementById('order-select').addEventListener('ionChange', performAPISearch);
        document.getElementById('limit-select').addEventListener('ionChange', (e) => {
          itemsPerPage = parseInt(e.detail.value);
          loadData(); // é‡æ–°è¼‰å…¥æ•¸æ“š
        });
        
        document.getElementById('auth-btn').addEventListener('click', () => {
          if (currentUser) {
            document.getElementById('logout-confirm-modal').present();
          } else {
            openAuthModal();
          }
        });
        
        // è¨­ç½®èªè­‰è¡¨å–®äº‹ä»¶ç›£è½å™¨
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const switchToRegister = document.getElementById('switch-to-register');
        const switchToLogin = document.getElementById('switch-to-login');
        
        // è¡¨å–®æäº¤äº‹ä»¶
        if (loginForm) {
          loginForm.addEventListener('submit', handleLogin);
        }
        
        if (registerForm) {
          registerForm.addEventListener('submit', handleRegister);
        }
        
        // è¡¨å–®åˆ‡æ›äº‹ä»¶
        if (switchToRegister) {
          switchToRegister.addEventListener('click', () => switchAuthMode('register'));
        }
        
        if (switchToLogin) {
          switchToLogin.addEventListener('click', () => switchAuthMode('login'));
        }
        
        // è¨­ç½®è¼¸å…¥æ¡†èšç„¦æ•ˆæœ
        const allInputs = document.querySelectorAll('#auth-form-container ion-input');
        allInputs.forEach(input => {
          const item = input.closest('ion-item');
          
          // æ·»åŠ èšç„¦æ•ˆæœ
          input.addEventListener('ionFocus', () => {
            item.classList.add('item-has-focus');
            // æ¸…é™¤ä½”ä½ç¬¦ï¼ˆé€šéè¨­ç½®ç‚ºç©ºï¼‰
            const placeholder = input.getAttribute('placeholder');
            if (placeholder) {
              input.setAttribute('data-original-placeholder', placeholder);
              input.setAttribute('placeholder', '');
            }
          });
          
          // ç§»é™¤èšç„¦æ•ˆæœ
          input.addEventListener('ionBlur', () => {
            item.classList.remove('item-has-focus');
            // å¦‚æœè¼¸å…¥æ¡†ç‚ºç©ºï¼Œæ¢å¾©ä½”ä½ç¬¦
            const value = input.value?.trim();
            if (!value) {
              const originalPlaceholder = input.getAttribute('data-original-placeholder');
              if (originalPlaceholder) {
                input.setAttribute('placeholder', originalPlaceholder);
              }
            }
          });
        });
        
        // å¯¦æ™‚é©—è­‰äº‹ä»¶
        const loginUsername = document.getElementById('login-username');
        if (loginUsername) {
          loginUsername.addEventListener('ionBlur', () => {
            const value = loginUsername.value.trim();
            if (value && value.length < 3) {
              showFieldError('login-username', 'ç”¨æˆ¶åè‡³å°‘3å€‹å­—ç¬¦');
            } else {
              hideFieldError('login-username');
            }
          });
        }
        
        const registerEmail = document.getElementById('register-email');
        if (registerEmail) {
          registerEmail.addEventListener('ionBlur', () => {
            const value = registerEmail.value.trim();
            if (value && !validateEmail(value)) {
              showFieldError('register-email', 'è«‹è¼¸å…¥æœ‰æ•ˆçš„é›»å­éƒµä»¶åœ°å€');
            } else {
              hideFieldError('register-email');
            }
          });
        }
        
        const registerPassword = document.getElementById('register-password');
        if (registerPassword) {
          registerPassword.addEventListener('ionInput', () => {
            const value = registerPassword.value;
            
            // Step 25: å¯¦æ™‚å¯†ç¢¼å¼·åº¦æª¢æŸ¥
            updatePasswordStrength(value);
            
            if (value) {
              const strength = getPasswordStrength(value);
              if (!strength.isValid) {
                showFieldError('register-password', 'å¯†ç¢¼éœ€è‡³å°‘8ä½ï¼ŒåŒ…å«å¤§å¯«ã€å°å¯«å­—æ¯å’Œæ•¸å­—');
              } else {
                hideFieldError('register-password');
              }
            }
          });
        }
        
        // Step 24: å•Ÿç”¨ç„¡é™æ»¾å‹•
        setupInfiniteScroll();
        
        // é–‹å§‹è¼‰å…¥æ•¸æ“š
        loadData();
      });
    </script>
  </body>
</html>